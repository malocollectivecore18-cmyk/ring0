<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>RING-0 | Time Progress</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0f1220;
  --card:#171a2e;
  --accent:#5b8cff;
  --text:#e8eaf6;
  --muted:#9aa0c6;
  --success:#35d07f;
  --warning:#ff6b6b;
}
*{box-sizing:border-box; margin:0; padding:0;}

header{
  margin-bottom: 10px;
}

body{
  font-family:Inter,system-ui,Arial;
  background:linear-gradient(120deg,#0f1220,#0b0e1a);
  color:var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
}

/* ===== HEADER ===== */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px 20px;
  background: linear-gradient(270deg, #0f1220, #0b0e1a, #1b1f3d, #0f1220);
  background-size: 800% 800%;
  animation: gradientBG 15s ease infinite;
  position: sticky;
  top: 0;
  z-index: 1000;
  border-bottom: 1px solid rgba(255,255,255,.1);
  width: 100%;
}
@keyframes gradientBG{
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}

.header-container {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 5px;
  flex: 1;
}

.brand-container {
  display: flex;
  align-items: center;
  gap: 15px;
}

.brand{
  font-size:1.6rem;
  font-weight:800;
  color:#fff;
  white-space: nowrap;
  cursor: pointer;
  user-select: none;
}

.brand .zero {
  color: #fff;
  display: inline-block;
}

/* V-SHAPE BUTTON */
.toggle-slider-btn {
  background: none;
  border: none;
  color: var(--text);
  cursor: pointer;
  padding: 2px 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  width: 100%;
  max-width: 40px;
  margin-left: 5px;
}

.toggle-slider-btn .v-icon {
  position: relative;
  width: 24px;
  height: 24px;
  transition: transform 0.3s ease;
}

.toggle-slider-btn .v-icon::before,
.toggle-slider-btn .v-icon::after {
  content: '';
  position: absolute;
  top: 25%;
  width: 12px;
  height: 2px;
  background-color: var(--text);
  border-radius: 2px;
  transition: all 0.3s ease;
}

.toggle-slider-btn.down .v-icon::before {
  left: 0;
  transform: rotate(45deg);
  transform-origin: top left;
}

.toggle-slider-btn.down .v-icon::after {
  right: 0;
  transform: rotate(-45deg);
  transform-origin: top right;
}

.toggle-slider-btn.up .v-icon::before {
  left: 0;
  transform: rotate(-45deg);
  transform-origin: bottom left;
}

.toggle-slider-btn.up .v-icon::after {
  right: 0;
  transform: rotate(45deg);
  transform-origin: bottom right;
}

.toggle-slider-btn:hover .v-icon::before,
.toggle-slider-btn:hover .v-icon::after {
  background-color: var(--accent);
}

.toggle-slider-btn:hover {
  transform: translateY(2px);
}

.menu-btn{
  font-size:1.6rem;
  cursor:pointer;
  flex-shrink: 0;
}
nav{
  position:absolute;
  top:60px;
  right:20px;
  background:#0c1024;
  border-radius:12px;
  padding:10px;
  display:none;
  flex-direction:column;
  gap:8px;
  min-width: 138px;
  z-index: 1001;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
nav button{
  background:none;
  border:1px solid #1b1f3d;
  color:#fff;
  padding:6px 14px;
  border-radius:20px;
  cursor:pointer;
  width: 100%;
  text-align: left;
  white-space: nowrap;
  transition: all 0.3s ease;
}
nav button:hover{background:#1b1f3d}

/* Hidden admin login option */
nav button.admin-login {
  display: none;
  background: rgba(91, 140, 255, 0.1);
  border-color: rgba(91, 140, 255, 0.3);
  color: var(--accent);
}

nav button.admin-login.visible {
  display: block;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ===== IMAGE SLIDER CONTAINER ===== */
.image-slider-container {
  position: fixed;
  top: 70px;
  left: -100%;
  width: 100%;
  height: 50%;
  background: rgba(12, 16, 36, 0.95);
  backdrop-filter: blur(10px);
  padding: 20px;
  z-index: 999;
  transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  max-height: calc(100vh - 70px);
  overflow-y: auto;
}

.image-slider-container.open {
  left: 0;
}

.slider-content {
  max-width: 1200px;
  margin: 0 auto;
  position: relative;
  padding-top: 40px;
}

.slider-title {
  text-align: center;
  font-size: 1.4rem;
  margin-bottom: 5px;
  color: var(--accent);
  font-weight: 600;
}

.slider-subtitle {
  text-align: center;
  font-size: 0.9rem;
  color: var(--muted);
  margin-bottom: 15px;
}

.image-slider {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 30px;
  min-height: 400px;
}

.slider-image {
  max-width: 800px;
  max-height: 450px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
  object-fit: contain;
  background: rgba(0, 0, 0, 0.3);
  padding: 10px;
  padding-top: 0px;
  transition: transform 0.3s ease;
}

.slider-image:hover {
  transform: scale(1.02);
}

.slider-nav {
  background: rgba(23, 26, 46, 0.8);
  border: 1px solid rgba(91, 140, 255, 0.3);
  color: var(--text);
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.4rem;
  cursor: pointer;
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.slider-nav:hover {
  background: var(--accent);
  transform: scale(1.1);
}

.slider-nav.prev {
  order: 1;
}

.slider-image-container {
  order: 2;
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
}

.slider-nav.next {
  order: 3;
}

.slider-indicator {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 20px;
}

.indicator-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: rgba(155, 160, 198, 0.3);
  cursor: pointer;
  transition: all 0.3s ease;
}

.indicator-dot.active {
  background: var(--accent);
  transform: scale(1.2);
}

/* ===== IMAGE MANAGEMENT STYLES ===== */
.admin-images-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.image-card {
  background: radial-gradient(120% 120% at 0% 0%, #1b1f3d, var(--card));
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.image-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
  border-color: var(--accent);
}

.image-card img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 10px;
}

.image-card h4 {
  color: var(--accent);
  margin-bottom: 8px;
  font-size: 1rem;
  word-break: break-word;
}

.image-card p {
  color: var(--muted);
  font-size: 0.85rem;
  line-height: 1.4;
  margin-bottom: 10px;
  max-height: 60px;
  overflow: hidden;
}

.image-card-category {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  margin-bottom: 8px;
}

.category-critical {
  background: rgba(255, 107, 107, 0.15);
  color: var(--warning);
  border: 1px solid rgba(255, 107, 107, 0.3);
}

.category-important {
  background: rgba(91, 140, 255, 0.15);
  color: var(--accent);
  border: 1px solid rgba(91, 140, 255, 0.3);
}

.category-entertainment {
  background: rgba(53, 208, 127, 0.15);
  color: var(--success);
  border: 1px solid rgba(53, 208, 127, 0.3);
}

.category-additional {
  background: rgba(155, 160, 198, 0.15);
  color: var(--muted);
  border: 1px solid rgba(155, 160, 198, 0.3);
}

.image-card-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.image-card-btn {
  flex: 1;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}

.image-card-btn.edit {
  background: rgba(91, 140, 255, 0.1);
  color: var(--accent);
  border: 1px solid rgba(91, 140, 255, 0.3);
}

.image-card-btn.edit:hover {
  background: rgba(91, 140, 255, 0.2);
}

.image-card-btn.delete {
  background: rgba(255, 107, 107, 0.1);
  color: var(--warning);
  border: 1px solid rgba(255, 107, 107, 0.3);
}

.image-card-btn.delete:hover {
  background: rgba(255, 107, 107, 0.2);
}

.image-card-btn.cancel {
  background: rgba(155, 160, 198, 0.1);
  color: var(--text);
  border: 1px solid rgba(155, 160, 198, 0.3);
}

.image-card-btn.cancel:hover {
  background: rgba(155, 160, 198, 0.2);
}

/* Filter and counter in slider */
.slider-counter {
  position: absolute;
  bottom: 35px;
  left: 50px;
  background: rgba(12, 16, 36, 0.8);
  color: var(--text);
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 0.9rem;
  z-index: 100;
}

/* when counter is placed inside nav buttons, make it inline */
.slider-nav-buttons {
  display: flex;
  align-items: center;
  gap: 5px;
}
.slider-nav-buttons .slider-counter {
  position: static;
  bottom: auto;
  left: auto;
  margin: 0 8px;
  background: rgba(12, 16, 36, 0.9);
  color: var(--text);
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 0.9rem;
  z-index: auto;
  align-self: center;
}

.filter-icon {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(12, 16, 36, 0.8);
  border:none;
  color: var(--accent);
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  z-index: 100;
  display: flex;
  align-items: center;
  gap: 5px;
}

.slider-filter-panel {
  position: absolute;
  top: 39px;
  right: 10px;
  background: #0c1024;
  border: 1px solid rgba(27, 31, 61, 0.6);
  border-radius: 6px;
  padding: 2px;
  z-index: 101;
  display: none;
  min-width: 110px;
  max-width: 160px;
  backdrop-filter: none;
  box-shadow: 0 6px 12px rgba(0,0,0,0.28);
}

.slider-filter-panel.show {
  display: flex;
  flex-direction: column;
  gap: 4px;
  animation: fadeInUp 0.12s ease;
}

.filter-options {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.filter-option {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  padding: 2px 4px;
  border-radius: 6px;
  transition: background 0.12s ease;
  white-space: nowrap;
  font-size: 0.78rem;
  color: var(--text);
}

.filter-option:hover {
  background: rgba(91, 140, 255, 0.06);
}

.filter-option input {
  margin: 0;
  transform: scale(0.95);
}

.slider-filter-panel .filter-option span {
  font-size: 0.88rem;
  color: var(--muted);
}

/* Color options for slider background */
.color-options {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 10px;
  margin-top: 10px;
}

.color-option {
  height: 40px;
  border: 2px solid transparent;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.color-option:hover {
  transform: scale(1.05);
}

/* ===== MAIN CONTENT ===== */
main{
  flex: 1;
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 15px;
  display:flex;
  flex-direction:column;
  gap:16px;
  overflow: hidden;
  transition: margin-top 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

main.slider-open {
  margin-top: 400px;
}

/* ===== CARD ===== */
.card{
  background:radial-gradient(120% 120% at 0% 0%, #1b1f3d, var(--card));
  border-radius:16px;
  padding:16px 18px;
  box-shadow:0 20px 40px rgba(0,0,0,.35);
  display:flex;
  flex-direction:column;
  gap:10px;
  position:relative;
  width: 100%;
  overflow: hidden;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 25px 50px rgba(0,0,0,.45);
}

.card h3{
  margin:0;
  font-size:1.05rem;
  line-height: 1.3;
  word-break: break-word;
}
.meta{
  border: 0.3px dashed rgba(200, 200, 200, 0.5);
  font-size:.82rem;
  color:var(--muted);
  margin-bottom: 2px;
  line-height: 1.4;
  padding: 5px 8px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.meta:hover {
  background: rgba(91, 140, 255, 0.1);
  border-color: rgba(91, 140, 255, 0.5);
  color: var(--accent);
}

/* ===== COUNTDOWN CONTAINER ===== */
.countdown-container {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 5px;
  margin-bottom: -2px;
}

.countdown{
  display:flex;
  gap:4px;
  justify-content: flex-end;
  flex-wrap: wrap;
}

/* ===== PILL STYLES ===== */
.pill{
  background:#0c1024;
  border-radius:6px;
  padding:2px 5px;
  min-width:46px;
  text-align:center;
  font-size:0.70rem;
  line-height: 1.2;
  flex-shrink: 0;
}
.pill b{
  display:block;
  font-size:0.85rem;
  font-weight: 600;
  line-height: 1.2;
}

/* ===== FUTURISTIC SPINNER ===== */
.spinner{
  position:absolute;
  top:15px;
  right:15px;
  width:27px;
  height:27px;
  flex-shrink: 0;
}

.spinner .ring{
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
  border-radius:50%;
  border:2px solid transparent;
  border-top-color:#ff2bdc;
  border-right-color:#00e5ff;
  border-bottom-color:#ff3b3b;
  filter:drop-shadow(0 0 6px #ff2bdc) drop-shadow(0 0 6px #00e5ff) drop-shadow(0 0 6px #ff3b3b);
  animation:spin 1.5s linear infinite;
}
.spinner .ring:nth-child(2){
  border-top-color:#00e5ff;
  border-left-color:#ff2bdc;
  filter:drop-shadow(0 0 4px #00e5ff) drop-shadow(0 0 4px #ff2bdc);
  animation:spin 2s linear reverse infinite;
}
.spinner .ring:nth-child(3){
  border-top-color:#ff3b3b;
  border-left-color:#00e5ff;
  filter:drop-shadow(0 0 3px #ff3b3b) drop-shadow(0 0 3px #00e5ff);
  animation:spin 1s linear infinite;
  inset:1.5px;
}

@keyframes spin{
  from{transform:rotate(0deg)}
  to{transform:rotate(360deg)}
}

/* ===== ENHANCED PROGRESS BAR ===== */
.progress{
  height:9px;
  background:#0c1024;
  border-radius:999px;
  overflow:hidden;
  margin-top: 1px;
  width: 100%;
  position: relative;
}

.bar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--accent),var(--success));
  transition:width .6s ease;
  position: relative;
  overflow: hidden;
}

.bar::before {
  content: attr(data-percent);
  position: absolute;
  right: 5px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 9px;
  font-weight: bold;
  color: rgba(255, 255, 255, 0.8);
  text-shadow: 0 0 2px rgba(0, 0, 0, 0.8);
  z-index: 2;
}

.bar.active::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 50%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.4),
    transparent
  );
  animation: luminating 2s infinite ease-in-out;
}

.bar.critical {
  background: linear-gradient(90deg, #ff4444, #ff6b6b);
}

.bar.critical.active::after {
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.5),
    transparent
  );
}

@keyframes luminating {
  0% {
    left: -100%;
  }
  100% {
    left: 200%;
  }
}

/* ===== UPDATED CARD FOOTER ===== */
.card-footer{
  display:flex;
  justify-content:space-between;
  align-items: center;
  font-size:.82rem;
  color:var(--muted);
  width: 100%;
  margin-top: 1px;
  flex-wrap: wrap;
  gap: 8px;
}

.badge-container {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.badge{
  background:#0c1024;
  padding:2px 8px;
  border-radius:999px;
  font-size: 0.70rem;
  line-height: 1.3;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.badge.started {
  background: rgba(53, 208, 127, 0.1);
  color: var(--success);
  border: 1px solid rgba(53, 208, 127, 0.3);
}

.badge.ends {
  background: rgba(91, 140, 255, 0.1);
  color: var(--accent);
  border: 1px solid rgba(91, 140, 255, 0.3);
  margin-left: auto;
}

.status{
  white-space: nowrap;
  flex-shrink: 0;
}

/* ===== ADMIN MODAL/POPUP ===== */
.admin-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 3000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.5s ease;
}

.admin-modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.admin-modal-content {
  background: radial-gradient(120% 120% at 0% 0%, #1b1f3d, var(--card));
  border-radius: 20px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 30px 60px rgba(0, 0, 0, 0.7);
  transform: scale(0.9) translateY(20px);
  transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid rgba(91, 140, 255, 0.3);
  position: relative;
  overflow: hidden;
}

.admin-modal-overlay.active .admin-modal-content {
  transform: scale(1) translateY(0);
}

.admin-modal-title {
  font-size: 1.8rem;
  color: var(--accent);
  margin-bottom: 20px;
  text-align: center;
  font-weight: 700;
}

.admin-modal-subtitle {
  font-size: 1rem;
  color: var(--muted);
  margin-bottom: 30px;
  text-align: center;
  line-height: 1.5;
}

.admin-form-group {
  margin-bottom: 20px;
}

.admin-form-label {
  display: block;
  font-size: 0.9rem;
  color: var(--text);
  margin-bottom: 8px;
  font-weight: 600;
}

.admin-form-input {
  width: 100%;
  padding: 12px 15px;
  background: rgba(12, 16, 36, 0.8);
  border: 1px solid rgba(91, 140, 255, 0.3);
  border-radius: 10px;
  color: var(--text);
  font-size: 1rem;
  transition: all 0.3s ease;
}

.admin-form-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(91, 140, 255, 0.2);
}

.admin-form-input.error {
  border-color: var(--warning);
  background: rgba(255, 107, 107, 0.1);
}

.admin-error-message {
  color: var(--warning);
  font-size: 0.85rem;
  margin-top: 5px;
  display: none;
}

.admin-error-message.show {
  display: block;
  animation: shake 0.5s ease;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.admin-modal-step {
  display: none;
}

.admin-modal-step.active {
  display: block;
  animation: fadeInUp 0.5s ease;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.admin-modal-buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 30px;
}

.admin-modal-btn {
  padding: 1px 5px;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
  min-width: 120px;
}

.admin-modal-btn.primary {
  background: linear-gradient(90deg, var(--accent), #4a7dff);
  color: white;
}

.admin-modal-btn.primary:hover:not(:disabled) {
  background: linear-gradient(90deg, #4a7dff, var(--accent));
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(91, 140, 255, 0.4);
}

.admin-modal-btn.secondary {
  background: rgba(155, 160, 198, 0.1);
  color: var(--text);
  border: 1px solid rgba(155, 160, 198, 0.3);
}

.admin-modal-btn.secondary:hover {
  background: rgba(155, 160, 198, 0.2);
  transform: translateY(-2px);
}

.admin-modal-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.admin-success-message {
  text-align: center;
  color: var(--success);
  font-size: 1.1rem;
  margin-top: 20px;
  display: none;
}

.admin-success-message.show {
  display: block;
  animation: fadeIn 0.5s ease;
}

/* ===== MODAL/POPUP ===== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal-content {
  background: radial-gradient(120% 120% at 0% 0%, #1b1f3d, var(--card));
  border-radius: 16px;
  padding: 25px;
  max-width: 450px;
  width: 90%;
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
  transform: translateY(20px);
  transition: transform 0.3s ease;
  border: 1px solid rgba(91, 140, 255, 0.2);
}

.modal-overlay.active .modal-content {
  transform: translateY(0);
}

.modal-title {
  font-size: 1.3rem;
  color: var(--accent);
  margin-bottom: 15px;
  text-align: center;
  font-weight: 600;
}

.modal-text {
  font-size: 0.95rem;
  color: var(--text);
  line-height: 1.5;
  margin-bottom: 25px;
  text-align: center;
}

.modal-buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
}

.modal-btn {
  padding: 10px 25px;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
  min-width: 100px;
}

.modal-btn.yes {
  background: linear-gradient(90deg, var(--accent), #4a7dff);
  color: white;
}

.modal-btn.yes:hover {
  background: linear-gradient(90deg, #4a7dff, var(--accent));
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(91, 140, 255, 0.3);
}

.modal-btn.cancel {
  background: rgba(155, 160, 198, 0.1);
  color: var(--text);
  border: 1px solid rgba(155, 160, 198, 0.3);
}

.modal-btn.cancel:hover {
  background: rgba(155, 160, 198, 0.2);
  transform: translateY(-2px);
}

/* ===== ADMIN DASHBOARD ===== */
.admin-dashboard-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(10px);
  z-index: 4000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.5s ease;
  overflow-y: auto;
}

.admin-dashboard-overlay.active {
  opacity: 1;
  visibility: visible;
}

.admin-dashboard {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  min-height: 100vh;
}

.admin-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  margin-bottom: 6px;
}

.admin-header-title {
  font-size: 1.5rem;
  color: var(--accent);
  font-weight: 800;
}

.admin-logout-btn {
  background: rgba(255, 107, 107, 0.1);
  color: var(--warning);
  border: 1px solid rgba(255, 107, 107, 0.3);
  padding: 10px 20px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.admin-logout-btn:hover {
  background: rgba(255, 107, 107, 0.2);
  transform: translateY(-2px);
}

/* ===== ADMIN CARD MANAGEMENT ===== */
.admin-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 30px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  padding-bottom: 10px;
}

.admin-tab {
  background: transparent;
  border: none;
  color: var(--muted);
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.admin-tab.active {
  background: rgba(91, 140, 255, 0.1);
  color: var(--accent);
  border-bottom: 2px solid var(--accent);
}

.admin-tab:hover:not(.active) {
  background: rgba(155, 160, 198, 0.1);
}

.admin-tab-content {
  display: none;
}

.admin-tab-content.active {
  display: block;
  animation: fadeInUp 0.5s ease;
}


.card-form-container {
  background: radial-gradient(120% 120% at 0% 0%, #020203, var(--card));
  border-radius: 16px;
  padding: 25px 10px;
  margin-bottom: 30px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
}

.left-label{
  padding-left: 5px;
  min-width: 46px;
  display: flex;
  align-items: flex-end;
  justify-content:flex-start;
  font-size: calc(0.70rem + 4px);
  line-height: 1.2;
  flex-shrink: 0;
}

.card-form-title {
  color: var(--accent);
  margin-bottom: 0px;
  font-size: 1.3rem;
  font-weight: 600;
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 3px;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-size: 0.7rem;
  color: var(--text);
  margin-bottom: 8px;
  font-weight: 600;
}

.form-input, .form-textarea, .form-select {
  width: 100%;
  padding: 8px 15px;
  background: rgba(12, 16, 36, 0.8);
  border: 1px solid rgba(91, 140, 255, 0.3);
  border-radius: 10px;
  color: var(--text);
  font-size: 0.87rem;
  transition: all 0.3s ease;
}

.form-input:focus, .form-textarea:focus, .form-select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(91, 140, 255, 0.2);
}

.form-textarea {
  min-height: 100px;
  resize: vertical;
}

.time-inputs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.form-buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 25px;
}

.form-btn {
  padding: 2px 3px;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
  min-width: 120px;
  margin-top: -10px;
}

.form-btn.primary {
  background: linear-gradient(90deg, var(--accent), #4a7dff);
  color: white;
}

.form-btn.primary:hover {
  background: linear-gradient(90deg, #4a7dff, var(--accent));
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(91, 140, 255, 0.4);
}

.form-btn.secondary {
  background: rgba(155, 160, 198, 0.1);
  color: var(--text);
  border: 1px solid rgba(155, 160, 198, 0.3);
}

.form-btn.secondary:hover {
  background: rgba(155, 160, 198, 0.2);
  transform: translateY(-2px);
}

.framework-buttons .form-btn {
  padding: 8px 16px;
  min-width: 100px;
  font-size: 0.9rem;
}

/* ===== SIMPLE DATETIME INPUTS ===== */
.datetime-simple-group {
  position: relative;
}

.datetime-simple-input {
  padding: 12px 15px;
  font-size: 1rem;
  font-family: 'Inter', sans-serif;
}

.datetime-simple-input::-webkit-calendar-picker-indicator {
  background-color: var(--accent);
  padding: 5px;
  border-radius: 6px;
  cursor: pointer;
  filter: brightness(0.9);
  margin-left: 5px;
}

.datetime-simple-input::-webkit-calendar-picker-indicator:hover {
  filter: brightness(1.1);
}

.datetime-hint {
  margin-top: 8px;
  font-size: 0.8rem;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 5px;
}

.datetime-hint code {
  background: rgba(91, 140, 255, 0.1);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  color: var(--accent);
}

.quick-suggestions {
  background: rgba(12, 16, 36, 0.3);
  border-radius: 10px;
  padding: 15px;
  margin: 20px 0;
  border: 1px solid rgba(91, 140, 255, 0.1);
}

.suggestion-title {
  color: var(--accent);
  font-size: 0.9rem;
  margin-bottom: 10px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.suggestion-title::before {
  content: 'ðŸ’¡';
  font-size: 1rem;
}

.suggestion-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.suggestion-btn {
  background: rgba(91, 140, 255, 0.1);
  color: var(--accent);
  border: 1px solid rgba(91, 140, 255, 0.3);
  border-radius: 8px;
  padding: 8px 15px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.suggestion-btn:hover {
  background: rgba(91, 140, 255, 0.2);
  transform: translateY(-2px);
}

/* Admin Cards Container */
.admin-cards-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
  gap: 25px;
  margin-top: 20px;
}

.empty-state {
  grid-column: 1 / -1;
  background: rgba(12, 16, 36, 0.3);
  border-radius: 16px;
  padding: 40px;
  text-align: center;
  border: 2px dashed rgba(155, 160, 198, 0.3);
}

.empty-state h3 {
  color: var(--accent);
  margin-bottom: 10px;
  font-size: 1.3rem;
}

.empty-state p {
  color: var(--muted);
  font-size: 0.95rem;
  line-height: 1.5;
  max-width: 500px;
  margin: 0 auto 20px;
}

/* ===== ENHANCED ADMIN CARD LAYOUT ===== */
.admin-card {
  background: radial-gradient(120% 120% at 0% 0%, #1b1f3d, var(--card));
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
  position: relative;
  border: 2px solid transparent;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  gap: 15px;
  height: 100%;
}

.admin-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.45);
  border-color: var(--accent);
}

.admin-card.cancelled {
  border-color: var(--warning);
  opacity: 0.7;
}

.admin-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 15px;
}

.admin-card-title-section {
  flex: 1;
  min-width: 0;
}

.admin-card h4 {
  color: var(--accent);
  margin-bottom: 5px;
  font-size: 1.1rem;
  line-height: 1.3;
  word-break: break-word;
}

.admin-card-meta {
  font-size: 0.85rem;
  color: var(--muted);
  line-height: 1.4;
  margin-bottom: 0;
  padding: 8px 10px;
  background: rgba(12, 16, 36, 0.5);
  border-radius: 8px;
  border-left: 3px solid var(--accent);
}

.admin-card-status {
  padding: 6px 12px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  white-space: nowrap;
}

.status-active {
  background: rgba(53, 208, 127, 0.15);
  color: var(--success);
  border: 1px solid rgba(53, 208, 127, 0.3);
}

.status-cancelled {
  background: rgba(255, 107, 107, 0.15);
  color: var(--warning);
  border: 1px solid rgba(255, 107, 107, 0.3);
}

.admin-card-time-info {
  background: rgba(12, 16, 36, 0.7);
  border-radius: 12px;
  padding: 15px;
  margin: 5px 0;
}

.time-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.time-row:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}

.time-label {
  font-size: 0.8rem;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 6px;
}

.time-label::before {
  content: 'ðŸ•’';
  font-size: 0.9rem;
}

.time-value {
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text);
  font-family: 'Courier New', monospace;
  background: rgba(0, 0, 0, 0.3);
  padding: 4px 8px;
  border-radius: 6px;
}

.admin-card-url-section {
  background: rgba(12, 16, 36, 0.5);
  border-radius: 10px;
  padding: 12px 15px;
  margin: 5px 0;
}

.url-label {
  font-size: 0.8rem;
  color: var(--muted);
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.url-label::before {
  content: 'ðŸ”—';
  font-size: 0.9rem;
}

.url-value {
  font-size: 0.85rem;
  color: var(--accent);
  word-break: break-all;
  display: block;
  padding: 8px;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 6px;
  border-left: 3px solid var(--accent);
  transition: all 0.3s ease;
}

.url-value:hover {
  background: rgba(91, 140, 255, 0.1);
  transform: translateX(2px);
}

.admin-card-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: auto;
  padding-top: 15px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.admin-card-btn {
  padding: 10px 15px;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.admin-card-btn.edit {
  background: rgba(91, 140, 255, 0.1);
  color: var(--accent);
  border: 1px solid rgba(91, 140, 255, 0.3);
}

.admin-card-btn.edit:hover {
  background: rgba(91, 140, 255, 0.2);
  transform: translateY(-2px);
}

.admin-card-btn.cancel {
  background: rgba(255, 107, 107, 0.1);
  color: var(--warning);
  border: 1px solid rgba(255, 107, 107, 0.3);
}

.admin-card-btn.cancel:hover {
  background: rgba(255, 107, 107, 0.2);
  transform: translateY(-2px);
}

.admin-card-btn.delete {
  background: rgba(255, 107, 107, 0.1);
  color: var(--warning);
  border: 1px solid rgba(255, 107, 107, 0.3);
}

.admin-card-btn.delete:hover {
  background: rgba(255, 107, 107, 0.2);
  transform: translateY(-2px);
}

.admin-card-btn.restore {
  background: rgba(53, 208, 127, 0.1);
  color: var(--success);
  border: 1px solid rgba(53, 208, 127, 0.3);
}

.admin-card-btn.restore:hover {
  background: rgba(53, 208, 127, 0.2);
  transform: translateY(-2px);
}

/* ===== ADMIN DASHBOARD MENU ===== */
.admin-dashboard-menu {
  animation: fadeInUp 0.5s ease;
}

.admin-dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 25px;
  margin-bottom: 40px;
}

.menu-card {
  background: radial-gradient(120% 120% at 0% 0%, #1b1f3d, var(--card));
  border-radius: 16px;
  padding: 30px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
  border: 2px solid transparent;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 200px;
}

.menu-card:hover {
  transform: translateY(-10px);
  box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
  border-color: var(--accent);
}

.menu-card-icon {
  font-size: 3rem;
  margin-bottom: 15px;
  transition: transform 0.3s ease;
}

.menu-card:hover .menu-card-icon {
  transform: scale(1.2);
}

.menu-card h3 {
  color: var(--accent);
  margin-bottom: 10px;
  font-size: 1.3rem;
}

.menu-card p {
  color: var(--muted);
  font-size: 0.9rem;
  line-height: 1.5;
}

/* Management Sections */
.admin-management-section {
  animation: fadeInUp 0.5s ease;
}

.back-to-menu {
  margin-bottom: 30px;
}

/* Delete confirmation modal */
.delete-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 5000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.delete-modal.active {
  opacity: 1;
  visibility: visible;
}

.delete-modal-content {
  background: radial-gradient(120% 120% at 0% 0%, #1b1f3d, var(--card));
  border-radius: 20px;
  padding: 30px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 30px 60px rgba(0, 0, 0, 0.7);
  transform: translateY(20px);
  transition: transform 0.3s ease;
  border: 1px solid rgba(255, 107, 107, 0.3);
}

.delete-modal.active .delete-modal-content {
  transform: translateY(0);
}

.delete-modal-title {
  font-size: 1.5rem;
  color: var(--warning);
  margin-bottom: 15px;
  text-align: center;
  font-weight: 600;
}

.delete-modal-text {
  font-size: 1rem;
  color: var(--text);
  line-height: 1.5;
  margin-bottom: 25px;
  text-align: center;
}

.delete-modal-buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
}

.delete-modal-btn {
  padding: 12px 25px;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
  min-width: 100px;
}

.delete-modal-btn.yes {
  background: linear-gradient(90deg, #ff4444, #ff6b6b);
  color: white;
}

.delete-modal-btn.yes:hover {
  background: linear-gradient(90deg, #ff6b6b, #ff4444);
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
}

.delete-modal-btn.cancel {
  background: rgba(155, 160, 198, 0.1);
  color: var(--text);
  border: 1px solid rgba(155, 160, 198, 0.3);
}

.delete-modal-btn.cancel:hover {
  background: rgba(155, 160, 198, 0.2);
  transform: translateY(-2px);
}

/* ===== FOOTER ===== */
footer{
  text-align:center;
  padding:12px 15px;
  font-size:.78rem;
  color:var(--muted);
  border-top:1px solid #1b1f3d;
  margin-top: auto;
  width: 100%;
  overflow: hidden;
}

footer img {
  height: 100px;
  margin-bottom: 8px;
  max-width: 100%;
}

/* ================= USER MANAGEMENT SPECIFIC STYLES ================= */
/* User Management Tabs */
.user-management-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 30px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  padding-bottom: 10px;
  flex-wrap: wrap;
}

.user-management-tab {
  background: transparent;
  border: none;
  color: var(--muted);
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.user-management-tab.active {
  background: rgba(91, 140, 255, 0.1);
  color: var(--accent);
  border-bottom: 2px solid var(--accent);
}

.user-management-tab:hover:not(.active) {
  background: rgba(155, 160, 198, 0.1);
}

.user-management-content {
  display: none;
  animation: fadeInUp 0.5s ease;
}

.user-management-content.active {
  display: block;
}

/* Data Framework Section */
/* Data Framework Section - MOBILE OPTIMIZED */
.framework-preview {
  background: rgba(12, 16, 36, 0.3);
  border-radius: 12px;
  padding: 15px;
  margin-top: 15px;
  border: 1px dashed rgba(91, 140, 255, 0.3);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  max-width: 100%;
  box-sizing: border-box;
}

.framework-preview-title {
  color: var(--accent);
  margin-bottom: 15px;
  font-size: 1.1rem;
  font-weight: 600;
}

.framework-preview-table {
  width: 100%;
  border-collapse: collapse;
  /* Add this line to ensure table fits */
  min-width: 0;
}

.framework-preview-table th,
.framework-preview-table td {
  padding: 12px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  /* Add these lines to prevent overflow */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 200px;
}

.framework-preview-table th {
  background: rgba(91, 140, 255, 0.1);
  color: var(--accent);
  text-align: left;
  font-weight: 600;
  border-bottom: 2px solid rgba(91, 140, 255, 0.3);
}

/* User Registration Settings */
.registration-switch-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(12, 16, 36, 0.5);
  border-radius: 10px;
}

.registration-switch-label {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text);
}

.registration-switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 30px;
}

.registration-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.registration-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(255, 107, 107, 0.3);
  transition: .4s;
  border-radius: 34px;
}

.registration-slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

.registration-switch input:checked + .registration-slider {
  background-color: rgba(53, 208, 127, 0.3);
}

.registration-switch input:checked + .registration-slider:before {
  transform: translateX(30px);
}

/* User Table - MOBILE OPTIMIZED */
.user-table-container {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  margin-top: 15px;
  border-radius: 8px;
  background: rgba(12, 16, 36, 0.2);
  padding: 5px;
  max-width: 100%;
  position: relative;
}

.user-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 700px;
  font-size: 0.9rem;
}

.user-table th {
  background: rgba(91, 140, 255, 0.1);
  color: var(--accent);
  padding: 12px 10px;
  text-align: left;
  font-weight: 600;
  border-bottom: 2px solid rgba(91, 140, 255, 0.3);
  font-size: 0.85rem;
  white-space: nowrap;
  position: sticky;
  top: 0;
}

.user-table td {
  padding: 12px 10px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  vertical-align: middle;
  text-align:center;
  font-size: 0.85rem;
  word-break: break-word;
  max-width: 180px;
}

.user-table tr:hover {
  background: rgba(91, 140, 255, 0.05);
}

.user-table tr.red-flag {
  background: rgba(255, 107, 107, 0.1);
  border-left: 4px solid var(--warning);
}

.user-table tr.red-flag:hover {
  background: rgba(255, 107, 107, 0.15);
}

.user-action-buttons {
  display: flex;
  gap: 8px;
}

.user-action-btn {
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.user-action-edit-btn {
  background: rgba(91, 140, 255, 0.1);
  color: var(--accent);
  border: 1px solid rgba(91, 140, 255, 0.3);
}

.user-action-edit-btn:hover {
  background: rgba(91, 140, 255, 0.2);
}

.user-action-delete-btn {
  background: rgba(255, 107, 107, 0.1);
  color: var(--warning);
  border: 1px solid rgba(255, 107, 107, 0.3);
}

.user-action-delete-btn:hover {
  background: rgba(255, 107, 107, 0.2);
}

.user-action-flag-btn {
  display:flex;
  background: rgba(255, 107, 107, 0.1);
  color: var(--warning);
  border: 1px solid rgba(255, 107, 107, 0.3);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  margin-left: 5px;
  cursor: pointer;
  margin-top: 4px;


}

.user-action-flag-btn:hover {
  background: rgba(255, 107, 107, 0.2);
}

/* Search and Filter */
.user-search-filter {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.user-search-box {
  flex: 1;
  min-width: 300px;
}

.user-filter-box {
  width: 200px;
}

/* Group Management - MOBILE OPTIMIZED */
.group-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.group-card {
  background: rgba(12, 16, 36, 0.5);
  border-radius: 12px;
  padding: 18px;
  border: 1px solid rgba(91, 140, 255, 0.2);
  min-height: 200px;
  display: flex;
  flex-direction: column;
}

.group-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.group-title {
  color: var(--accent);
  font-weight: 600;
  font-size: 1.1rem;
}

.group-count {
  background: rgba(91, 140, 255, 0.1);
  color: var(--accent);
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
}

.group-members {
  list-style: none;
  margin-top: 15px;
}

.group-member {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.move-user-btn {
  background: rgba(53, 208, 127, 0.1);
  color: var(--success);
  border: 1px solid rgba(53, 208, 127, 0.3);
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 0.8rem;
  cursor: pointer;
}

.move-user-btn:hover {
  background: rgba(53, 208, 127, 0.2);
}

/* Case Info Modal */
.case-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 6000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.case-modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.case-modal-content {
  background: radial-gradient(120% 120% at 0% 0%, #1b1f3d, var(--card));
  border-radius: 20px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 30px 60px rgba(0, 0, 0, 0.7);
  transform: translateY(20px);
  transition: transform 0.3s ease;
  border: 1px solid rgba(255, 107, 107, 0.3);
}

.case-modal-overlay.active .case-modal-content {
  transform: translateY(0);
}

.case-modal-title {
  font-size: 1.5rem;
  color: var(--warning);
  margin-bottom: 20px;
  font-weight: 700;
}

/* User Management Modals */
.user-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 7000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.user-modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.user-modal-content {
  background: radial-gradient(120% 120% at 0% 0%, #1b1f3d, var(--card));
  border-radius: 20px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 30px 60px rgba(0, 0, 0, 0.7);
  transform: translateY(20px);
  transition: transform 0.3s ease;
  border: 1px solid rgba(91, 140, 255, 0.3);
}

.user-modal-overlay.active .user-modal-content {
  transform: translateY(0);
}

.user-modal-title {
  font-size: 1.5rem;
  color: var(--accent);
  margin-bottom: 20px;
  font-weight: 700;
}

/* User Status Badges */
.user-status-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 600;
  display: inline-block;
}

.user-status-active {
  background: rgba(53, 208, 127, 0.1);
  color: var(--success);
}

.user-status-flagged {
  background: rgba(255, 107, 107, 0.1);
  color: var(--warning);
}

.user-status-inactive {
  background: rgba(155, 160, 198, 0.1);
  color: var(--muted);
}

/* Empty States */
.user-empty-state {
  text-align: center;
  padding: 50px 20px;
  color: var(--muted);
}

.user-empty-icon {
  font-size: 3rem;
  margin-bottom: 20px;
  opacity: 0.5;
}

/* ================= USER DATABASE SHRINK STYLES ================= */
/* Reduce font sizes by 1-3px throughout user database */
#usersTab .card-form-title {
  font-size: 1.2rem; /* Reduced from 1.3rem */
}

#usersTab .form-label {
  font-size: 0.87rem; /* Reduced from 0.9rem */
  margin-bottom: 6px; /* Reduced from 8px */
}

#usersTab .form-input,
#usersTab .form-select {
  padding: 10px 13px; /* Reduced from 12px 15px */
  font-size: 0.95rem; /* Reduced from 1rem */
}

/* Shrink search and filter boxes */
#usersTab .user-search-filter {
  gap: 12px; /* Reduced from 15px */
  margin-bottom: 18px; /* Reduced from 20px */
  width: 100%;
  overflow: hidden;
}

#usersTab .user-search-box,
#usersTab .user-filter-box {
  min-width: 280px; /* Reduced from 300px */
  max-width: 100%;
  box-sizing: border-box;
}

#usersTab .user-search-box {
  flex: 1;
}

#usersTab .user-filter-box {
  flex-shrink: 0;
  width: 180px; /* Reduced from 200px */
}

/* Shrink user table */
#usersTab .user-table th {
  padding: 12px 13px; /* Reduced from 15px */
  font-size: 0.95rem; /* Reduced */
}

#usersTab .user-table td {
  padding: 12px 13px; /* Reduced from 15px */
  font-size: 0.92rem; /* Reduced */
}

/* Shrink action buttons */
#usersTab .user-action-btn {
  padding: 5px 10px; /* Reduced from 6px 12px */
  font-size: 0.82rem; /* Reduced from 0.85rem */
}

#usersTab .user-action-flag-btn {
  padding: 3px 6px; /* Reduced from 4px 8px */
  font-size: 0.72rem; /* Reduced from 0.75rem */
}

/* Shrink status badges */
#usersTab .user-status-badge {
  padding:1px 3.5px; /* Reduced from 4px 8px */
  font-size: 0.82rem; /* Reduced from 0.85rem */
}

/* Shrink form buttons in user database */
#usersTab .form-buttons .form-btn {
  padding: 10px 22px; /* Reduced from 12px 25px */
  font-size: 0.95rem; /* Reduced from 1rem */
  min-width: 115px; /* Reduced from 120px */
}

/* Shrink modal buttons in user management */
#addUserModal .modal-btn,
#editUserModal .modal-btn,
#caseModal .modal-btn {
  padding: 9px 22px; /* Reduced from 10px 25px */
  font-size: 0.88rem; /* Reduced from 0.9rem */
  min-width: 95px; /* Reduced from 100px */
}

/* Reduce spacing in modals */
#addUserModal .user-modal-content,
#editUserModal .user-modal-content,
#caseModal .case-modal-content {
  padding: 27px; /* Reduced from 30px */
}

#addUserModal .user-modal-title,
#editUserModal .user-modal-title,
#caseModal .case-modal-title {
  font-size: 1.4rem; /* Reduced from 1.5rem */
  margin-bottom: 18px; /* Reduced from 20px */
}

/* Shrink group management components */
#groupsTab .group-card {
  padding: 15px; /* Reduced from 18px */
}

#groupsTab .group-header {
  margin-bottom: 10px; /* Reduced */
}

#groupsTab .group-member {
  padding: 6px 0; /* Reduced from 8px */
  font-size: 0.85rem; /* Smaller font */
}

/* Group ordering options */
/* This is the CONTAINER - should hold .group-order-options and individual group cards */
.groups-container {
  background: rgba(12, 16, 36, 0.5);
  border-radius: 12px;
  padding: 18px 3px;
  border: 1px solid rgba(91, 140, 255, 0.2);
  min-height: 200px;
  display: flex;
  flex-direction: column;
  overflow: hidden; /* Prevent inner elements from overflowing */
  position: relative; /* Added for absolute positioning */
}



.flag-count-badge {
  position: absolute;
  top: 12px;
  right: 4px;
  background: linear-gradient(90deg,#a855f7,#9333ea);
  color: #fff;
  padding: 6px 10px;
  border-radius: 12px;
  font-weight: 700;
  font-size: 0.9rem;
  box-shadow: 0 6px 18px rgba(147,51,234,0.12);
  z-index: 5;
}

/* Scrolling container for group cards */
.groups-scroll-container {
  flex: 1;
  overflow-x: auto;
  overflow-y: hidden;
  margin-top: 10px;
  padding-bottom: 10px;
  -webkit-overflow-scrolling: touch; /* Smooth scrolling on mobile */
}

/* Horizontal layout for individual group cards */
.groups-horizontal-layout {
  display: flex;
  flex-direction: row;
  gap: 20px;
  min-width: min-content; /* Prevents flex items from shrinking too much */
  padding-right: 10px;
}

.group-order-options {
  font-size: 0.8rem;
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
  padding: 10px;
  background: rgba(12, 16, 36, 0.3);
  border-radius: 8px;
  flex-direction: row;
  flex-wrap: wrap; /* Allow wrapping on small screens */
  max-width: 100%; /* Prevent overflow */
}

.order-option {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  padding: 5px 10px;
  border-radius: 6px;
  transition: background 0.3s ease;
  margin-top: 15px;
}

.order-option:hover {
  background: rgba(91, 140, 255, 0.1);
}

.order-option.active {
  background: rgba(91, 140, 255, 0.2);
  color: var(--accent);
  border: 1px solid rgba(91, 140, 255, 0.3);
}

/* Group leader highlighting */
.group-leader {
  background: rgba(255, 215, 0, 0.15) !important;
  border-left: 3px solid gold !important;
  position: relative;
}

.group-leader::before {
  content: "â˜…";
  color: gold;
  position: absolute;
  left: 5px;
  font-size: 1.1rem;
}

/* Move user modal */
.move-user-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 8000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.move-user-modal.active {
  opacity: 1;
  visibility: visible;
}

.move-user-content {
  background: radial-gradient(120% 120% at 0% 0%, #1b1f3d, var(--card));
  border-radius: 16px;
  padding: 25px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
}

/* Highlight selected user */
.user-selected {
  background: rgba(91, 140, 255, 0.2) !important;
  border: 2px solid var(--accent) !important;
}

/* Search groups in move modal */
.group-search {
  margin-bottom: 15px;
}

.group-search-input {
  width: 100%;
  padding: 10px 15px;
  background: rgba(12, 16, 36, 0.8);
  border: 1px solid rgba(91, 140, 255, 0.3);
  border-radius: 8px;
  color: var(--text);
  font-size: 0.9rem;
}

.groups-list-move {
  max-height: 300px;
  overflow-y: auto;
  margin: 15px 0;
}

.group-item-move {
  padding: 10px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.group-item-move:hover {
  background: rgba(91, 140, 255, 0.1);
  border-color: var(--accent);
}

/* Manual group creation */
.manual-group-creation {
  margin: 20px 0;
  padding: 15px;
  background: rgba(12, 16, 36, 0.3);
  border-radius: 10px;
  border: 1px dashed rgba(91, 140, 255, 0.3);
}

.manual-group-inputs {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.manual-group-inputs input {
  flex: 1;
  min-width: 200px;
  padding: 8px 12px;
  background: rgba(12, 16, 36, 0.8);
  border: 1px solid rgba(91, 140, 255, 0.3);
  border-radius: 6px;
  color: var(--text);
  font-size: 0.9rem;
}

#groupsTab .group-title {
  font-size: 1.05rem; /* Reduced from 1.1rem */
}

#groupsTab .group-count {
  padding: 3px 9px; /* Reduced from 4px 10px */
  font-size: 0.82rem; /* Reduced from 0.85rem */
}

#groupsTab .move-user-btn {
  padding: 3px 9px; /* Reduced from 4px 10px */
  font-size: 0.77rem; /* Reduced from 0.8rem */
}

/* Shrink registration settings */
#settingsTab .registration-switch-label {
  font-size: 1.05rem; /* Reduced from 1.1rem */
}

#settingsTab .registration-switch-container {
  padding: 10px; /* Reduced from 13px */
  margin-bottom: 15px; /* Reduced from 18px */
}

/* New registration mode switch */
.registration-mode-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 15px;
  padding: 12px;
  background: rgba(12, 16, 36, 0.5);
  border-radius: 10px;
}

.registration-mode-label {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text);
}

.registration-mode-switch {
  position: relative;
  display: inline-block;
  width: 120px;
  height: 30px;
}

.registration-mode-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.registration-mode-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(91, 140, 255, 0.3);
  transition: .4s;
  border-radius: 34px;
}

.registration-mode-slider:before {
  position: absolute;
  content: "Default";
  height: 22px;
  width: 60px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--card);
}

.registration-mode-switch input:checked + .registration-mode-slider {
  background-color: rgba(53, 208, 127, 0.3);
}

.registration-mode-switch input:checked + .registration-mode-slider:before {
  transform: translateX(52px);
  content: "Link";
}

/* Link settings */
.link-settings {
  margin-top: 20px;
  padding: 15px;
  background: rgba(12, 16, 36, 0.3);
  border-radius: 10px;
  border: 1px dashed rgba(91, 140, 255, 0.3);
  display: none; /* Hidden by default */
}

.link-settings.active {
  display: block;
  animation: fadeInUp 0.3s ease;
}

.link-input-group {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.link-input-group input {
  flex: 1;
  padding: 10px 15px;
  background: rgba(12, 16, 36, 0.8);
  border: 1px solid rgba(91, 140, 255, 0.3);
  border-radius: 8px;
  color: var(--text);
  font-size: 0.9rem;
}

/* Test button for link */
.test-link-btn {
  background: rgba(91, 140, 255, 0.1);
  color: var(--accent);
  border: 1px solid rgba(91, 140, 255, 0.3);
  padding: 8px 15px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.test-link-btn:hover {
  background: rgba(91, 140, 255, 0.2);
}

/* Mode description */
.mode-description {
  color: var(--muted);
  font-size: 0.85rem;
  line-height: 1.4;
  margin-top: 5px;
  padding: 8px;
  background: rgba(12, 16, 36, 0.2);
  border-radius: 6px;
}

/* Adjust group management input sizes */
#groupsTab .form-group {
  width: 190px; /* Reduced from 200px */
}

#groupsTab .form-buttons .form-btn {
  padding: 10px 22px; /* Reduced from 12px 25px */
}

/* Adjust empty states */
#usersTab .user-empty-state {
  padding: 47px 20px; /* Reduced from 50px 20px */
}

#usersTab .user-empty-icon {
  font-size: 2.8rem; /* Reduced from 3rem */
}

/* Reduce table header and cell sizes further for mobile */
@media (max-width: 768px) {
  #usersTab .user-table th,
  #usersTab .user-table td {
    padding: 9px 7px; /* Reduced from 10px 8px */
    font-size: 0.82rem; /* Reduced from 0.85rem */
  }

  #usersTab .user-action-btn {
    font-size: 0.78rem; /* Reduced from 0.8rem */
    padding: 4px 7px; /* Reduced from 5px 8px */
  }
}

/* Compact view for user action buttons */
#usersTab .user-action-buttons {
  gap: 6px; /* Reduced from 8px */
}

/* Reduce spacing in table rows */
#usersTab .user-table tr {
  height: auto; /* Allow natural height */
}

/* Shrink export and add user buttons */
#usersTab .form-buttons {
  gap: 12px; /* Reduced from 15px */
  margin-top: 22px; /* Reduced from 25px */
}

/* Adjust group member spacing */
#groupsTab .group-member {
  padding: 7px 0; /* Reduced from 8px 0 */
}

/* Make the table more compact */
#usersTab .user-table-container {
  margin-top: 18px; /* Reduced from 20px */
}

/* Adjust search input placeholder size */
#usersTab .form-input::placeholder {
  font-size: 0.92rem; /* Reduced slightly */
}

/* ===== RESPONSIVE ADJUSTMENTS ===== */
@media (max-width: 768px) {
  main {
    padding: 12px;
    gap: 14px;
  }

  .card {
    padding: 14px 16px;
    gap: 8px;
  }

  .card h3 {
    font-size: 1rem;
    padding-right: 40px;
  }

  .badge {
    font-size: 0.65rem;
    white-space: normal;
    max-width: 100%;
  }

  .spinner {
    top: 12px;
    right: 12px;
    width: 24px;
    height: 24px;
  }

  nav {
    right: 10px;
  }

  .image-slider {
    flex-direction: column;
    gap: 20px;
    min-height: 350px;
  }

  .slider-nav {
    width: 38px;
    height: 38px;
    font-size: 1.2rem;
  }

  .slider-nav-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
    order: 3;
    width: 100%;
    margin-top: -30px;
  }

  .slider-nav.prev,
  .slider-nav.next {
    position: static;
    order: unset;
  }

  .slider-image {
    max-width: 95%;
    max-height: 350px;
    order: 2;
  }

  .slider-image-container {
    order: 2;
  }

  main.slider-open {
    margin-top: 450px;
  }

  .admin-modal-content {
    padding: 20px;
    width: 95%;
  }

  .admin-modal-buttons {
    flex-direction: row;
    gap: 10px;
  }

  .admin-modal-btn {
    width: 40%;
  }

  .card-footer {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .badge-container {
    width: 100%;
    justify-content: space-between;
  }

  .badge.ends {
    margin-left: 0;
  }

  .admin-stats {
    grid-template-columns: 1fr;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .time-inputs {
    grid-template-columns: 1fr;
  }

  .admin-cards-container {
    grid-template-columns: 1fr;
  }

  .admin-tabs {
    flex-direction: column;
  }

  .admin-tab {
    width: 100%;
    text-align: center;
  }

  .admin-images-container {
    grid-template-columns: 1fr;
  }

  .admin-dashboard-grid {
    grid-template-columns: 1fr;
  }

  .menu-card {
    min-height: 180px;
    padding: 25px;
  }

  .menu-card-icon {
    font-size: 2.5rem;
  }

  .color-options {
    grid-template-columns: repeat(3, 1fr);
  }

  /* Framework table mobile adjustments */
  .framework-preview-table th,
  .framework-preview-table td {
    padding: 8px 6px;
    font-size: 0.85rem;
    max-width: 150px;
  }

  .framework-preview-table td:last-child {
    min-width: 120px; /* Ensure action buttons have enough space */
  }

  /* User Management Responsive */
  .user-management-tabs {
    flex-direction: column;
  }

  .user-management-tab {
    width: 100%;
    text-align: center;
  }

  .user-search-filter {
    flex-direction: column;
  }

  .user-search-box, .user-filter-box {
    width: 100%;
    min-width: auto;
  }

  .user-table th,
  .user-table td {
    padding: 9px 7px; /* Reduced from 10px 8px */
    font-size: 0.82rem; /* Reduced from 0.85rem */
  }

  .user-action-btn {
    font-size: 0.78rem; /* Reduced from 0.8rem */
    padding: 4px 7px; /* Reduced from 5px 8px */
  }

  .user-action-btn {
    font-size: 0.8rem;
    padding: 5px 8px;
  }

  .group-list {
    grid-template-columns: 1fr;
  }

  /* Add responsive styles for horizontal scrolling groups */
  .group-card {
    min-width: 320px; /* Increased by 30% from 280px to ~364px, but kept smaller for mobile */
    max-width: 320px;
    padding: 15px;
  }

  .groups-scroll-container {
    padding-bottom: 15px; /* Extra space for scroll indication */
  }

  /* Custom scrollbar for better UX */
  .groups-scroll-container::-webkit-scrollbar {
    height: 6px;
  }

  .groups-scroll-container::-webkit-scrollbar-track {
    background: rgba(12, 16, 36, 0.3);
    border-radius: 3px;
  }

  .groups-scroll-container::-webkit-scrollbar-thumb {
    background: rgba(91, 140, 255, 0.5);
    border-radius: 3px;
  }
}

@media (max-width: 480px) {
  header {
    padding: 14px 15px;
  }

  .brand-container {
    gap: 10px;
  }

  .brand {
    font-size: 1.4rem;
  }

  .toggle-slider-btn {
    max-width: 30px;
  }

  .toggle-slider-btn .v-icon {
    width: 20px;
    height: 20px;
  }

  .menu-btn {
    font-size: 1.4rem;
  }

  .badge {
    max-width: 100%;
  }

  .countdown {
    justify-content: flex-start;
    width: 100%;
  }

  .countdown-container {
    align-items: flex-start;
  }

  .slider-image {
    max-height: 250px;
  }

  .image-slider-container {
    padding: 15px;
  }

  .slider-nav {
    width: 36px;
    height: 34px;
    font-size: 1.1rem;
  }

  .slider-nav-buttons {
    gap: 75px;
  }

  main.slider-open {
    margin-top: 320px;
  }

  .color-options {
    grid-template-columns: repeat(2, 1fr);
  }

  /* Smaller group cards on very small screens */
  .group-card {
    min-width: 350px; /* Increased by 30% from 260px to ~338px, but kept smaller for mobile */
    max-width: 600px;
    padding: 12px;
  }
}





/* Flagged group visual state */
.group-card.flagged-group {
  background: linear-gradient(90deg, rgba(147,51,234,0.14), rgba(168,85,247,0.08));
  border-color: rgba(147,51,234,0.35);
}

/* Member flagged state */
.group-member.member-flagged {
  background: rgba(255, 107, 107, 0.1) !important;
  border-left: 3px solid var(--warning);
}

/* Group action button */
.group-action-btn {
  background: rgba(91, 140, 255, 0.1);
  color: var(--accent);
  border: 1px solid rgba(91, 140, 255, 0.3);
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  margin: 0 8px;
}

.group-action-btn:hover {
  background: rgba(91, 140, 255, 0.2);
  transform: scale(1.1);
}
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Add this line - It loads Supabase from their CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>

</head>

<body>

<header>
  <div class="header-container">
    <div class="brand-container">
      <div class="brand">RING-<span class="zero">0</span></div>
    </div>
    <button class="toggle-slider-btn down" onclick="toggleImageSlider()">
      <div class="v-icon"></div>
    </button>
  </div>
  <div class="menu-btn" onclick="toggleMenu()">â˜°</div>
  <nav id="menu">
    <a href="https://mega.nz/folder/iddCgbBK#94OLVR4IwfwRSTlFH2fmaw" target="_blank"> <button>Nots/past-files</button></a>
    <a href="https://mega.nz/folder/bAFmVZxa#TMViP5JDces4FOTUHNOx7g"><button>calender</button></a>
    <a href="groups.html"> <button>groups</button></a>
    <a href="https://mega.nz/folder/mN0UgQ4Q#aXEKtfCucBCY1moMNd8a1A"><button>UNI-COT.stf</button></a>
    <a href="properties.html"><button>properties</button></a>
    <button class="admin-login">Admin log in</button>
    <button>member sign up</button>
  </nav>
</header>

<!-- Image Slider Container -->
<div class="image-slider-container" id="imageSlider">
  <div class="slider-content">
     <button class="filter-icon" onclick="toggleFilterPanel()">
       <u>Filter</u>
    </button>
    
    <div class="slider-filter-panel" id="sliderFilterPanel">
      <div class="filter-options">
        <label class="filter-option">
          <input type="radio" name="categoryFilter" value="all" checked onchange="applySliderFilter('all')">
          <span>All Categories</span>
        </label>
        <label class="filter-option">
          <input type="radio" name="categoryFilter" value="critical" onchange="applySliderFilter('critical')">
          <span>Critical</span>
        </label>
        <label class="filter-option">
          <input type="radio" name="categoryFilter" value="important" onchange="applySliderFilter('important')">
          <span>Important</span>
        </label>
        <label class="filter-option">
          <input type="radio" name="categoryFilter" value="entertainment" onchange="applySliderFilter('entertainment')">
          <span>Entertainment</span>
        </label>
        <label class="filter-option">
          <input type="radio" name="categoryFilter" value="additional" onchange="applySliderFilter('additional')">
          <span>Additional</span>
        </label>
      </div>
    </div>
    
    <div class="slider-title">---------</div>
    <div class="slider-subtitle" id="sliderSubtitle"></div>
    
    <div class="image-slider">
      <div class="slider-image-container">
        <img src="time_table.jpg" alt="University Timetable" class="slider-image" id="currentImage">
      </div>
      <div class="slider-nav-buttons">
        <button class="slider-nav prev" onclick="prevImage()">â®</button>
        <div class="slider-counter" id="sliderCounter">1/2</div>
        <button class="slider-nav next" onclick="nextImage()">â¯</button>
      </div>
    </div>
    <div class="slider-indicator">
      <span class="indicator-dot active" onclick="goToImage(0)"></span>
      <span class="indicator-dot" onclick="goToImage(1)"></span>
    </div>
  </div>
</div>

<!-- Modal/Popup for file download -->
<div class="modal-overlay" id="fileModal">
  <div class="modal-content">
    <div class="modal-title">File Download</div>
    <div class="modal-text" id="modalMessage">
      Do you want to see the "File Name" content and download it?
    </div>
    <div class="modal-buttons">
      <button class="modal-btn yes" onclick="downloadFile()">Yes</button>
      <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Admin Login Modal -->
<div class="admin-modal-overlay" id="adminModal">
  <div class="admin-modal-content">
    <div class="admin-modal-step active" id="step1">
      <div class="admin-modal-title">Admin Login</div>
      <div class="admin-modal-subtitle">Enter your admin password to continue</div>
      
      <div class="admin-form-group">
        <label class="admin-form-label">Admin Password</label>
        <input type="password" class="admin-form-input" id="adminPassword" placeholder="Enter admin password">
        <div class="admin-error-message" id="passwordError">Wrong password. Please try again.</div>
      </div>
      
      <div class="admin-modal-buttons">
        <button class="admin-modal-btn primary" onclick="verifyPassword()">Continue</button>
        <button class="admin-modal-btn secondary" onclick="closeAdminModal()">Cancel</button>
      </div>
    </div>
    
    <div class="admin-modal-step" id="step2">
      <div class="admin-modal-title">Email Verification</div>
      <div class="admin-modal-subtitle">Enter your admin email to receive verification code</div>
      
      <div class="admin-form-group">
        <label class="admin-form-label">Admin Email</label>
        <input type="email" class="admin-form-input" id="adminEmail" placeholder="admin@example.com">
        <div class="admin-error-message" id="emailError">Please enter a valid email address.</div>
      </div>
      
      <div class="admin-success-message" id="emailSentMessage">
        Verification code has been sent to your email. Check your inbox.
      </div>
      
      <div class="admin-modal-buttons">
        <button class="admin-modal-btn primary" onclick="sendVerificationCode()">Send Code</button>
        <button class="admin-modal-btn secondary" onclick="goToStep(1)">Back</button>
      </div>
    </div>
    
    <div class="admin-modal-step" id="step3">
      <div class="admin-modal-title">Verification Code</div>
      <div class="admin-modal-subtitle">Enter the 3-digit code sent to your email</div>
      
      <div class="admin-form-group">
        <label class="admin-form-label">Verification Code</label>
        <input type="text" class="admin-form-input" id="verificationCode" placeholder="XXX" maxlength="3" pattern="\d{3}">
        <div class="admin-error-message" id="codeError">Invalid verification code. Please try again.</div>
      </div>
      
      <div class="admin-modal-buttons">
        <button class="admin-modal-btn primary" onclick="verifyCode()">Verify & Login</button>
        <button class="admin-modal-btn secondary" onclick="goToStep(2)">Back</button>
      </div>
    </div>
  </div>
</div>

<!-- Admin Dashboard -->
<div class="admin-dashboard-overlay" id="adminDashboard">
  <div class="admin-dashboard">
    <div class="admin-header">
      <div class="admin-header-title">Admin Dashboard</div>
      <button class="admin-logout-btn" onclick="logoutAdmin()">Logout</button>
    </div>

    <!-- MAIN DASHBOARD MENU -->
    <div class="admin-dashboard-menu" id="dashboardMenu">
      <div class="admin-dashboard-grid">
        <!-- Card 1: Cards Management -->
        <div class="admin-dashboard-card menu-card" onclick="openCardManagement()">
          <div class="menu-card-icon">ðŸ“‹</div>
          <h3>Cards Management</h3>
          <p>Create, edit, delete, and manage countdown cards</p>
        </div>

        <!-- Card 2: Image Content Management -->
        <div class="admin-dashboard-card menu-card" onclick="openImageContentManagement()">
          <div class="menu-card-icon">ðŸ–¼ï¸</div>
          <h3>Image Content Management</h3>
          <p>Manage image slider content and settings</p>
        </div>

        <!-- Card 3: User Management -->
        <div class="admin-dashboard-card menu-card" onclick="openUserManagement()">
          <div class="menu-card-icon">ðŸ‘¥</div>
          <h3>User Management</h3>
          <p>Manage user accounts and registration framework</p>
        </div>

        <!-- Card 4: System Settings -->
        <div class="admin-dashboard-card menu-card" onclick="openSystemSettings()">
          <div class="menu-card-icon">âš™ï¸</div>
          <h3>System Settings</h3>
          <p>Configure system preferences and options</p>
        </div>

        <!-- Card 5: Analytics -->
        <div class="admin-dashboard-card menu-card" onclick="openAnalytics()">
          <div class="menu-card-icon">ðŸ“Š</div>
          <h3>Analytics</h3>
          <p>View usage statistics and reports</p>
        </div>

        <!-- Card 6: File Manager -->
        <div class="admin-dashboard-card menu-card" onclick="openFileManager()">
          <div class="menu-card-icon">ðŸ“</div>
          <h3>File Manager</h3>
          <p>Upload and manage files</p>
        </div>
      </div>
    </div>

    <!-- CARDS MANAGEMENT SECTION -->
    <div class="admin-management-section" id="cardsManagementSection" style="display: none;">
      <div class="back-to-menu">
        <button class="admin-modal-btn secondary" onclick="backToDashboard()">
          â† Back
        </button>
      </div>

      <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchTab('manage-cards')">Manage Cards</button>
        <button class="admin-tab" onclick="switchTab('create-card')">Create New Card</button>
        <button class="admin-tab" onclick="switchTab('view-cancelled')">View Cancelled</button>
      </div>

      <div class="admin-tab-content active" id="manage-cards">
        <div class="card-form-container">
          <h3 class="card-form-title">Active Countdown Cards</h3>
          <div class="admin-cards-container" id="activeCardsContainer"></div>
        </div>
      </div>

      <div class="admin-tab-content" id="create-card">
        <div class="card-form-container">
          <h3 class="card-form-title">Create New Countdown Card</h3>
          <form id="createCardForm">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Card Title</label>
                <input type="text" class="form-input" id="cardTitle" placeholder="Enter card title" required>
              </div>
              <div class="form-group">
                <label class="form-label">Card Description (Meta)</label>
                <input type="text" class="form-input" id="cardDescription" placeholder="Enter description" required>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Document/File URL</label>
              <small style="color: var(--muted); font-size: 0.85rem;">Users will be directed to this URL when clicking the description</small>
              <input type="url" class="form-input" id="cardFileUrl" placeholder="https://example.com/document.pdf" required>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">End Date & Time</label>
                <div class="datetime-simple-group" style="display:flex; gap:8px; align-items:center;">
                  <input type="date" class="form-input" id="cardEndDate" required style="flex:1">
                  <input type="text" class="form-input" id="cardEndTime" required style="max-width:80px;" placeholder="HH:MM">
                </div>
              </div>
            </div>

            <div class="quick-suggestions">
              <div class="suggestion-title">Quick Suggestions:</div>
              <div class="suggestion-buttons">
                <button type="button" class="suggestion-btn" onclick="setDateTime('end', '+1', 18, 0)">
                  End: Tomorrow 18:00
                </button>
                <button type="button" class="suggestion-btn" onclick="setDateTime('both', 'week')">
                  One Week Duration
                </button>
              </div>
            </div>

            <div class="form-buttons">
              <button type="button" class="form-btn secondary" onclick="resetCardForm()">Reset</button>
              <button type="submit" class="form-btn primary" id="cardSubmitBtn">Create Card</button>
            </div>
          </form>
        </div>
      </div>

      <div class="admin-tab-content" id="view-cancelled">
        <div class="card-form-container">
          <h3 class="card-form-title">Cancelled Cards</h3>
          <div class="admin-cards-container" id="cancelledCardsContainer"></div>
        </div>
      </div>
    </div>

    <!-- IMAGE CONTENT MANAGEMENT SECTION -->
    <div class="admin-management-section" id="imageContentManagementSection" style="display: none;">
      <div class="back-to-menu">
        <button class="admin-modal-btn secondary" onclick="backToDashboard()">
          â† Back
        </button>
      </div>


      <h2 style="color: var(--accent); margin-bottom: 20px;">Image Slider Content Management</h2>

      <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchImageTab('manage-images')">Manage Images</button>
        <button class="admin-tab" onclick="switchImageTab('create-image')">Upload New Image</button>
        

<button class="admin-tab" onclick="handleAdminPanelDirectAccess()">
    <i class="fas fa-user-shield"></i> Admin Panel (Direct Access)
</button>

        <button class="admin-tab" onclick="switchImageTab('slider-settings')">Slider Settings</button>
      </div>

      <div class="admin-tab-content active" id="manage-images">
        <div class="card-form-container">
          <h3 class="card-form-title">Active Image Posts</h3>
          <div class="filter-controls" style="margin-bottom: 20px;">
            <select id="imageCategoryFilter" class="form-select" style="width: 200px;" onchange="filterImagesByCategory()">
              <option value="all">All Categories</option>
              <option value="critical">Critical</option>
              <option value="important">Important</option>
              <option value="entertainment">Entertainment</option>
              <option value="additional">Additional</option>
            </select>
          </div>
          <div class="admin-images-container" id="activeImagesContainer"></div>
        </div>
      </div>

      <div class="admin-tab-content" id="create-image">
        <div class="card-form-container">
          <h3 class="card-form-title">Create New Image Post</h3>
          <form id="createImageForm">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Image Title</label>
                <input type="text" class="form-input" id="imageTitle" placeholder="Enter image title" required>
              </div>
              <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="imageCategory" required>
                  <option value="">Select Category</option>
                  <option value="critical">Critical</option>
                  <option value="important">Important</option>
                  <option value="entertainment">Entertainment</option>
                  <option value="additional">Additional</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Image Description</label>
              <textarea class="form-textarea" id="imageDescription" placeholder="Enter image description" rows="3" required></textarea>
            </div>

            <div class="form-group">
              <label class="form-label">Target URL (Optional)</label>
              <small style="color: var(--muted); font-size: 0.85rem;">Users will be redirected to this URL when clicking the image</small>
              <input type="url" class="form-input" id="imageTargetUrl" placeholder="https://example.com">
            </div>

            <div class="form-group">
              <label class="form-label">Upload Image</label>
              <input type="file" class="form-input" id="imageUpload" accept="image/*" style="padding: 8px;">
              <small style="color: var(--muted); font-size: 0.85rem;">Recommended size: 800x450px or similar aspect ratio. Leave empty to keep current image.</small>
              <div id="imagePreview" style="margin-top: 10px; display: none;">
                <img id="previewImage" style="max-width: 200px; max-height: 150px; border-radius: 8px;">
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Visibility Schedule</label>
                <select class="form-select" id="imageVisibility" onchange="toggleVisibilityOptions()">
                  <option value="forever">Forever (Default)</option>
                  <option value="days">For Specific Days</option>
                  <option value="date">Until Specific Date</option>
                </select>
              </div>
              <div class="form-group" id="daysInputGroup" style="display: none;">
                <label class="form-label">Number of Days</label>
                <input type="number" class="form-input" id="imageDays" min="1" placeholder="e.g., 7">
              </div>
              <div class="form-group" id="dateInputGroup" style="display: none;">
                <label class="form-label">End Date</label>
                <input type="date" class="form-input" id="imageEndDate">
              </div>
            </div>

            <div class="form-buttons">
              <button type="button" class="form-btn secondary" onclick="resetImageForm()">Reset</button>
              <button type="submit" class="form-btn primary" id="imageSubmitBtn">Upload Image</button>
            </div>
          </form>
        </div>
      </div>

      <div class="admin-tab-content" id="slider-settings">
        <div class="card-form-container">
          <h3 class="card-form-title">Slider Display Settings</h3>
          <div class="form-group">
            <label class="form-label">Slider Background Color</label>
            <div class="color-options">
              <button type="button" class="color-option" data-color="#0f1220" style="background: #0f1220;" onclick="selectColor('#0f1220')"></button>
              <button type="button" class="color-option" data-color="#171a2e" style="background: #171a2e;" onclick="selectColor('#171a2e')"></button>
              <button type="button" class="color-option" data-color="#0c1024" style="background: #0c1024;" onclick="selectColor('#0c1024')"></button>
              <button type="button" class="color-option" data-color="#1b1f3d" style="background: #1b1f3d;" onclick="selectColor('#1b1f3d')"></button>
              <button type="button" class="color-option" data-color="#5b8cff" style="background: #5b8cff;" onclick="selectColor('#5b8cff')"></button>
            </div>
            <input type="hidden" id="selectedColor" value="#0f1220">
          </div>

          <div class="form-group">
            <label class="form-label">Auto-advance Images</label>
            <select class="form-select" id="autoAdvance">
              <option value="0" selected>Disabled</option>
              <option value="3000">3 seconds</option>
              <option value="5000">5 seconds</option>
              <option value="10000">10 seconds</option>
            </select>
          </div>

          <div class="form-buttons">
            <button type="button" class="form-btn primary" onclick="saveSliderSettings()">Save Settings</button>
          </div>
        </div>
      </div>
    </div>

    <!-- USER MANAGEMENT SECTION -->
    <div class="admin-management-section" id="userManagementSection" style="display: none;">
      <div class="back-to-menu">
        <button class="admin-modal-btn secondary" onclick="backToDashboard()">
          â† Back
        </button>
      </div>
      
      <h2 style="color: var(--accent); margin-bottom: 20px;">User Management System</h2>
      
      <!-- User Management Tabs -->
      <div class="user-management-tabs">
        <button class="user-management-tab active" onclick="switchUserTab('framework')">Data Framework</button>
        <button class="user-management-tab" onclick="switchUserTab('users')">User Management</button>
        <button class="user-management-tab" onclick="switchUserTab('groups')">Group Management</button>
        <button class="user-management-tab" onclick="switchUserTab('settings')">Registration Settings</button>
      </div>

      <!-- Data Framework Tab -->
      <div class="user-management-content active" id="frameworkTab">
        <div class="card-form-container">
          <div class="card-form-title">Define Data Collection Framework</div>
          <p style="color: var(--muted); margin-bottom: 20px; font-size: 0.75rem;">
            Define the data fields you want to collect from users. Users will fill out forms based on this framework.
          </p>
          
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Field Name</label>
              <input type="text" class="form-input" id="fieldName" placeholder="e.g., Full Name">
            </div>
            <div class="form-group">
              <label class="form-label">Field Type</label>
              <select class="form-select" id="fieldType">
                <option value="text">Text</option>
                <option value="number">Number</option>
                <option value="email">Email</option>
                <option value="phone">Phone</option>
                <option value="date">Date</option>
                <option value="select">Dropdown</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Required</label>
              <select class="form-select" id="fieldRequired">
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>

          <button class="form-btn secondary" onclick="addField()">+ Add Field</button>

          <div class="framework-preview">
            <div class="framework-preview-title">Current Framework Preview</div>
            <table class="framework-preview-table" id="frameworkTable">
              <thead>
                <tr>
                  <th>Field Name</th>
                  <th>Type</th>
                  <th>Required</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="frameworkFields">
                <!-- Fields will be added here -->
              </tbody>
            </table>
          </div>

          <div class="form-buttons">
            <button class="form-btn secondary" onclick="resetFramework()">Reset</button>
            <button class="form-btn primary" onclick="saveFramework()">Save Framework</button>
          </div>
        </div>

        <div class="card-form-container">
          <div class="card-form-title">User Registration Form Preview</div>
          <p style="color: var(--muted); margin-bottom: 20px;">
            This is how the registration form will appear to users:
          </p>
          <div id="registrationFormPreview" style="background: rgba(12, 16, 36, 0.5); padding: 20px; border-radius: 10px;">
            <!-- Form preview will be generated here -->
          </div>
        </div>
      </div>

      <!-- User Management Tab -->
      <div class="user-management-content" id="usersTab">
        <div class="card-form-container">
          <div class="card-form-title">User Database</div>
          
          <div class="user-search-filter">
            <div class="form-group user-search-box">
              <label class="form-label">Search Users</label>
              <input type="text" class="form-input" id="userSearch" placeholder="Search by name, email, or registration number..." onkeyup="searchUsers()">
            </div>
            <div class="form-group user-filter-box">
              <label class="form-label">Filter by Status</label>
              <select class="form-select" id="statusFilter" onchange="filterUsers()">
                <option value="all">All Users</option>
                <option value="active">Active</option>
                <option value="flagged">Flagged</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
          </div>

          <div class="user-table-container">
            <table class="user-table" id="userTable">
              <thead>
                <tr>
                  <th>Full Name</th>
                  <th>Registration No.</th>
                  <th>Phone Number</th>
                  <th>Email</th>
                  <th>Group</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <!-- Users will be loaded here -->
              </tbody>
            </table>
          </div>

          <div class="form-buttons">
            <button class="form-btn secondary" onclick="exportUsers()">Export CSV</button>
            <button class="form-btn primary" onclick="openAddUserModal()">+ Add New User</button>
          </div>
        </div>
      </div>

      <!-- Group Management Tab -->
      <div class="user-management-content" id="groupsTab">
        <div class="card-form-container">
          <div class="card-form-title">Group Management</div>
          
          <div style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 25px; flex-wrap: wrap;">
            <div class="form-group" style="width: 200px;">
              <label class="form-label">Set Group Size</label>
              <input type="number" class="form-input" id="groupSize" placeholder="e.g., 10" min="1" max="50">
            </div>
            <button class="form-btn secondary" onclick="createGroups()">Create Groups</button>
            <button class="form-btn primary" onclick="autoAssignGroups()">Auto-Assign Users</button>
          </div>

          <div class="group-list" id="groupList">
            <!-- Groups will be loaded here -->
          </div>
        </div>
      </div>










  

      <!-- Registration Settings Tab -->
      <div class="user-management-content" id="settingsTab">
        <div class="card-form-container">
          <div class="card-form-title">Registration Settings</div>
          
          <p style="color: var(--muted); margin-bottom: 20px;">
            When enabled, the "Member Sign Up" button will appear on the main menu.
            When disabled, the button will be hidden in real-time.
          </p>
          
          <div class="registration-switch-container">
            <div class="registration-switch-label">Enable Member Sign Up</div>
           
            <label class="registration-switch">
              <input type="checkbox" id="registrationSwitch" checked>
              <span class="registration-slider"></span>
            </label>
          </div>

           

          <!-- Removed old registration link section -->

          <div class="form-buttons">
            <button class="form-btn primary" onclick="saveRegistrationSettings()">Save Settings</button>
          </div>
        </div>
      </div>
    </div>

    <!-- OTHER MANAGEMENT SECTIONS -->

    <div class="admin-management-section" id="systemSettingsSection" style="display: none;">
      <div class="back-to-menu">
        <button class="admin-modal-btn secondary" onclick="backToDashboard()">
          â† Back
        </button>
      </div>
      <h2>System Settings (Coming Soon)</h2>
    </div>

    <div class="admin-management-section" id="analyticsSection" style="display: none;">
      <div class="back-to-menu">
        <button class="admin-modal-btn secondary" onclick="backToDashboard()">
          â† Back
        </button>
      </div>
      <h2>Analytics (Coming Soon)</h2>
    </div>

    <div class="admin-management-section" id="fileManagerSection" style="display: none;">
      <div class="back-to-menu">
        <button class="admin-modal-btn secondary" onclick="backToDashboard()">
          â† Back
        </button>
      </div>
      <h2>File Manager (Coming Soon)</h2>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="delete-modal" id="deleteModal">
  <div class="delete-modal-content">
    <div class="delete-modal-title">Delete Card</div>
    <div class="delete-modal-text" id="deleteModalMessage">
      Are you sure you want to delete this card? This action cannot be undone.
    </div>
    <div class="delete-modal-buttons">
      <button class="delete-modal-btn yes" onclick="confirmDelete()">Yes, Delete</button>
      <button class="delete-modal-btn cancel" onclick="closeDeleteModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- User Management Modals -->
<div class="user-modal-overlay" id="addUserModal">
  <div class="user-modal-content">
    <div class="user-modal-title">Add New User</div>
    <form id="addUserForm">
      <div id="addUserFields">
        <!-- Dynamic fields based on framework -->
      </div>
      <div class="modal-buttons">
        <button type="button" class="modal-btn cancel" onclick="closeAddUserModal()">Cancel</button>
        <button type="submit" class="modal-btn yes">Add User</button>
      </div>
    </form>
  </div>
</div>

<div class="user-modal-overlay" id="editUserModal">
  <div class="user-modal-content">
    <div class="user-modal-title">Edit User</div>
    <form id="editUserForm">
      <div id="editUserFields">
        <!-- Dynamic fields based on framework -->
      </div>
      <div class="modal-buttons">
        <button type="button" class="modal-btn cancel" onclick="closeEditUserModal()">Cancel</button>
        <button type="submit" class="modal-btn yes">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<div class="case-modal-overlay" id="caseModal">
  <div class="case-modal-content">
    <div class="case-modal-title">Add Case Information</div>
    <div class="form-group">
      <label class="form-label">Case Details</label>
      <textarea class="form-textarea" id="caseDetails" rows="4" placeholder="Enter case details for this user..."></textarea>
    </div>
    <div class="modal-buttons">
      <button type="button" class="modal-btn cancel" onclick="closeCaseModal()">Cancel</button>
      <button type="button" class="modal-btn yes" onclick="saveCaseInfo()">Save Case</button>
    </div>
  </div>
</div>

<main id="cards"></main>

<footer> 
  <img src="UNI-COT.png" alt="union_image" height="100"><br> 
  Â© 2025 RING-0 _from MC core
</footer>

<script>
// ================= SUPABASE SERVICE =================
// This NEW section handles all Supabase connections
let supabaseClient = null;
let supabaseConnected = false;

function initializeSupabase() {
  try {
    console.log('ðŸ”§ Setting up Supabase connection...');

    // Your Supabase project details from info.txt
    const supabaseUrl = 'https://vqcjwgfztwgihuqwkyni.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxY2p3Z2Z6dHdnaWh1cXdreW5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMTE4NTAsImV4cCI6MjA4Njg4Nzg1MH0.F79IbPNfZpe-qbmOsBFoZ3mtcXqKj15GMTTvDqDDKCA';

    // Create the client
    supabaseClient = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

    console.log('âœ… Supabase client created');
    return true;
  } catch (error) {
    console.error('âŒ Failed to create Supabase client:', error);
    return false;
  }
}

// Check if we're online and can connect
function testSupabaseConnection() {
  if (!supabaseClient) return false;

  return new Promise(async (resolve) => {
    try {
      // Simple test query - just check if we can connect
      const { error } = await supabaseClient
        .from('countdown_cards')
        .select('id')
        .limit(1);

      if (error) {
        console.warn('âš ï¸ Supabase connection test failed:', error.message);
        resolve(false);
      } else {
        console.log('âœ… Supabase connection successful');
        supabaseConnected = true;
        resolve(true);
      }
    } catch (error) {
      console.warn('âš ï¸ Network error testing Supabase:', error.message);
      resolve(false);
    }
  });
}

// Load data from localStorage first (for fast loading)
function loadFromLocalStorage() {
  console.log('ðŸ“± Loading cached data from localStorage...');

  // Load countdown cards
  const savedCards = localStorage.getItem('ring0_admin_cards');
  if (savedCards) {
    try {
      allPosts = JSON.parse(savedCards);
      console.log(`ðŸ“Š Loaded ${allPosts.length} cards from cache`);
    } catch (e) {
      console.warn('Could not load cards from cache');
    }
  }

  // Load images
  const savedImages = localStorage.getItem('ring0_slider_images');
  if (savedImages) {
    try {
      allImages = JSON.parse(savedImages);
      console.log(`ðŸ–¼ï¸ Loaded ${allImages.length} images from cache`);
    } catch (e) {
      console.warn('Could not load images from cache');
    }
  }
}

// Save data to localStorage
function saveToLocalStorage(key, data) {
  try {
    localStorage.setItem(key, JSON.stringify(data));
    console.log(`ðŸ’¾ Saved ${data.length} items to localStorage (${key})`);
  } catch (e) {
    console.warn('Could not save to localStorage:', e);
  }
}

// Subscribe to realtime updates for countdown cards
function subscribeToCards() {
  if (!supabaseClient) {
    console.warn('Cannot subscribe: Supabase client not ready');
    return;
  }
  
  console.log('ðŸ“¡ Subscribing to countdown cards updates...');
  
  const channel = supabaseClient
    .channel('cards-channel')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'countdown_cards'
      },
      (payload) => {
        console.log('ðŸ”„ Cards updated via Supabase Realtime:', payload);
        
        // Transform Supabase data to match local structure
        const transformCard = (card) => ({
          id: card.id,
          title: card.title,
          description: card.description,
          fileUrl: card.file_url,
          start: card.start_time,
          end: card.end_time,
          status: card.status,
          createdBy: card.created_by,
          createdAt: card.created_at
        });
        
        // Handle different types of changes
        if (payload.eventType === 'INSERT') {
          // New card added
          const transformedCard = transformCard(payload.new);
          allPosts.push(transformedCard);
        } else if (payload.eventType === 'UPDATE') {
          // Card updated - find and replace
          const transformedCard = transformCard(payload.new);
          const index = allPosts.findIndex(card => card.id === payload.new.id);
          if (index !== -1) {
            allPosts[index] = transformedCard;
          }
        } else if (payload.eventType === 'DELETE') {
          // Card deleted - remove from array
          allPosts = allPosts.filter(card => card.id !== payload.old.id);
        }
        
        // Save to localStorage
        saveToLocalStorage('ring0_admin_cards', allPosts);
        
        // Update the UI (your existing function)
        if (typeof update === 'function') {
          update();
        }
        
        // Update admin dashboard
        if (typeof renderActiveCards === 'function') {
          renderActiveCards();
        }
      }
    )
    .subscribe();
  
  console.log('âœ… Subscribed to cards realtime channel');
}

// Subscribe to realtime updates for images
function subscribeToImages() {
  if (!supabaseClient) {
    console.warn('Cannot subscribe: Supabase client not ready');
    return;
  }

  console.log('ðŸ“¡ Subscribing to images updates...');

  const channel = supabaseClient
    .channel('images-channel')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'image_posts'
      },
      (payload) => {
        console.log('ðŸ”„ Real-time image update:', payload.eventType, payload.new?.id || payload.old?.id);

        // ðŸ”¥ ENHANCED: Handle different event types
        if (payload.eventType === 'INSERT') {
          // Transform Supabase data to match local structure
          const transformedImage = {
            id: payload.new.id,
            title: payload.new.title,
            description: payload.new.description,
            category: payload.new.category,
            imageData: payload.new.cloudinary_url, // Use URL as imageData
            cloudinaryUrl: payload.new.cloudinary_url,
            targetUrl: payload.new.target_url,
            expiresAt: payload.new.expires_at,
            status: payload.new.status,
            order: payload.new.display_order || 0,
            createdAt: payload.new.created_at
          };
          
          // Check if already exists (prevent duplicates)
          const exists = allImages.find(img => img.id === transformedImage.id);
          if (!exists) {
            allImages.push(transformedImage);
            console.log('âž• Added image via realtime:', transformedImage.title);
          }
          
        } else if (payload.eventType === 'UPDATE') {
          const index = allImages.findIndex(img => img.id === payload.new.id);
          
          if (index !== -1) {
            // Update existing image
            allImages[index] = {
              ...allImages[index],
              title: payload.new.title,
              description: payload.new.description,
              category: payload.new.category,
              cloudinaryUrl: payload.new.cloudinary_url,
              targetUrl: payload.new.target_url,
              expiresAt: payload.new.expires_at,
              status: payload.new.status,
              order: payload.new.display_order || 0
            };
            console.log('âœï¸ Updated image via realtime:', payload.new.title);
          } else {
            // Image not found locally - might be new on another device
            const transformedImage = {
              id: payload.new.id,
              title: payload.new.title,
              description: payload.new.description,
              category: payload.new.category,
              imageData: payload.new.cloudinary_url,
              cloudinaryUrl: payload.new.cloudinary_url,
              targetUrl: payload.new.target_url,
              expiresAt: payload.new.expires_at,
              status: payload.new.status,
              order: payload.new.display_order || 0
            };
            allImages.push(transformedImage);
            console.log('âž• Added missing image via update:', transformedImage.title);
          }
          
        } else if (payload.eventType === 'DELETE') {
          // ðŸ”¥ CRITICAL: PERMANENTLY REMOVE DELETED IMAGES
          const oldId = payload.old.id;
          const initialCount = allImages.length;
          
          allImages = allImages.filter(img => String(img.id) !== String(oldId));
          
          if (allImages.length < initialCount) {
            console.log('ðŸ—‘ï¸ Removed image via realtime delete:', oldId);
          } else {
            console.log('âš ï¸ Tried to delete non-existent image:', oldId);
          }
        }

        // ðŸ”¥ ALWAYS SAVE TO LOCALSTORAGE AFTER REAL-TIME UPDATE
        saveToLocalStorage('ring0_slider_images', allImages);

        // ðŸ”¥ UPDATE ALL RELEVANT UI COMPONENTS
        if (typeof updateSliderImages === 'function') {
          updateSliderImages(); // Update the main slider
        }

        if (typeof renderActiveImages === 'function') {
          renderActiveImages(); // Update admin panel
        }
        
        // Also update image indicators if they exist
        updateSliderIndicators();

      }
    )
    .subscribe((status) => {
      if (status === 'SUBSCRIBED') {
        console.log('âœ… Successfully subscribed to images realtime channel');
      } else {
        console.warn('âš ï¸ Images channel status:', status);
      }
    });

  return channel;
}

// Fetch initial data from Supabase
async function fetchInitialData() {
  if (!supabaseClient) {
    console.warn('Cannot fetch: Supabase client not ready');
    return;
  }
  
  console.log('â¬‡ï¸ Fetching initial data from Supabase...');
  
  try {
    // Fetch countdown cards - make sure we get ALL fields
    const { data: cards, error: cardsError } = await supabaseClient
      .from('countdown_cards')
      .select('*')
      .eq('status', 'active')
      .order('created_at', { ascending: false });
    
    if (cardsError) {
      console.error('Error fetching cards:', cardsError);
    } else {
      // Transform Supabase data to match your existing structure
      const transformedCards = cards.map(card => ({
        id: card.id,
        title: card.title,
        description: card.description,
        fileUrl: card.file_url,  // Map file_url to fileUrl
        start: card.start_time,  // Map start_time to start
        end: card.end_time,      // Map end_time to end
        status: card.status,
        createdBy: card.created_by,
        createdAt: card.created_at
      }));
      
      allPosts = transformedCards;
      saveToLocalStorage('ring0_admin_cards', allPosts);
      console.log(`ðŸ“Š Fetched ${cards.length} active cards from Supabase`);
    }
    
    // Fetch images
    const { data: images, error: imagesError } = await supabaseClient
      .from('image_posts')
      .select('*')
      .eq('status', 'active')
      .order('display_order', { ascending: true });
    
    if (imagesError) {
      console.error('Error fetching images:', imagesError);
    } else {
      // Transform image data
      const transformedImages = images.map(img => ({
        id: img.id,
        title: img.title,
        description: img.description,
        category: img.category,
        imageUrl: img.cloudinary_url,  // Map cloudinary_url to imageUrl
        imageData: img.cloudinary_url, // Use URL as imageData
        targetUrl: img.target_url,
        expiresAt: img.expires_at,
        status: img.status,
        order: img.display_order
      }));
      
      allImages = transformedImages;
      saveToLocalStorage('ring0_slider_images', allImages);
      console.log(`ðŸ–¼ï¸ Fetched ${images.length} active images from Supabase`);
    }
    
    // Start realtime subscriptions
    subscribeToCards();
    subscribeToImages();
    
    // Update UI
    if (typeof update === 'function') update();
    if (typeof updateSliderImages === 'function') updateSliderImages();
    if (typeof renderActiveCards === 'function') renderActiveCards();
    
  } catch (error) {
    console.error('Error in fetchInitialData:', error);
  }
}

// Cloudinary upload function for your admin panel
async function uploadToCloudinary(file) {
  console.log('â˜ï¸ Uploading to Cloudinary...');

  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', 'malocollective');
  formData.append('cloud_name', 'dcpqnmdas');

  try {
    const response = await fetch(
      'https://api.cloudinary.com/v1_1/dcpqnmdas/image/upload',
      {
        method: 'POST',
        body: formData
      }
    );

    const result = await response.json();
    console.log('ðŸ” FULL CLOUDINARY RESPONSE:', result); // Debug: see full response

    if (result.secure_url) {
      console.log('âœ… Image uploaded to Cloudinary:', result.secure_url);
      return {
        success: true,
        url: result.secure_url,
        public_id: result.public_id,
        format: result.format
      };
    } else {
      console.error('âŒ Cloudinary upload failed:', result);
      return {
        success: false,
        error: result.error?.message || 'Upload failed'
      };
    }
  } catch (error) {
    console.error('âŒ Network error uploading to Cloudinary:', error);
    return {
      success: false,
      error: error.message
    };
  }
}

// Save image post to Supabase (for admin panel)
// ðŸ› ï¸ CORRECTED FUNCTION - Save image post to Supabase with correct column names
async function saveImageToSupabase(imageData) {
  if (!supabaseClient) {
    console.error('Cannot save: Supabase client not ready');
    return false;
  }

  try {
    // âœ… Build the data object that matches your Supabase TABLE STRUCTURE
    // The keys on the LEFT (e.g., cloudinary_url) must match your COLUMN NAMES in Supabase.
    const supabaseImageData = {
      title: imageData.title,
      description: imageData.description,
      category: imageData.category,
      target_url: imageData.targetUrl || '#',
      cloudinary_url: imageData.cloudinaryUrl, // âœ… Matches your `cloudinary_url` column
      cloudinary_public_id: imageData.cloudinaryPublicId,
      cloudinary_format: imageData.cloudinaryFormat,
      expires_at: imageData.expiresAt,
      status: 'active',
      display_order: imageData.displayOrder || 0 // Ensure a default order
    };

    console.log('Saving to Supabase with data:', supabaseImageData);

    const { data, error } = await supabaseClient
      .from('image_posts')
      .insert([supabaseImageData]) // âœ… Inserts the correctly formatted object
      .select();

    if (error) {
      console.error('âŒ Error saving image to Supabase:', error);
      return false;
    }

    console.log('âœ… Image saved to Supabase. ID:', data[0].id);
    return true;

  } catch (error) {
    console.error('âŒ Network/JS error in saveImageToSupabase:', error);
    return false;
  }
}

// Save countdown card to Supabase (for admin panel)
async function saveCardToSupabase(cardData) {
  if (!supabaseClient) {
    console.error('Cannot save: Supabase client not ready');
    return false;
  }
  
  try {
    // Make sure we're using the correct field names for Supabase
    const supabaseCardData = {
      title: cardData.title,
      description: cardData.description,
      file_url: cardData.file_url,
      start_time: cardData.start_time,
      end_time: cardData.end_time,
      status: 'active',
      created_by: 'admin'
    };
    
    const { data, error } = await supabaseClient
      .from('countdown_cards')
      .insert([supabaseCardData])
      .select();
    
    if (error) {
      console.error('âŒ Error saving card to Supabase:', error);
      return false;
    }
    
    console.log('âœ… Card saved to Supabase:', data[0].id);
    
    // Update the local card with the ID from Supabase
    cardData.id = data[0].id;
    
    return true;
  } catch (error) {
    console.error('âŒ Error in saveCardToSupabase:', error);
    return false;
  }
}

// Initialize everything
async function initSupabaseSystem() {
  console.log('ðŸš€ Initializing Supabase system...');

  // Step 1: Initialize Supabase connection FIRST
  const initialized = initializeSupabase();
  
  if (initialized) {
    // Step 2: Try to fetch FRESH data from Supabase
    try {
      await fetchInitialData();
      console.log('âœ… Fresh data loaded from Supabase');
    } catch (error) {
      console.warn('âš ï¸ Supabase fetch failed, using cached data as backup');
      loadFromLocalStorage();
    }
  } else {
    // Can't connect at all? Use cache as last resort
    console.warn('âŒ Supabase unavailable, using cached data');
    loadFromLocalStorage();
  }
}

// ================= USER MANAGEMENT REAL-TIME SYNC SYSTEM =================

// Subscribe to registration field structure changes
// ================= FIXED: Subscribe to registration field changes =================
function subscribeToRegistrationFields() {
  console.log('ðŸ“¡ Setting up registration fields real-time subscription...');
  
  if (!supabaseClient) {
    console.error('âŒ Cannot subscribe: Supabase client not ready');
    return null;
  }
  
  const channel = supabaseClient
    .channel('registration_fields_changes')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'registration_fields'
      },
      (payload) => {
        console.log('ðŸ”„ Registration fields changed:', payload.eventType);
        
        // Get current framework from localStorage
        const dataFramework = JSON.parse(localStorage.getItem('ring0_data_framework') || '[]');
        
        // Handle different event types
        if (payload.eventType === 'INSERT') {
          const newField = payload.new;
          if (!dataFramework.find(f => f.id === newField.id)) {
            dataFramework.push(newField);
            localStorage.setItem('ring0_data_framework', JSON.stringify(dataFramework));
          }
        } else if (payload.eventType === 'UPDATE') {
          const updatedField = payload.new;
          const index = dataFramework.findIndex(f => f.id === updatedField.id);
          if (index >= 0) {
            dataFramework[index] = updatedField;
            localStorage.setItem('ring0_data_framework', JSON.stringify(dataFramework));
          }
        } else if (payload.eventType === 'DELETE') {
          const deletedField = payload.old;
          const filtered = dataFramework.filter(f => f.id !== deletedField.id);
          localStorage.setItem('ring0_data_framework', JSON.stringify(filtered));
        }
        
        // Update UI if function exists
        if (typeof renderDataFramework === 'function') {
          renderDataFramework();
        }
        
        // Update form preview
        if (typeof generateRegistrationFormPreview === 'function') {
          generateRegistrationFormPreview();
        }
      }
    )
    .subscribe((status) => {
      console.log(`ðŸ“¡ Registration fields subscription status: ${status}`);
    });
  
  return channel;
}

// Subscribe to user record changes
// ================= FIXED: Subscribe to user changes =================
function subscribeToUsers() {
  console.log('ðŸ“¡ Setting up users real-time subscription...');
  
  if (!supabaseClient) {
    console.error('âŒ Cannot subscribe: Supabase client not ready');
    return null;
  }
  
  const channel = supabaseClient
    .channel('users_changes')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'users'
      },
      (payload) => {
        console.log('ðŸ”„ Users changed:', payload.eventType);
        
        // Get current users from localStorage
        const userData = JSON.parse(localStorage.getItem('ring0_user_data') || '[]');
        
        // Handle different event types
        if (payload.eventType === 'INSERT') {
          const newUser = payload.new;
          if (!userData.find(u => u.id === newUser.id)) {
            userData.push(newUser);
            localStorage.setItem('ring0_user_data', JSON.stringify(userData));
          }
        } else if (payload.eventType === 'UPDATE') {
          const updatedUser = payload.new;
          const index = userData.findIndex(u => u.id === updatedUser.id);
          if (index >= 0) {
            userData[index] = updatedUser;
            localStorage.setItem('ring0_user_data', JSON.stringify(userData));
          }
        } else if (payload.eventType === 'DELETE') {
          const deletedUser = payload.old;
          const filtered = userData.filter(u => u.id !== deletedUser.id);
          localStorage.setItem('ring0_user_data', JSON.stringify(filtered));
        }
        
        // Update UI if function exists
        if (typeof renderUserList === 'function') {
          renderUserList();
        }
        
        // Update user table
        if (typeof populateUserTable === 'function') {
          populateUserTable();
        }
      }
    )
    .subscribe((status) => {
      console.log(`ðŸ“¡ Users subscription status: ${status}`);
    });
  
  return channel;
}

// Subscribe to group changes
// ================= FIXED: Subscribe to group changes =================
function subscribeToGroups() {
  console.log('ðŸ“¡ Setting up groups real-time subscription...');
  
  if (!supabaseClient) {
    console.error('âŒ Cannot subscribe: Supabase client not ready');
    return null;
  }
  
  const channel = supabaseClient
    .channel('user_groups_changes')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'user_groups'
      },
      (payload) => {
        console.log('ðŸ”„ Groups changed:', payload.eventType);
        
        // Get current groups from localStorage
        const userGroups = JSON.parse(localStorage.getItem('ring0_user_groups') || '[]');
        
        // Handle different event types
        if (payload.eventType === 'INSERT') {
          const newGroup = payload.new;
          if (!userGroups.find(g => g.id === newGroup.id)) {
            userGroups.push(newGroup);
            localStorage.setItem('ring0_user_groups', JSON.stringify(userGroups));
          }
        } else if (payload.eventType === 'UPDATE') {
          const updatedGroup = payload.new;
          const index = userGroups.findIndex(g => g.id === updatedGroup.id);
          if (index >= 0) {
            userGroups[index] = updatedGroup;
            localStorage.setItem('ring0_user_groups', JSON.stringify(userGroups));
          }
        } else if (payload.eventType === 'DELETE') {
          const deletedGroup = payload.old;
          const filtered = userGroups.filter(g => g.id !== deletedGroup.id);
          localStorage.setItem('ring0_user_groups', JSON.stringify(filtered));
        }
        
        // Update UI if function exists
        if (typeof renderGroupList === 'function') {
          renderGroupList();
        }
        
        // Update groups display
        if (typeof populateGroups === 'function') {
          populateGroups();
        }
      }
    )
    .subscribe((status) => {
      console.log(`ðŸ“¡ Groups subscription status: ${status}`);
    });
  
  return channel;
}

// Subscribe to registration settings changes
// ================= FIXED: Subscribe to registration settings changes =================
function subscribeToRegistrationSettings() {
  console.log('ðŸ“¡ Setting up registration settings real-time subscription...');
  
  if (!supabaseClient) {
    console.error('âŒ Cannot subscribe: Supabase client not ready');
    return null;
  }
  
  const channel = supabaseClient
    .channel('registration_settings_changes')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'registration_settings'
      },
      (payload) => {
        console.log('ðŸ”„ Registration settings changed:', payload.eventType);
        
        // Update localStorage with new settings
        const settings = payload.new || payload.old;
        if (settings) {
          localStorage.setItem('ring0_registration_settings', JSON.stringify(settings));
        }
        
        // Update UI
        if (typeof updateRegistrationMenuButton === 'function') {
          updateRegistrationMenuButton();
        }
        
        if (typeof updateRegistrationSettingsUI === 'function') {
          updateRegistrationSettingsUI();
        }
      }
    )
    .subscribe((status) => {
      console.log(`ðŸ“¡ Registration settings subscription status: ${status}`);
    });
  
  return channel;
}

// Fetch user management data from Supabase on startup
// ================= FIXED: Fetch user management data from Supabase =================
async function fetchUserManagementData() {
  console.log('ðŸ”„ Fetching user management data from Supabase...');
  
  try {
    // Make sure supabaseClient exists
    if (!supabaseClient) {
      console.error('âŒ Supabase client not initialized');
      return;
    }
    
    // 1. Fetch registration fields
    const { data: fieldsData, error: fieldsError } = await supabaseClient
      .from('registration_fields')
      .select('*')
      .order('created_at', { ascending: true });
    
    if (fieldsError) {
      console.error('âŒ Error fetching registration fields:', fieldsError);
    } else if (fieldsData) {
      console.log(`âœ… Loaded ${fieldsData.length} registration fields`);
      localStorage.setItem('ring0_data_framework', JSON.stringify(fieldsData));
    }
    
    // 2. Fetch users
    const { data: usersData, error: usersError } = await supabaseClient
      .from('users')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (usersError) {
      console.error('âŒ Error fetching users:', usersError);
    } else if (usersData) {
      console.log(`âœ… Loaded ${usersData.length} users`);
      localStorage.setItem('ring0_user_data', JSON.stringify(usersData));
    }
    
    // 3. Fetch groups
    const { data: groupsData, error: groupsError } = await supabaseClient
      .from('user_groups')
      .select('*')
      .order('created_at', { ascending: true });
    
    if (groupsError) {
      console.error('âŒ Error fetching groups:', groupsError);
    } else if (groupsData) {
      console.log(`âœ… Loaded ${groupsData.length} groups`);
      localStorage.setItem('ring0_user_groups', JSON.stringify(groupsData));
    }
    
    // 4. Fetch registration settings
    const { data: settingsData, error: settingsError } = await supabaseClient
      .from('registration_settings')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(1)
      .single();
    
    if (settingsError && settingsError.code !== 'PGRST116') {
      console.error('âŒ Error fetching registration settings:', settingsError);
    } else if (settingsData) {
      console.log('âœ… Loaded registration settings');
      localStorage.setItem('ring0_registration_settings', JSON.stringify(settingsData));
    }
    
    console.log('ðŸŽ‰ User management data loaded successfully!');
    
  } catch (error) {
    console.error('âŒ Error in fetchUserManagementData:', error);
  }
}

// Save registration field to Supabase
async function saveFieldToSupabase(field) {
  try {
    const { data, error } = await supabase
      .from('registration_fields')
      .insert([field]);
    
    if (error) {
      console.error('Error saving field to Supabase:', error);
      return false;
    }
    
    console.log('Field saved to Supabase:', data);
    return true;
  } catch (error) {
    console.error('Error in saveFieldToSupabase:', error);
    return false;
  }
}

// Save user to Supabase
async function saveUserToSupabase(user) {
  try {
    const { data, error } = await supabase
      .from('users')
      .insert([user]);
    
    if (error) {
      console.error('Error saving user to Supabase:', error);
      return false;
    }
    
    console.log('User saved to Supabase:', data);
    return true;
  } catch (error) {
    console.error('Error in saveUserToSupabase:', error);
    return false;
  }
}

// Save group to Supabase
async function saveGroupToSupabase(group) {
  try {
    const { data, error } = await supabase
      .from('user_groups')
      .insert([group]);
    
    if (error) {
      console.error('Error saving group to Supabase:', error);
      return false;
    }
    
    console.log('Group saved to Supabase:', data);
    return true;
  } catch (error) {
    console.error('Error in saveGroupToSupabase:', error);
    return false;
  }
}

// Update registration settings in Supabase
async function updateRegistrationSettingsInSupabase(settings) {
  try {
    // First check if settings exist
    const { data: existing } = await supabase
      .from('registration_settings')
      .select('id')
      .limit(1)
      .single();
    
    let result;
    if (existing) {
      // Update existing
      result = await supabase
        .from('registration_settings')
        .update(settings)
        .eq('id', existing.id);
    } else {
      // Insert new
      result = await supabase
        .from('registration_settings')
        .insert([settings]);
    }
    
    if (result.error) {
      console.error('Error updating registration settings:', result.error);
      return false;
    }
    
    console.log('Registration settings updated:', result.data);
    return true;
  } catch (error) {
    console.error('Error in updateRegistrationSettingsInSupabase:', error);
    return false;
  }
}

// Initialize user management system with real-time subscriptions
// ================= FIXED: Initialize user management system =================
function initUserManagementSystem() {
  console.log('ðŸš€ Initializing user management system...');
  
  // First, make sure Supabase is ready
  if (!supabaseClient) {
    console.error('âŒ Supabase client not available for user management');
    
    // Try to load from localStorage as fallback
    const savedData = localStorage.getItem('ring0_user_data');
    if (savedData) {
      console.log('âš ï¸ Using cached user data (offline mode)');
      userData = JSON.parse(savedData);
    }
    
    const savedGroups = localStorage.getItem('ring0_user_groups');
    if (savedGroups) {
      groups = JSON.parse(savedGroups);
    }
    
    return;
  }
  
  // Fetch initial data from Supabase
  fetchUserManagementData().then(() => {
    console.log('âœ… User management data loaded');
    
    // Subscribe to real-time changes
    const channels = [
      subscribeToRegistrationFields(),
      subscribeToUsers(),
      subscribeToGroups(),
      subscribeToRegistrationSettings()
    ];
    
    console.log(`âœ… ${channels.filter(c => c).length}/4 subscriptions active`);
    
  }).catch(error => {
    console.error('âŒ Failed to initialize user management:', error);
  });
  
  console.log('âœ… User management system initialized');
}

// Update the registration menu button based on settings
function updateRegistrationMenuButton() {
  const registrationEnabled = localStorage.getItem('ring0_registration_enabled') !== 'false';
  const button = document.querySelector('[onclick="toggleRegistrationMenu()"]');
  
  if (button) {
    if (registrationEnabled) {
      button.style.background = '#4CAF50';
      button.textContent = 'ðŸ“‹ Registration (Enabled)';
    } else {
      button.style.background = '#cccccc';
      button.textContent = 'ðŸ“‹ Registration (Disabled)';
    }
  }
}

// ================= ADMIN SECURITY SYSTEM =================
let zeroClickCount = 0;
let adminLoginVisible = false;
let generatedVerificationCode = '';
let adminEmail = '';

// Local SMS simulation system
class LocalSMSSender {
  constructor() {
    this.codes = new Map();
    this.storageKey = 'ring0_sms_codes';
    this.loadCodes();
  }

  loadCodes() {
    try {
      const saved = localStorage.getItem(this.storageKey);
      if (saved) {
        this.codes = new Map(JSON.parse(saved));
      }
    } catch (e) {
      console.warn('Could not load saved codes:', e);
    }
  }

  saveCodes() {
    try {
      localStorage.setItem(this.storageKey,
        JSON.stringify(Array.from(this.codes.entries())));
    } catch (e) {
      console.warn('Could not save codes:', e);
    }
  }

  sendCode(phoneNumber, code) {
    const timestamp = Date.now();
    const expiry = timestamp + (10 * 60 * 1000);

    this.codes.set(phoneNumber, {
      code: code,
      timestamp: timestamp,
      expiry: expiry,
      attempts: 0
    });

    this.saveCodes();

    return {
      success: true,
      message: `SMS simulation: Code ${code} "sent" to ${phoneNumber}`,
      code: code
    };
  }

  verifyCode(phoneNumber, code) {
    const record = this.codes.get(phoneNumber);

    if (!record) {
      return { valid: false, message: 'No code found for this number' };
    }

    if (Date.now() > record.expiry) {
      this.codes.delete(phoneNumber);
      this.saveCodes();
      return { valid: false, message: 'Code has expired' };
    }

    record.attempts++;

    if (record.code === code) {
      this.codes.delete(phoneNumber);
      this.saveCodes();
      return { valid: true, message: 'Code verified successfully' };
    }

    return {
      valid: false,
      message: `Invalid code. Attempts: ${record.attempts}/3`
    };
  }
}

// Initialize SMS sender
const smsSender = new LocalSMSSender();

// Track clicks on the "0" in RING-0
document.querySelector('.brand .zero').addEventListener('click', function() {
  zeroClickCount++;

  this.style.color = 'var(--accent)';

  setTimeout(() => {
    this.style.color = '#fff';
  }, 150);

  if (zeroClickCount === 3) {
    showTemporaryMessage('Keep going... 2 more clicks!', 'info');
  }

  if (zeroClickCount >= 5 && !adminLoginVisible) {
    unlockAdminLogin();
  }
});

let clickTimeout;
document.querySelector('.brand .zero').addEventListener('click', function() {
  clearTimeout(clickTimeout);
  clickTimeout = setTimeout(() => {
    if (zeroClickCount < 5) {
      zeroClickCount = 0;
      showTemporaryMessage('Sequence reset', 'warning');
    }
  }, 10000);
});





function handleAdminPanelDirectAccess() {
    // Check if this is an auto-return from properties (less than 2 minutes ago)
    const autoReturn = localStorage.getItem('ring0_auto_return') === 'true';
    const returnTimestamp = localStorage.getItem('ring0_return_timestamp');
    const isRecentReturn = returnTimestamp && (Date.now() - parseInt(returnTimestamp)) < (2 * 60 * 1000);
    
    if (autoReturn && isRecentReturn) {
        // Auto-return - open without checking login
        localStorage.removeItem('ring0_auto_return');
        localStorage.removeItem('ring0_return_timestamp');
        window.open('properties.html?admin=direct&source=index&autoReturn=true', '_blank');
        showTemporaryMessage('Returning to properties admin...', 'success');
        return;
    }
    
    // Check if admin is logged into main system
    const adminSession = localStorage.getItem('ring0_admin_login');
    let isMainAdminLoggedIn = false;
    let mainAdminEmail = '';

    if (adminSession) {
        try {
            const session = JSON.parse(adminSession);
            isMainAdminLoggedIn = session.loggedIn === true && 
                                 (Date.now() - session.timestamp) < (24 * 60 * 60 * 1000);
            if (session.email) {
                mainAdminEmail = session.email;
            }
        } catch(e) {
            isMainAdminLoggedIn = false;
        }
    }
    
    if (isMainAdminLoggedIn) {
        // Logged into main system - open properties admin directly
        window.open('properties.html?admin=direct&source=index', '_blank');
        showTemporaryMessage('Opening properties admin panel...', 'success');
    } else {
        // Not logged in - show login modal
        openAdminModal();
        showTemporaryMessage('Please login as admin first', 'info');
    }
}





function unlockAdminLogin() {
  adminLoginVisible = true;
  const adminLoginBtn = document.querySelector('nav button.admin-login');
  adminLoginBtn.classList.add('visible');
  
  showTemporaryMessage('Admin login unlocked!', 'success');
  
  adminLoginBtn.addEventListener('click', function() {
    openAdminModal();
  });
}

function showTemporaryMessage(message, type) {
  const messageDiv = document.createElement('div');
  messageDiv.textContent = message;
  messageDiv.style.cssText = `
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: ${type === 'success' ? 'rgba(53, 208, 127, 0.9)' : 
                type === 'warning' ? 'rgba(255, 107, 107, 0.9)' : 
                'rgba(91, 140, 255, 0.9)'};
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    z-index: 9999;
    font-weight: 600;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    animation: slideDown 0.3s ease;
  `;
  
  document.body.appendChild(messageDiv);
  
  setTimeout(() => {
    messageDiv.style.animation = 'slideUp 0.3s ease';
    setTimeout(() => {
      document.body.removeChild(messageDiv);
    }, 300);
  }, 3000);
}

// Add CSS animations for messages
const style = document.createElement('style');
style.textContent = `
  @keyframes slideDown {
    from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
    to { transform: translateX(-50%) translateY(0); opacity: 1; }
  }
  @keyframes slideUp {
    from { transform: translateX(-50%) translateY(0); opacity: 1; }
    to { transform: translateX(-50%) translateY(-20px); opacity: 0; }
  }
`;
document.head.appendChild(style);

// ================= ADMIN MODAL FUNCTIONS =================
function openAdminModal() {
  document.getElementById('adminModal').classList.add('active');
  resetAdminForm();
}

function closeAdminModal() {
  document.getElementById('adminModal').classList.remove('active');
  resetAdminForm();
}

function resetAdminForm() {
  goToStep(1);
  document.getElementById('adminPassword').value = '';
  document.getElementById('adminEmail').value = '';
  document.getElementById('verificationCode').value = '';
  clearErrors();
}

function goToStep(stepNumber) {
  document.querySelectorAll('.admin-modal-step').forEach(step => {
    step.classList.remove('active');
  });
  
  document.getElementById(`step${stepNumber}`).classList.add('active');
  clearErrors();
}

function clearErrors() {
  document.querySelectorAll('.admin-error-message').forEach(error => {
    error.classList.remove('show');
  });
  document.querySelectorAll('.admin-form-input').forEach(input => {
    input.classList.remove('error');
  });
  document.getElementById('emailSentMessage').classList.remove('show');
}

function verifyPassword() {
  const password = document.getElementById('adminPassword').value;
  const errorElement = document.getElementById('passwordError');
  
  // Define the allowed accounts
  const allowedAccounts = [
    { password: 'malo1818', email: 'malo.collective@gmail.com' },
    { password: 'hider-admin-2025', email: 'admin2025@gmail.com' }
  ];
  
  // Check if the password matches any allowed account
  const validAccount = allowedAccounts.find(account => account.password === password);
  
  if (validAccount) {
    goToStep(2);
    // Store the valid email for verification
    adminEmail = validAccount.email;
  } else {
    errorElement.textContent = 'Wrong password. Please try again.';
    errorElement.classList.add('show');
    document.getElementById('adminPassword').classList.add('error');
  }
}


function sendVerificationCode() {
  const emailInput = document.getElementById('adminEmail').value.trim();
  const errorElement = document.getElementById('emailError');

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  // Define the allowed accounts
  const allowedAccounts = [
    { password: 'malo1818', email: 'malo.collective@gmail.com' },
    { password: 'hider-admin-2025', email: 'admin2025@gmail.com' }
  ];

  // Check if email is valid and matches allowed accounts
  if (!emailRegex.test(emailInput)) {
    errorElement.textContent = 'Please enter a valid email address.';
    errorElement.classList.add('show');
    document.getElementById('adminEmail').classList.add('error');
    return;
  }

  // Check if email is in allowed accounts
  const validAccount = allowedAccounts.find(account => account.email === emailInput);
  
  if (!validAccount) {
    errorElement.textContent = 'This email is not authorized for admin access.';
    errorElement.classList.add('show');
    document.getElementById('adminEmail').classList.add('error');
    return;
  }

  // Check if the email matches the password that was entered earlier
  // (We stored adminEmail from verifyPassword)
  if (adminEmail && adminEmail !== emailInput) {
    errorElement.textContent = 'Email does not match the account credentials.';
    errorElement.classList.add('show');
    document.getElementById('adminEmail').classList.add('error');
    return;
  }

  adminEmail = emailInput;

  generatedVerificationCode = Math.floor(100 + Math.random() * 900).toString();

  const sendBtn = document.querySelector('#step2 .admin-modal-btn.primary');
  const originalText = sendBtn.textContent;
  sendBtn.textContent = 'Sending...';
  sendBtn.disabled = true;

  setTimeout(() => {
    const result = smsSender.sendCode(emailInput, generatedVerificationCode);

    console.log(result.message);

    const codeDisplay = document.createElement('div');
    codeDisplay.id = 'smsCodeDisplay';
    codeDisplay.style.cssText = `
      background: rgba(12, 16, 36, 0.95);
      border: 2px solid var(--accent);
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
      text-align: center;
    `;

    codeDisplay.innerHTML = `
      <div style="color: var(--accent); font-weight: bold; margin-bottom: 10px;">
         Local SMS Simulation
      </div>
      <div style="margin-bottom: 15px; font-size: 0.9rem; color: var(--muted);">
        Code "sent" to: ${emailInput}
      </div>
      <div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; margin: 10px 0;">
        <div style="font-size: 0.85rem; color: var(--muted);">Your verification code:</div>
        <div style="font-family: monospace; font-size: 2rem; font-weight: bold; color: var(--success); letter-spacing: 5px;">
          ${generatedVerificationCode}
        </div>
      </div>
      <div style="font-size: 0.8rem; color: var(--warning); margin-top: 10px;">
        âš ï¸ Local system: Code stored in browser. Valid for 10 minutes.
      </div>
    `;

    const formGroup = document.querySelector('#step2 .admin-form-group');
    formGroup.parentNode.insertBefore(codeDisplay, formGroup.nextSibling);

    document.getElementById('emailSentMessage').classList.add('show');
    document.getElementById('emailSentMessage').textContent =
      'Verification code generated. Enter it below to continue.';

    setTimeout(() => {
      const display = document.getElementById('smsCodeDisplay');
      if (display) display.remove();

      goToStep(3);
      sendBtn.textContent = originalText;
      sendBtn.disabled = false;
    }, 3000);

  }, 1500);
}

function verifyCode() {
  const enteredCode = document.getElementById('verificationCode').value;
  const errorElement = document.getElementById('codeError');

  // Define the allowed accounts (for final validation)
  const allowedAccounts = [
    { password: 'malo1818', email: 'malo.collective@gmail.com' },
    { password: 'hider-admin-2025', email: 'admin2025@gmail.com' }
  ];

  if (enteredCode === generatedVerificationCode) {
    // Ensure adminEmail is saved from the input field
    if (!adminEmail) {
      adminEmail = document.getElementById('adminEmail').value.trim();
    }

    // Final validation - check if email is in allowed accounts
    const isValidAccount = allowedAccounts.some(account => account.email === adminEmail);
    
    if (isValidAccount) {
      loginAdmin();
    } else {
      errorElement.textContent = 'Unauthorized account. Access denied.';
      errorElement.classList.add('show');
      document.getElementById('verificationCode').classList.add('error');
    }
  } else {
    errorElement.textContent = 'Invalid verification code. Please try again.';
    errorElement.classList.add('show');
    document.getElementById('verificationCode').classList.add('error');
  }
}

// Debug function to check email status
function debugEmailStatus() {
  console.log('=== EMAIL STATUS DEBUG ===');
  console.log('adminEmail variable:', adminEmail);
  console.log('Email input value:', document.getElementById('adminEmail')?.value);
  console.log('LocalStorage ring0_admin_login:', localStorage.getItem('ring0_admin_login'));
  console.log('LocalStorage ring0_admin_auth:', localStorage.getItem('ring0_admin_auth'));
  console.log('LocalStorage ring0_admin_verified:', localStorage.getItem('ring0_admin_verified'));
  console.log('==========================');
}

// Add this after the admin logout button in the admin dashboard section
function addDebugButton() {
  const debugBtn = document.createElement('button');
    debugBtn.onclick = debugEmailStatus;

  const adminHeader = document.querySelector('.admin-header');
  if (adminHeader) {
    adminHeader.appendChild(debugBtn);
  }
}


























// ================= CARD MANAGEMENT SYSTEM =================
let allPosts = [];
let cardToDelete = null;
let cardToEdit = null;

const defaultPosts = [
  {
    id: 1,
    title: "Project Submission",
    description: "Final upload",
    fileUrl: "#",
    start: "2025-12-01T09:00:00",
    end: "2025-12-25T23:59:59",
    status: "active",
    createdAt: "2025-01-01T00:00:00",
    createdBy: "system"
  },
  {
    id: 2,
    title: "Event Launch",
    description: "Public release",
    fileUrl: "#",
    start: "2025-12-10T00:00:00",
    end: "2026-01-01T00:00:00",
    status: "active",
    createdAt: "2025-01-01T00:00:00",
    createdBy: "system"
  },
  {
    id: 3,
    title: "Training",
    description: "Learning phase",
    fileUrl: "#",
    start: "2025-11-20T08:00:00",
    end: "2025-12-20T18:00:00",
    status: "active",
    createdAt: "2025-01-01T00:00:00",
    createdBy: "system"
  }
];

function setupDateTimeInputs() {
  const now = new Date();
  const tomorrow = new Date(now);
  tomorrow.setDate(tomorrow.getDate() + 1);

  const defaultEndDate = String(tomorrow.getFullYear()).padStart(4,'0') + '-' + 
                        String(tomorrow.getMonth()+1).padStart(2,'0') + '-' + 
                        String(tomorrow.getDate()).padStart(2,'0');
  const defaultEndTime = String(tomorrow.getHours()).padStart(2,'0') + ':' + 
                        String(tomorrow.getMinutes()).padStart(2,'0');
  const endDateEl = document.getElementById('cardEndDate');
  const endTimeEl = document.getElementById('cardEndTime');
  if (endDateEl) endDateEl.value = defaultEndDate;
  if (endTimeEl) endTimeEl.value = defaultEndTime;
}

function setDateTime(type, preset, hour = 9, minute = 0) {
  const now = new Date();
  let targetDate = new Date();

  switch(preset) {
    case 'today':
      targetDate.setHours(hour, minute, 0, 0);
      break;
    case '+1':
      targetDate.setDate(targetDate.getDate() + 1);
      targetDate.setHours(hour, minute, 0, 0);
      break;
    case 'week':
      if (type === 'both') {
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + 7);
        endDate.setHours(18, 0, 0, 0);
        document.getElementById('cardEndDate').value = `${endDate.getFullYear()}-${String(endDate.getMonth()+1).padStart(2,'0')}-${String(endDate.getDate()).padStart(2,'0')}`;
        document.getElementById('cardEndTime').value = `${String(endDate.getHours()).padStart(2,'0')}:${String(endDate.getMinutes()).padStart(2,'0')}`;
        return;
      }
      targetDate.setDate(targetDate.getDate() + 7);
      targetDate.setHours(hour, minute, 0, 0);
      break;
    case 'now':
      targetDate = now;
      targetDate.setMinutes(Math.ceil(targetDate.getMinutes() / 5) * 5);
      break;
  }

  const formatted = formatForInput(targetDate);
  const parts = formatted.split('T');
  const datePart = parts[0];
  const timePart = parts[1];

  if (type === 'end' || type === 'both') {
    const dateEl = document.getElementById('cardEndDate');
    const timeEl = document.getElementById('cardEndTime');
    if (dateEl) dateEl.value = datePart;
    if (timeEl) timeEl.value = timePart;
  }
}

function formatForInput(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${year}-${month}-${day}T${hours}:${minutes}`;
}

function initializeDashboard() {
  loadCardsFromStorage();
  renderActiveCards();
  renderCancelledCards();

  const form = document.getElementById('createCardForm');
  const newForm = form.cloneNode(true);
  form.parentNode.replaceChild(newForm, form);

  document.getElementById('createCardForm').addEventListener('submit', function(e) {
    e.preventDefault();
    e.stopPropagation();

    if (cardToEdit) {
      updateCard();
    } else {
      createCard();
    }
    return false;
  });

  setupDateTimeInputs();
}

function formatDateTimeLocal(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  
  return `${year}-${month}-${day}T${hours}:${minutes}`;
}

function switchTab(tabId) {
  document.querySelectorAll('.admin-tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  document.querySelectorAll('.admin-tab').forEach(button => {
    button.classList.remove('active');
  });
  
  document.getElementById(tabId).classList.add('active');
  
  document.querySelector(`.admin-tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
}

function createCard() {
  const title = document.getElementById('cardTitle').value.trim();
  const description = document.getElementById('cardDescription').value.trim();
  const fileUrl = document.getElementById('cardFileUrl').value.trim();
  const startTime = formatForInput(new Date());

  const endDateVal = document.getElementById('cardEndDate') ? document.getElementById('cardEndDate').value : '';
  let endTimeVal = document.getElementById('cardEndTime') ? document.getElementById('cardEndTime').value : '';

  if (endTimeVal && /[ap]m/i.test(endTimeVal)) {
    const parsed = new Date(endDateVal + ' ' + endTimeVal);
    if (!isNaN(parsed)) {
      endTimeVal = String(parsed.getHours()).padStart(2,'0') + ':' + String(parsed.getMinutes()).padStart(2,'0');
    } else {
      endTimeVal = null;
    }
  }

  const endTime = endDateVal && endTimeVal ? `${endDateVal}T${endTimeVal}` : null;

  console.log('Creating card with data:', { title, description, fileUrl, startTime, endTime });

  if (!title || !description || !fileUrl || !startTime || !endTime) {
    showTemporaryMessage('Please fill in all fields', 'warning');
    return false;
  }

  const startDate = new Date(startTime);
  const endDate = new Date(endTime);

  if (endDate <= startDate) {
    showTemporaryMessage('End time must be after start time', 'warning');
    return;
  }

  // Create card object
  const newCard = {
    title: title,
    description: description,
    file_url: fileUrl,
    start_time: startDate.toISOString(),
    end_time: endDate.toISOString(),
    status: 'active',
    created_by: 'admin'
  };

  console.log('New card created locally:', newCard);

  // FIRST: Save to Supabase
  if (typeof saveCardToSupabase === 'function') {
    saveCardToSupabase(newCard).then(success => {
      if (success) {
        // The realtime subscription will automatically update allPosts
        // and trigger UI update via subscribeToCards()
        showTemporaryMessage(`"${title}" card created and synced to all devices!`, 'success');
      } else {
        // Fallback: Save locally only
        newCard.id = Date.now();
        allPosts.push(newCard);
        saveCardsToStorage();
        renderActiveCards();
        update();
        showTemporaryMessage(`"${title}" card created (local only - sync failed)`, 'warning');
      }
    });
  } else {
    // Fallback if Supabase functions not loaded
    newCard.id = Date.now();
    allPosts.push(newCard);
    saveCardsToStorage();
    renderActiveCards();
    update();
    showTemporaryMessage(`"${title}" card created`, 'success');
  }

  resetCardForm();

  setTimeout(() => {
    switchTab('manage-cards');
  }, 500);

  return true;
}

function updateCard() {
  if (!cardToEdit) return;
  
  const title = document.getElementById('cardTitle').value.trim();
  const description = document.getElementById('cardDescription').value.trim();
  const fileUrl = document.getElementById('cardFileUrl').value.trim();
  const endTime = document.getElementById('cardEndTime').value;

  if (!title || !description || !fileUrl || !endTime) {
    showTemporaryMessage('Please fill in all fields', 'warning');
    return;
  }
  const startDate = new Date(cardToEdit.start);
  const endDateInput = document.getElementById('cardEndDate') ? document.getElementById('cardEndDate').value : '';
  const endTimeInput = document.getElementById('cardEndTime') ? document.getElementById('cardEndTime').value : '';
  const endDate = new Date(endDateInput && endTimeInput ? `${endDateInput}T${endTimeInput}` : endTime);

  if (endDate <= startDate) {
    showTemporaryMessage('End time must be after start time', 'warning');
    return;
  }
  
  const cardIndex = allPosts.findIndex(card => card.id === cardToEdit.id);
  if (cardIndex !== -1) {
    allPosts[cardIndex] = {
      ...allPosts[cardIndex],
      title: title,
      description: description,
      fileUrl: fileUrl,
      start: startDate.toISOString(),
      end: endDate.toISOString(),
      updatedAt: new Date().toISOString()
    };
    
    saveCardsToStorage();
    renderActiveCards();
    
    showTemporaryMessage('Card updated successfully!', 'success');
  }
  
  resetCardForm();
  switchTab('manage-cards');
}

function resetCardForm() {
  document.getElementById('cardTitle').value = '';
  document.getElementById('cardDescription').value = '';
  document.getElementById('cardFileUrl').value = '';

  setupDateTimeInputs();

  cardToEdit = null;

  const submitBtn = document.getElementById('cardSubmitBtn');
  submitBtn.textContent = 'Create Card';
}

function loadCardsFromStorage() {
  try {
    const savedCards = localStorage.getItem('ring0_admin_cards');
    if (savedCards) {
      allPosts = JSON.parse(savedCards);
    } else {
      allPosts = [...defaultPosts];
      saveCardsToStorage();
    }
  } catch (e) {
    console.warn('Could not load cards from storage:', e);
    allPosts = [...defaultPosts];
  }
}

function saveCardsToStorage() {
  try {
    localStorage.setItem('ring0_admin_cards', JSON.stringify(allPosts));

    if (typeof update === 'function') {
      update();
    }
  } catch (e) {
    console.warn('Could not save cards to storage:', e);
    showTemporaryMessage('Error saving card. Please try again.', 'warning');
  }
}

function renderActiveCards() {
  const container = document.getElementById('activeCardsContainer');
  const activeCards = allPosts.filter(card => card.status !== 'cancelled');
  
  container.innerHTML = '';
  
  if (activeCards.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
          <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;">ðŸ“‹</div>
          <h3 style="color: var(--accent); margin-bottom: 10px;">No Active Cards</h3>
          <p>Create your first countdown card in the "Create New Card" tab.</p>
          <button class="admin-modal-btn secondary" onclick="switchTab('create-card')" style="margin-top: 20px;">
            Create New Card
          </button>
        </div>
      </div>
    `;
    return;
  }
  
  // Helper function to format date from Supabase
  const formatDateTime24 = (dateString) => {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}`;
  };

  activeCards.forEach(card => {
    const cardElement = document.createElement('div');
    cardElement.className = 'admin-card';
    
    // Use Supabase field names (start_time, end_time, file_url)
    // OR fallback to old names (start, end, fileUrl)
    const startTime = card.start_time || card.start;
    const endTime = card.end_time || card.end;
    const fileUrl = card.file_url || card.fileUrl;
    const cardId = card.id;
    
    cardElement.innerHTML = `
      <div class="admin-card-header">
        <div class="admin-card-title-section">
          <h4>${card.title}</h4>
          <div class="admin-card-meta">${card.description}</div>
        </div>
        <div class="admin-card-status status-active">Active</div>
      </div>
      
      <div class="admin-card-time-info">
        <div class="time-row">
          <span class="time-label">Start Time</span>
          <span class="time-value">${formatDateTime24(startTime)}</span>
        </div>
        <div class="time-row">
          <span class="time-label">End Time</span>
          <span class="time-value">${formatDateTime24(endTime)}</span>
        </div>
      </div>
      
      <div class="admin-card-url-section">
        <div class="url-label">Document URL</div>
        <a href="${fileUrl}" target="_blank" class="url-value" title="${fileUrl}">
          ${fileUrl.length > 50 ? fileUrl.substring(0, 50) + '...' : fileUrl}
        </a>
      </div>
      
      <div class="admin-card-actions">
        <button class="admin-card-btn edit" onclick="editCard('${cardId}')">
          <span>âœï¸</span> Edit
        </button>
        <button class="admin-card-btn cancel" onclick="cancelCard('${cardId}')">
          <span>â¸ï¸</span> Cancel
        </button>
        <button class="admin-card-btn delete" onclick="openDeleteModal('${cardId}')">
          <span>ðŸ—‘ï¸</span> Delete
        </button>
      </div>
    `;
    container.appendChild(cardElement);
  });
}

function renderCancelledCards() {
  const container = document.getElementById('cancelledCardsContainer');
  const cancelledCards = allPosts.filter(card => card.status === 'cancelled');
  
  container.innerHTML = '';
  
  if (cancelledCards.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
          <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;">ðŸ“„</div>
          <h3 style="color: var(--warning); margin-bottom: 10px;">No Cancelled Cards</h3>
          <p>All cards are currently active. Cancelled cards will appear here.</p>
        </div>
      </div>
    `;
    return;
  }
  
  const formatDateTime24 = (dateString) => {
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}`;
  };
  
  cancelledCards.forEach(card => {
    const cardElement = document.createElement('div');
    cardElement.className = 'admin-card cancelled';
    
    cardElement.innerHTML = `
      <div class="admin-card-header">
        <div class="admin-card-title-section">
          <h4>${card.title}</h4>
          <div class="admin-card-meta">${card.description}</div>
        </div>
        <div class="admin-card-status status-cancelled">Cancelled</div>
      </div>
      
      <div class="admin-card-time-info">
        <div class="time-row">
          <span class="time-label">Start Time</span>
          <span class="time-value">${formatDateTime24(card.start)}</span>
        </div>
        <div class="time-row">
          <span class="time-label">End Time</span>
          <span class="time-value">${formatDateTime24(card.end)}</span>
        </div>
      </div>
      
      <div class="admin-card-url-section">
        <div class="url-label">Document URL</div>
        <a href="${card.fileUrl}" target="_blank" class="url-value" title="${card.fileUrl}">
          ${card.fileUrl.length > 50 ? card.fileUrl.substring(0, 50) + '...' : card.fileUrl}
        </a>
      </div>
      
      <div class="admin-card-actions">
        <button class="admin-card-btn restore" onclick="restoreCard('${card.id}')">
          <span>â†»</span> Restore
        </button>
        <button class="admin-card-btn delete" onclick="openDeleteModal('${card.id}')">
          <span>ðŸ—‘ï¸</span> Delete
        </button>
      </div>
    `;
    container.appendChild(cardElement);
  });
}

function editCard(cardId) {
  // Handle both string and numeric IDs
  const card = allPosts.find(c => String(c.id) === String(cardId));
  if (!card) {
    console.error('Card not found:', cardId);
    return;
  }
  
  cardToEdit = card;
  
  document.getElementById('cardTitle').value = card.title;
  document.getElementById('cardDescription').value = card.description;
  document.getElementById('cardFileUrl').value = card.file_url || card.fileUrl || '';
  
  // Use Supabase field names OR fallback
  const startTime = card.start_time || card.start;
  const endTime = card.end_time || card.end;
  
  if (document.getElementById('cardEndDate') && document.getElementById('cardEndTime')) {
    const d = new Date(endTime);
    if (!isNaN(d.getTime())) {
      document.getElementById('cardEndDate').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      document.getElementById('cardEndTime').value = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }
  }
  
  const submitBtn = document.getElementById('cardSubmitBtn');
  submitBtn.textContent = 'Update Card';
  console.log('ðŸ“ Editing card:', card.id, card.title);
  
  switchTab('create-card');
}

async function cancelCard(cardId) {
  const card = allPosts.find(c => String(c.id) === String(cardId));
  if (!card) {
    console.error('Card not found for cancellation:', cardId);
    return;
  }
  
  // Show loading message
  showTemporaryMessage('Cancelling card...', 'info');
  
  try {
    // 1. Update Supabase FIRST (source of truth)
    const { error } = await supabaseClient
      .from('countdown_cards')
      .update({ 
        status: 'cancelled',
        cancelled_at: new Date().toISOString()
      })
      .eq('id', card.id);
    
    if (error) throw error;
    
    // 2. Update local array
    const cardIndex = allPosts.findIndex(c => String(c.id) === String(cardId));
    allPosts[cardIndex].status = 'cancelled';
    allPosts[cardIndex].cancelledAt = new Date().toISOString();
    
    // 3. Save to localStorage (as cache only)
    saveCardsToStorage();
    
    // 4. Update UI
    renderActiveCards();
    renderCancelledCards();
    
    // Success message
    showTemporaryMessage(`"${card.title}" cancelled on all devices!`, 'success');
    
  } catch (error) {
    console.error('Failed to cancel card:', error);
    showTemporaryMessage('Failed to cancel. Working offline?', 'warning');
  }
}

function restoreCard(cardId) {
  const cardIndex = allPosts.findIndex(card => String(card.id) === String(cardId));
  if (cardIndex === -1) {
    console.error('Card not found for restoration:', cardId);
    return;
  }
  
  allPosts[cardIndex].status = 'active';
  delete allPosts[cardIndex].cancelledAt;
  
  saveCardsToStorage();
  renderActiveCards();
  renderCancelledCards();
  
  showTemporaryMessage('Card restored to active status.', 'success');
}

function openDeleteModal(cardId) {
  cardToDelete = cardId;
  const card = allPosts.find(c => String(c.id) === String(cardId));
  
  if (card) {
    document.getElementById('deleteModalMessage').textContent = 
      `Are you sure you want to delete "${card.title}"? This action cannot be undone.`;
  } else {
    console.error('Card not found for deletion:', cardId);
    document.getElementById('deleteModalMessage').textContent = 
      'Are you sure you want to delete this card? This action cannot be undone.';
  }
  
  document.getElementById('deleteModal').classList.add('active');
}

function closeDeleteModal() {
  document.getElementById('deleteModal').classList.remove('active');
  cardToDelete = null;
}

async function confirmDelete() {
  if (!cardToDelete) {
    closeDeleteModal();
    return;
  }
  
  const card = allPosts.find(c => String(c.id) === String(cardToDelete));
  if (!card) {
    closeDeleteModal();
    return;
  }
  
  try {
    // 1. Delete from Supabase FIRST
    const { error } = await supabaseClient
      .from('countdown_cards')
      .delete()
      .eq('id', card.id);
    
    if (error) throw error;
    
    // 2. Remove from local array
    const cardIndex = allPosts.findIndex(c => String(c.id) === String(cardToDelete));
    if (cardIndex !== -1) {
      allPosts.splice(cardIndex, 1);
      saveCardsToStorage();
      renderActiveCards();
      renderCancelledCards();
    }
    
    showTemporaryMessage(`"${card.title}" permanently deleted from all devices!`, 'success');
    
  } catch (error) {
    console.error('Failed to delete:', error);
    showTemporaryMessage('Delete failed. Please try again.', 'warning');
  }
  
  closeDeleteModal();
}

function loginAdmin() {
  closeAdminModal();
  document.getElementById('adminDashboard').classList.add('active');

  document.getElementById('dashboardMenu').style.display = 'block';

  document.querySelectorAll('.admin-management-section').forEach(section => {
    section.style.display = 'none';
  });

  // === CRITICAL FIX: Ensure email is captured ===
  // If adminEmail is not set from verification, get it from the input field
  if (!adminEmail || adminEmail.trim() === '') {
    adminEmail = document.getElementById('adminEmail').value.trim();
    console.log('Admin email retrieved from input:', adminEmail);
  }

  // Ensure we have a valid email
  if (!adminEmail || adminEmail.trim() === '') {
    console.error('No admin email found!');
    showTemporaryMessage('Error: No email provided. Please enter your admin email.', 'warning');
    return;
  }

  const adminSession = {
    email: adminEmail,
    loggedIn: true,
    timestamp: Date.now()
  };

  // Store for main page use
  localStorage.setItem('ring0_admin_login', JSON.stringify(adminSession));

  // Also store for user management verification
  localStorage.setItem('ring0_admin_auth', JSON.stringify({
    email: adminEmail,
    timestamp: Date.now()
  }));

  // Store a flag that user management can check
  localStorage.setItem('ring0_admin_verified', JSON.stringify({
    email: adminEmail,
    verified: true,
    timestamp: Date.now()
  }));

  console.log('Admin login successful. Session saved for email:', adminEmail);

  showTemporaryMessage('Admin login successful! Welcome to Dashboard.', 'success');

  // Add debug button for troubleshooting
  addDebugButton();
}

function logoutAdmin() {
  document.getElementById('adminDashboard').classList.remove('active');

  document.getElementById('dashboardMenu').style.display = 'block';
  document.querySelectorAll('.admin-management-section').forEach(section => {
    section.style.display = 'none';
  });

  showTemporaryMessage('Admin logged out successfully.', 'info');
}


















// ================= USER MANAGEMENT SYSTEM =================
let userData = [];
let dataFramework = [];
let groups = [];
let currentCaseUserId = null;

// Default data framework
const defaultFramework = [
  { name: 'Full Name', type: 'text', required: 'yes', order: 1 },
  { name: 'Registration Number', type: 'text', required: 'yes', order: 2 },
  { name: 'Phone Number', type: 'phone', required: 'yes', order: 3 }
];

// Default user data
const defaultUsers = [
  { id: 1, name: 'John Doe', regNo: 'REG001', phone: '+1234567890', email: 'john@example.com', group: 'A', status: 'active', caseInfo: '' },
  { id: 2, name: 'Jane Smith', regNo: 'REG002', phone: '+1234567891', email: 'jane@example.com', group: 'B', status: 'active', caseInfo: '' },
  { id: 3, name: 'Bob Johnson', regNo: 'REG003', phone: '+1234567892', email: 'bob@example.com', group: 'A', status: 'flagged', caseInfo: 'Late payment - Contacted on 2025-01-15' },
  { id: 4, name: 'Alice Brown', regNo: 'REG004', phone: '+1234567893', email: 'alice@example.com', group: 'C', status: 'inactive', caseInfo: '' }
];

// Default groups
const defaultGroups = [
  { id: 1, name: 'Group A', size: 10, members: [1, 3] },
  { id: 2, name: 'Group B', size: 10, members: [2] },
  { id: 3, name: 'Group C', size: 10, members: [4] }
];

// Open User Management
function openUserManagement() {
  document.getElementById('dashboardMenu').style.display = 'none';
  document.getElementById('userManagementSection').style.display = 'block';
  initializeUserManagement();
}

// Switch between user management tabs
function switchUserTab(tabId) {
  // Get all user management content sections
  const userContents = document.querySelectorAll('.user-management-content');
  userContents.forEach(content => {
    content.classList.remove('active');
  });

  // Get all user management tab buttons
  const userTabs = document.querySelectorAll('.user-management-tab');
  userTabs.forEach(tab => {
    tab.classList.remove('active');
  });

  // Show the selected tab content
  const selectedTab = document.getElementById(tabId + 'Tab');
  if (selectedTab) {
    selectedTab.classList.add('active');
  }

  // Activate the clicked tab button
  const clickedTab = event.target;
  clickedTab.classList.add('active');

  // Initialize registration settings UI when settings tab is opened
  // ONLY if it hasn't been initialized yet
  if (tabId === 'settings') {
    const settingsTab = document.getElementById('settingsTab');
    // Check if the registration-mode-container already exists
    const hasRegistrationUI = settingsTab.querySelector('.registration-mode-container');
    if (!hasRegistrationUI) {
      updateRegistrationSettingsUI();
    }
  }
}

// Initialize User Management
function initializeUserManagement() {
  loadDataFramework();
  loadUserData();
  loadGroups();
  updateRegistrationSwitch();
  
  // Update framework preview
  updateFrameworkPreview();
  generateRegistrationFormPreview();
  
  // Load users into table
  populateUserTable();
  
  // Load groups display
  populateGroups();
  
  // Set up event listeners
  const registrationSwitch = document.getElementById('registrationSwitch');
  if (registrationSwitch) {
    registrationSwitch.addEventListener('change', updateRegistrationVisibility);
  }
  
  const addUserForm = document.getElementById('addUserForm');
  if (addUserForm) {
    addUserForm.addEventListener('submit', handleAddUser);
  }
  
  const editUserForm = document.getElementById('editUserForm');
  if (editUserForm) {
    editUserForm.addEventListener('submit', handleEditUser);
  }
}

// ================= DATA FRAMEWORK MANAGEMENT =================
function loadDataFramework() {
  const savedFramework = localStorage.getItem('ring0_data_framework');
  if (savedFramework) {
    dataFramework = JSON.parse(savedFramework);
  } else {
    dataFramework = [...defaultFramework];
    saveDataFramework();
  }
}

function saveDataFramework() {
  localStorage.setItem('ring0_data_framework', JSON.stringify(dataFramework));
  updateFrameworkPreview();
  generateRegistrationFormPreview();
}

function addField() {
  const name = document.getElementById('fieldName').value.trim();
  const type = document.getElementById('fieldType').value;
  const required = document.getElementById('fieldRequired').value;
  
  if (!name) {
    alert('Please enter a field name');
    return;
  }
  
  const newField = {
    name: name,
    type: type,
    required: required,
    order: dataFramework.length + 1,
    created_at: new Date().toISOString()
  };
  
  dataFramework.push(newField);
  saveDataFramework();
  
  // Save to Supabase for real-time sync
  saveFieldToSupabase(newField);
  
  // Clear inputs
  document.getElementById('fieldName').value = '';
  document.getElementById('fieldType').value = 'text';
  document.getElementById('fieldRequired').value = 'yes';
}

function updateFrameworkPreview() {
  const tbody = document.getElementById('frameworkFields');
  tbody.innerHTML = '';
  
  dataFramework.forEach((field, index) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${field.name}</td>
      <td>${field.type}</td>
      <td>${field.required === 'yes' ? 'âœ“ Required' : 'Optional'}</td>
      <td>
        <button class="user-action-btn user-action-edit-btn" onclick="editField(${index})">Edit</button>
        <button class="user-action-btn user-action-delete-btn" onclick="removeField(${index})">Remove</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function editField(index) {
  const field = dataFramework[index];
  document.getElementById('fieldName').value = field.name;
  document.getElementById('fieldType').value = field.type;
  document.getElementById('fieldRequired').value = field.required;
  
  // Remove the field
  dataFramework.splice(index, 1);
  saveDataFramework();
}

function removeField(index) {
  if (confirm('Are you sure you want to remove this field?')) {
    dataFramework.splice(index, 1);
    saveDataFramework();
  }
}

function resetFramework() {
  if (confirm('Are you sure you want to reset the framework? All existing user data will be affected.')) {
    dataFramework = [...defaultFramework];
    saveDataFramework();
  }
}

function generateRegistrationFormPreview() {
  const preview = document.getElementById('registrationFormPreview');
  let html = '';
  
  dataFramework.forEach(field => {
    html += `
      <div class="form-group" style="margin-bottom: 15px;">
        <label class="form-label" style="display: block; margin-bottom: 5px; color: var(--text);">${field.name} ${field.required === 'yes' ? '<span style="color: var(--warning);">*</span>' : ''}</label>
        ${getFieldInputHTML(field)}
      </div>
    `;
  });
  
  html += '<button class="form-btn primary" style="margin-top: 20px;">Submit Registration</button>';
  
  preview.innerHTML = html;
}

function getFieldInputHTML(field) {
  switch(field.type) {
    case 'text':
    case 'email':
    case 'phone':
    case 'number':
      return `<input type="${field.type}" class="form-input" placeholder="Enter ${field.name.toLowerCase()}" ${field.required === 'yes' ? 'required' : ''} style="width: 100%;">`;
    case 'date':
      return `<input type="date" class="form-input" ${field.required === 'yes' ? 'required' : ''} style="width: 100%;">`;
    case 'select':
      return `
        <select class="form-select" ${field.required === 'yes' ? 'required' : ''} style="width: 100%;">
          <option value="">Select ${field.name}</option>
          <option value="option1">Option 1</option>
          <option value="option2">Option 2</option>
          <option value="option3">Option 3</option>
        </select>
      `;
    default:
      return `<input type="text" class="form-input" placeholder="Enter ${field.name.toLowerCase()}" ${field.required === 'yes' ? 'required' : ''} style="width: 100%;">`;
  }
}

// ================= USER MANAGEMENT =================
function loadUserData() {
  const savedUsers = localStorage.getItem('ring0_user_data');
  if (savedUsers) {
    userData = JSON.parse(savedUsers);
  } else {
    userData = [...defaultUsers];
    saveUserData();
  }
}

function saveUserData() {
  localStorage.setItem('ring0_user_data', JSON.stringify(userData));
}

function populateUserTable() {
  const tbody = document.getElementById('userTableBody');
  tbody.innerHTML = '';
  
  if (userData.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="user-empty-state">
          <div class="user-empty-icon">ðŸ‘¤</div>
          <h3>No Users Found</h3>
          <p>Add your first user using the "Add New User" button.</p>
        </td>
      </tr>
    `;
    return;
  }
  
  userData.forEach(user => {
    const row = document.createElement('tr');
    if (user.status === 'flagged') {
      row.classList.add('red-flag');
    }
    
    row.innerHTML = `
      <td>${user.name}</td>
      <td>${user.regNo}</td>
      <td>${user.phone}</td>
      <td>${user.email || 'N/A'}</td>
      <td>${user.group ? user.group.replace('Group ', '').trim() : 'Not assigned'}</td>
      <td>
        <span class="user-status-badge user-status-${user.status}">
          ${user.status.charAt(0).toUpperCase() + user.status.slice(1)}
        </span>
        ${user.caseInfo ? '<button class="user-action-flag-btn" onclick="showCaseInfo(' + user.id + ')">View Case</button>' : ''}
      </td>
      <td>
        <div class="user-action-buttons">
          <button class="user-action-btn user-action-edit-btn" onclick="openEditUserModal(${user.id})">Edit</button>
          <button class="user-action-btn user-action-delete-btn" onclick="deleteUser(${user.id})">Delete</button>
          ${user.status !== 'flagged' ? '<button class="user-action-flag-btn" onclick="openCaseModal(' + user.id + ')">Flag</button>' : '<button class="user-action-flag-btn" onclick="unflagUser(' + user.id + ')">Unflag</button>'}
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function searchUsers() {
  const searchTerm = document.getElementById('userSearch').value.toLowerCase();
  const filteredUsers = userData.filter(user => 
    user.name.toLowerCase().includes(searchTerm) ||
    user.regNo.toLowerCase().includes(searchTerm) ||
    (user.email && user.email.toLowerCase().includes(searchTerm)) ||
    (user.phone && user.phone.includes(searchTerm))
  );
  
  updateTableWithFilteredUsers(filteredUsers);
}

function filterUsers() {
  const status = document.getElementById('statusFilter').value;
  
  if (status === 'all') {
    populateUserTable();
    return;
  }
  
  const filteredUsers = userData.filter(user => user.status === status);
  updateTableWithFilteredUsers(filteredUsers);
}

function updateTableWithFilteredUsers(filteredUsers) {
  const tbody = document.getElementById('userTableBody');
  tbody.innerHTML = '';
  
  if (filteredUsers.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align: center; padding: 40px; color: var(--muted);">
          No users found matching your criteria.
        </td>
      </tr>
    `;
    return;
  }
  
  filteredUsers.forEach(user => {
    const row = document.createElement('tr');
    if (user.status === 'flagged') {
      row.classList.add('red-flag');
    }
    
    row.innerHTML = `
      <td>${user.name}</td>
      <td>${user.regNo}</td>
      <td>${user.phone}</td>
      <td>${user.email || 'N/A'}</td>
      <td>${user.group ? user.group.replace('Group ', '').trim() : 'Not assigned'}</td>
      <td>
        <span class="user-status-badge user-status-${user.status}">
          ${user.status.charAt(0).toUpperCase() + user.status.slice(1)}
        </span>
        ${user.caseInfo ? '<button class="user-action-flag-btn" onclick="showCaseInfo(' + user.id + ')">View Case</button>' : ''}
      </td>
      <td>
        <div class="user-action-buttons">
          <button class="user-action-btn user-action-edit-btn" onclick="openEditUserModal(${user.id})">Edit</button>
          <button class="user-action-btn user-action-delete-btn" onclick="deleteUser(${user.id})">Delete</button>
          ${user.status !== 'flagged' ? '<button class="user-action-flag-btn" onclick="openCaseModal(' + user.id + ')">Flag</button>' : '<button class="user-action-flag-btn" onclick="unflagUser(' + user.id + ')">Unflag</button>'}
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function openAddUserModal() {
  const fieldsContainer = document.getElementById('addUserFields');
  fieldsContainer.innerHTML = '';
  
  dataFramework.forEach(field => {
    const fieldName = field.name.toLowerCase().replace(/\s+/g, '_');
    fieldsContainer.innerHTML += `
      <div class="form-group">
        <label class="form-label">${field.name} ${field.required === 'yes' ? '<span style="color: var(--warning);">*</span>' : ''}</label>
        ${getFieldInputHTML(field).replace('form-input', 'form-input new-user-field').replace('placeholder', `placeholder="Enter ${field.name.toLowerCase()}" data-field="${fieldName}"`)}
      </div>
    `;
  });
  
  document.getElementById('addUserModal').classList.add('active');
}

function closeAddUserModal() {
  document.getElementById('addUserModal').classList.remove('active');
}

function handleAddUser(e) {
  e.preventDefault();
  
  const newUser = {
    id: Date.now().toString(),
    status: 'active',
    group: '',
    created_at: new Date().toISOString()
  };
  
  // Collect data from form fields
  const inputs = document.querySelectorAll('.new-user-field');
  inputs.forEach(input => {
    const fieldName = input.getAttribute('data-field');
    const fieldValue = input.value.trim();
    
    // Map to user properties
    if (fieldName.includes('name')) newUser.name = fieldValue;
    else if (fieldName.includes('reg')) newUser.regNo = fieldValue;
    else if (fieldName.includes('phone')) newUser.phone = fieldValue;
    else if (fieldName.includes('email')) newUser.email = fieldValue;
    else newUser[fieldName] = fieldValue;
  });
  
  // Check for duplicates
  const duplicate = userData.find(user => 
    user.regNo === newUser.regNo || 
    (newUser.email && user.email === newUser.email)
  );
  
  if (duplicate) {
    alert('User with this registration number or email already exists!');
    return;
  }
  
  userData.push(newUser);
  saveUserData();
  
  // Save to Supabase for real-time sync
  saveUserToSupabase(newUser);
  
  populateUserTable();
  closeAddUserModal();
  
  showTemporaryMessage('User added successfully!', 'success');
}

function openEditUserModal(userId) {
  const user = userData.find(u => u.id === userId);
  if (!user) return;
  
  const fieldsContainer = document.getElementById('editUserFields');
  fieldsContainer.innerHTML = '';
  
  // Add hidden input for user ID
  fieldsContainer.innerHTML += `<input type="hidden" id="editUserId" value="${user.id}">`;
  
  dataFramework.forEach(field => {
    const fieldName = field.name.toLowerCase().replace(/\s+/g, '_');
    const fieldValue = user[fieldName] || user[field.name.toLowerCase().replace(/\s+/g, '')] || '';
    
    fieldsContainer.innerHTML += `
      <div class="form-group">
        <label class="form-label">${field.name}</label>
        ${getFieldInputHTML(field).replace('form-input', 'form-input edit-user-field').replace('value=""', `value="${fieldValue}"`).replace('>', ` data-field="${fieldName}">`)}
      </div>
    `;
  });
  
  document.getElementById('editUserModal').classList.add('active');
}

function closeEditUserModal() {
  document.getElementById('editUserModal').classList.remove('active');
}

function handleEditUser(e) {
  e.preventDefault();
  
  const userId = parseInt(document.getElementById('editUserId').value);
  const userIndex = userData.findIndex(u => u.id === userId);
  
  if (userIndex === -1) return;
  
  // Update user data from form fields
  const inputs = document.querySelectorAll('.edit-user-field');
  inputs.forEach(input => {
    const fieldName = input.getAttribute('data-field');
    const fieldValue = input.value.trim();
    
    userData[userIndex][fieldName] = fieldValue;
  });
  
  saveUserData();
  populateUserTable();
  closeEditUserModal();
  
  showTemporaryMessage('User updated successfully!', 'success');
}

function deleteUser(userId) {
  if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
    userData = userData.filter(user => user.id !== userId);
    saveUserData();
    populateUserTable();
    showTemporaryMessage('User deleted successfully!', 'warning');
  }
}

function exportUsers() {
  // Convert to CSV
  const headers = dataFramework.map(f => f.name).join(',');
  const rows = userData.map(user => 
    dataFramework.map(f => {
      const fieldName = f.name.toLowerCase().replace(/\s+/g, '_');
      return `"${user[fieldName] || ''}"`;
    }).join(',')
  ).join('\n');
  
  const csv = headers + '\n' + rows;
  
  // Download CSV
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'users_export.csv';
  a.click();
  
  showTemporaryMessage('Users exported successfully!', 'success');
}

// ================= CASE MANAGEMENT =================
function openCaseModal(userId) {
  currentCaseUserId = userId;
  document.getElementById('caseDetails').value = '';
  document.getElementById('caseModal').classList.add('active');
}

function closeCaseModal() {
  document.getElementById('caseModal').classList.remove('active');
  currentCaseUserId = null;
}

function saveCaseInfo() {
  const caseDetails = document.getElementById('caseDetails').value.trim();
  
  if (!caseDetails) {
    alert('Please enter case details');
    return;
  }
  
  const userIndex = userData.findIndex(u => u.id === currentCaseUserId);
  if (userIndex === -1) return;
  
  userData[userIndex].caseInfo = caseDetails;
  userData[userIndex].status = 'flagged';
  saveUserData();
  populateUserTable();
  closeCaseModal();
  
  showTemporaryMessage('Case information saved! User has been flagged.', 'warning');
}

function unflagUser(userId) {
  if (confirm('Are you sure you want to unflag this user? This will remove their flagged status and case information.')) {
    const userIndex = userData.findIndex(u => u.id === userId);
    if (userIndex === -1) return;
    
    userData[userIndex].status = 'active';
    userData[userIndex].caseInfo = '';
    saveUserData();
    populateUserTable();
    
    const user = userData[userIndex];
    showTemporaryMessage(`${user.name} has been unflagged and is now active.`, 'success');
  }
}

function showCaseInfo(userId) {
  const user = userData.find(u => u.id === userId);
  if (user && user.caseInfo) {
    alert(`Case Information for ${user.name}:\n\n${user.caseInfo}`);
  }
}

// ================= GROUP MANAGEMENT =================
function loadGroups() {
  const savedGroups = localStorage.getItem('ring0_user_groups');
  if (savedGroups) {
    groups = JSON.parse(savedGroups);
  } else {
    groups = [...defaultGroups];
    saveGroups();
  }
}

function saveGroups() {
  localStorage.setItem('ring0_user_groups', JSON.stringify(groups));
}

function populateGroups() {
  const container = document.getElementById('groupList');
  container.innerHTML = '';
  
  if (groups.length === 0) {
    container.innerHTML = `
      <div class="user-empty-state">
        <div class="user-empty-icon">ðŸ‘¥</div>
        <h3>No Groups Created</h3>
        <p>Create groups using the controls above.</p>
      </div>
    `;
    return;
  }
  
  groups.forEach(group => {
    const groupCard = document.createElement('div');
    groupCard.className = 'group-card';
    
    const memberNames = group.members.map(memberId => {
      const user = userData.find(u => u.id === memberId);
      return user ? user.name : `User ${memberId}`;
    });
    
    groupCard.innerHTML = `
      <div class="group-header">
        <div class="group-title">${group.flagged ? 'ðŸš© ' : ''}${group.name}</div>
        <div class="group-title">${group.name}${group.flagged ? ' ðŸš©' : ''}</div>
        <div class="group-count">${group.members.length}/${group.size}</div>
        <button class="group-action-btn" onclick="openGroupActionModal(${group.id})">?</button>
      </div>
      <ul class="group-members">
        ${memberNames.map(name => `
          <li class="group-member">
            <span>${name}</span>
            <button class="move-user-btn" onclick="moveUserToGroup(${group.members.find((id, idx) => {
              const user = userData.find(u => u.id === id);
              return user && user.name === name;
            })}, ${group.id})">Move</button>
          </li>
        `).join('')}
      </ul>
    `;
    container.appendChild(groupCard);
  });
}

function createGroups() {
  const groupSize = parseInt(document.getElementById('groupSize').value);
  
  if (!groupSize || groupSize < 1) {
    alert('Please enter a valid group size');
    return;
  }
  
  // Clear existing groups
  groups = [];
  
  // Create new groups
  const totalUsers = userData.length;
  const numGroups = Math.ceil(totalUsers / groupSize);
  
  for (let i = 0; i < numGroups; i++) {
    const newGroup = {
      id: i + 1,
      name: `Group ${String.fromCharCode(65 + i)}`, // A, B, C, etc.
      size: groupSize,
      members: [],
      created_at: new Date().toISOString()
    };
    groups.push(newGroup);
    
    // Save to Supabase for real-time sync
    saveGroupToSupabase(newGroup);
  }
  
  saveGroups();
  populateGroups();
  showTemporaryMessage(`${numGroups} groups created with size ${groupSize}`, 'success');
}

function autoAssignGroups() {
  if (groups.length === 0) {
    alert('Please create groups first');
    return;
  }
  
  // Reset all group members
  groups.forEach(group => group.members = []);
  
  // Assign users to groups in order
  userData.forEach((user, index) => {
    const groupIndex = index % groups.length;
    groups[groupIndex].members.push(user.id);
    user.group = groups[groupIndex].name;
  });
  
  saveGroups();
  saveUserData();
  populateGroups();
  populateUserTable();
  
  showTemporaryMessage('Users auto-assigned to groups!', 'success');
}

function moveUserToGroup(userId, fromGroupId) {
  // Enhanced move functionality - show modal instead of prompt
  startMoveUser(userId, fromGroupId);
}

// ================= ENHANCED GROUP MANAGEMENT =================
let groupOrderType = 'alphabetical'; // 'alphabetical' or 'numerical'
let selectedUserForMove = null;
let groupToMoveTo = null;

// Enhanced createGroups function
function createGroups() {
  const groupSize = parseInt(document.getElementById('groupSize').value);

  if (!groupSize || groupSize < 1) {
    // Show manual group creation UI
    showManualGroupCreation();
    return;
  }

  // Clear existing groups
  groups = [];

  // Create new groups based on selected order
  const totalUsers = userData.length;
  const numGroups = Math.ceil(totalUsers / groupSize);

  for (let i = 0; i < numGroups; i++) {
    let groupName;
    if (groupOrderType === 'numerical') {
      groupName = `Group ${i + 1}`;
    } else {
      groupName = `Group ${String.fromCharCode(65 + i)}`; // A, B, C, etc.
    }

    groups.push({
      id: i + 1,
      name: groupName,
      size: groupSize,
      members: [],
      leader: null // Add leader property
      
    });
  }

  saveGroups();
  populateGroups();
  showTemporaryMessage(`${numGroups} groups created with size ${groupSize}`, 'success');
}

// Show manual group creation UI
function showManualGroupCreation() {
  const groupList = document.getElementById('groupList');

  const manualDiv = document.createElement('div');
  manualDiv.className = 'manual-group-creation';
  manualDiv.innerHTML = `
    <div style="margin-bottom: 15px;">
      <strong style="color: var(--accent);">Create Groups Manually</strong>
      <p style="color: var(--muted); font-size: 0.9rem; margin-top: 5px;">
        Choose group naming style, then add groups one by one.
      </p>
    </div>

    <div class="group-order-options">
      <div class="order-option ${groupOrderType === 'alphabetical' ? 'active' : ''}"
           onclick="setGroupOrder('alphabetical')">
        <input type="radio" name="groupOrder" ${groupOrderType === 'alphabetical' ? 'checked' : ''}>
        Alphabetical (Group A, B, C...)
      </div>
      <div class="order-option ${groupOrderType === 'numerical' ? 'active' : ''}"
           onclick="setGroupOrder('numerical')">
        <input type="radio" name="groupOrder" ${groupOrderType === 'numerical' ? 'checked' : ''}>
        Numerical (Group 1, 2, 3...)
      </div>
    </div>

    <div class="manual-group-inputs">
      <input type="text" id="newGroupName" placeholder="Enter group name" class="form-input">
      <input type="number" id="newGroupSize" placeholder="Group size" class="form-input" min="1" max="50">
      <button class="form-btn secondary" onclick="addManualGroup()">Add Group</button>
    </div>

    <div id="manualGroupsPreview" style="margin-top: 15px;"></div>
  `;

  groupList.innerHTML = '';
  groupList.appendChild(manualDiv);
}

function setGroupOrder(order) {
  groupOrderType = order;
  document.querySelectorAll('.order-option').forEach(opt => {
    opt.classList.remove('active');
  });
  event.target.closest('.order-option').classList.add('active');

  // Update preview
  updateManualGroupsPreview();
}

function addManualGroup() {
  const nameInput = document.getElementById('newGroupName');
  const sizeInput = document.getElementById('newGroupSize');

  const name = nameInput.value.trim();
  const size = parseInt(sizeInput.value);

  if (!name) {
    showTemporaryMessage('Please enter a group name', 'warning');
    return;
  }

  if (!size || size < 1) {
    showTemporaryMessage('Please enter a valid group size', 'warning');
    return;
  }

  // Check if group already exists
  if (groups.find(g => g.name === name)) {
    showTemporaryMessage('Group with this name already exists', 'warning');
    return;
  }

  const newGroup = {
    id: Date.now(),
    name: name,
    size: size,
    members: [],
    leader: null
  };

  groups.push(newGroup);
  saveGroups();

  // Clear inputs
  nameInput.value = '';
  sizeInput.value = '';

  // Update preview
  updateManualGroupsPreview();
  showTemporaryMessage(`Group "${name}" created!`, 'success');
}

function updateManualGroupsPreview() {
  const previewDiv = document.getElementById('manualGroupsPreview');
  if (!previewDiv) return;

  if (groups.length === 0) {
    previewDiv.innerHTML = '<p style="color: var(--muted);">No groups created yet</p>';
    return;
  }

  previewDiv.innerHTML = `
    <div style="margin-bottom: 10px; color: var(--accent); font-weight: bold;">
      Created Groups (${groups.length})
    </div>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      ${groups.map(group => `
        <div style="background: rgba(12, 16, 36, 0.5); padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(91, 140, 255, 0.3);">
          ${group.name} (0/${group.size})
        </div>
      `).join('')}
    </div>
    <button class="form-btn primary" onclick="finishManualGroupCreation()" style="margin-top: 15px;">
      Finish & View Groups
    </button>
  `;
}

function finishManualGroupCreation() {
  populateGroups();
}

// Enhanced populateGroups function
function populateGroups() {
  const container = document.getElementById('groupList');
  container.innerHTML = '';

  if (groups.length === 0) {
    container.innerHTML = `
      <div class="user-empty-state">
        <div class="user-empty-icon">ðŸ‘¥</div>
        <h3>No Groups Created</h3>
        <p>Create groups using the controls above.</p>
        <button class="form-btn primary" onclick="showManualGroupCreation()" style="margin-top: 15px;">
          Create Groups Manually
        </button>
      </div>
    `;
    return;
  }

  // Check if container exists, if not create it
  let groupsContainer = document.getElementById('groupsContainer');
  if (!groupsContainer) {
    groupsContainer = document.createElement('div');
    groupsContainer.className = 'groups-container';
    groupsContainer.id = 'groupsContainer';
    container.appendChild(groupsContainer);

    // Add order options
    const orderToggle = document.createElement('div');
    orderToggle.className = 'group-order-options';
    orderToggle.innerHTML = `
      <div style="color: var(--text); font-weight: bold; margin-right: 10px; display: block;">Group Order:</div><br>
      <div class="order-option ${groupOrderType === 'alphabetical' ? 'active' : ''}"
           onclick="toggleGroupOrder('alphabetical')">
        <input type="radio" name="groupOrderDisplay" ${groupOrderType === 'alphabetical' ? 'checked' : ''}>
        Alphabetical
      </div>
      <div class="order-option ${groupOrderType === 'numerical' ? 'active' : ''}"
           onclick="toggleGroupOrder('numerical')">
        <input type="radio" name="groupOrderDisplay" ${groupOrderType === 'numerical' ? 'checked' : ''}>
        Numerical
      </div>
    `;
    groupsContainer.appendChild(orderToggle);

    // Create scroll container
    const scrollContainer = document.createElement('div');
    scrollContainer.className = 'groups-scroll-container';
    scrollContainer.id = 'groupsScrollContainer';

    // Create horizontal layout
    const horizontalLayout = document.createElement('div');
    horizontalLayout.className = 'groups-horizontal-layout';
    horizontalLayout.id = 'groupsHorizontalLayout';

    scrollContainer.appendChild(horizontalLayout);
    groupsContainer.appendChild(scrollContainer);

    // Flagged groups count badge (top-right)
    const flagBadgeEl = document.createElement('div');
    flagBadgeEl.id = 'flagCountBadge';
    flagBadgeEl.className = 'flag-count-badge';
    flagBadgeEl.textContent = `Flagged: ${groups.filter(g => g.flagged).length}/${groups.length}`;
    groupsContainer.appendChild(flagBadgeEl);
  }

  // Update badge count each time
  const badge = document.getElementById('flagCountBadge');
  if (badge) {
    const flaggedTotal = groups.filter(g => g.flagged).length;
    const totalGroups = groups.length;
    badge.textContent = `Flagged: ${flaggedTotal}/${totalGroups}`;
    badge.style.display = totalGroups === 0 ? 'none' : 'block';
  }

  // Sort groups based on selected order
  const sortedGroups = [...groups].sort((a, b) => {
    if (groupOrderType === 'numerical') {
      const numA = parseInt(a.name.replace(/\D/g, '')) || 0;
      const numB = parseInt(b.name.replace(/\D/g, '')) || 0;
      return numA - numB;
    } else {
      return a.name.localeCompare(b.name);
    }
  });

  // Apply filters
  const showOnlyFlagged = document.getElementById('filterFlaggedGroups') ? document.getElementById('filterFlaggedGroups').checked : false;
  const showOnlyFlaggedMembers = document.getElementById('filterFlaggedMembers') ? document.getElementById('filterFlaggedMembers').checked : false;
  const searchTerm = document.getElementById('groupSearchInput') ? document.getElementById('groupSearchInput').value.toLowerCase().trim() : '';

  const filteredGroups = sortedGroups.filter(g => {
    if (showOnlyFlagged && !g.flagged) return false;
    if (showOnlyFlaggedMembers) {
      const hasFlaggedMember = g.members.some(uid => {
        const u = userData.find(x => x.id === uid);
        return u && u.status === 'flagged';
      });
      if (!hasFlaggedMember) return false;
    }
    if (searchTerm) {
      const nameMatch = g.name.toLowerCase().includes(searchTerm);
      const memberMatch = g.members.some(uid => {
        const u = userData.find(x => x.id === uid);
        return u && u.name.toLowerCase().includes(searchTerm);
      });
      if (!nameMatch && !memberMatch) return false;
    }
    return true;
  });

  // Get the horizontal layout container
  const horizontalLayout = document.getElementById('groupsHorizontalLayout');
  horizontalLayout.innerHTML = ''; // Clear existing content

  // Now create and append individual group cards to the horizontal layout
  const displayGroups = filteredGroups;
  if (displayGroups.length === 0) {
    horizontalLayout.innerHTML = `<div style="padding:20px;color:var(--muted);">No groups match the current filters.</div>`;
  }

  displayGroups.forEach(group => {
    const groupCard = document.createElement('div');
    groupCard.id = `group-card-${group.id}`;
    
    // Apply flagged-group class if the group is flagged
    if (group.flagged) {
      groupCard.className = 'group-card flagged-group';
    } else {
      groupCard.className = 'group-card';
    }

    const memberNames = group.members.map(memberId => {
      const user = userData.find(u => u.id === memberId);
      return user ? {
        id: user.id,
        name: user.name,
        isLeader: group.leader === user.id,
        flagged: user.status === 'flagged'
      } : null;
    }).filter(Boolean);

    groupCard.innerHTML = `
      <div class="group-header">
        <div style="display:flex; align-items:center; gap:8px;">
          <div class="group-title">${group.name}${group.flagged ? ' ðŸš©' : ''}</div>
          <button class="group-action-btn" title="Group actions" onclick="openGroupActionModal(${group.id})">?</button>
        </div>
        <div class="group-count">${group.members.length}/${group.size}</div>
      </div>

      ${group.leader ? `
        <div style="margin: 10px 0; padding: 8px; background: rgba(255, 215, 0, 0.1); border-radius: 6px; border: 1px solid rgba(255, 215, 0, 0.3);">
          <span style="color: gold; font-weight: bold;">â˜… Group Leader:</span>
          ${userData.find(u => u.id === group.leader)?.name || 'Unknown'}
        </div>
      ` : ''}

      <div class="group-members-container">
        <ul class="group-members">
          ${memberNames.map(member => `
            <li class="group-member ${member.isLeader ? 'group-leader' : ''} ${member.flagged ? 'member-flagged' : ''}" id="member-${member.id}">
              <span>${member.isLeader ? 'â˜… ' : ''}${member.name}</span>
              <div>
                ${!member.isLeader ? `<button class="move-user-btn" onclick="setUserAsLeader(${member.id}, ${group.id})">Set as Leader</button>` : ''}
                <button class="move-user-btn" onclick="startMoveUser(${member.id}, ${group.id})">Move</button>
              </div>
            </li>
          `).join('')}
        </ul>
      </div>

      ${group.members.length < group.size ? `
        <button class="form-btn secondary" onclick="addMemberToGroup(${group.id})" style="width: 100%; margin-top: 10px; padding: 1px;">
          + Add Member
        </button>
      ` : ''}
    `;
    horizontalLayout.appendChild(groupCard);
  });
}

// Modal for group actions (Delete / Flag/Unflag)
function openGroupActionModal(groupId) {
  const group = groups.find(g => g.id === groupId);
  if (!group) return;

  // Remove existing modal if any
  const existing = document.getElementById('groupActionModal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'groupActionModal';
  modal.className = 'case-modal-overlay active';
  modal.innerHTML = `
    <div class="case-modal-content" style="max-width:420px; padding:20px; border-radius:10px; background: var(--card);">
      <h3 style="color:var(--accent); margin-bottom:10px;">Actions for ${group.name}</h3>
      <div style="display:flex; gap:10px; margin-bottom:14px;">
        <button class="form-btn" style="background: linear-gradient(90deg,#ef4444,#f97316); color:white;" onclick="deleteGroup(${groupId})">ðŸ”´ Delete Group</button>
        <button class="form-btn" style="background: linear-gradient(90deg,#a855f7,#9333ea); color:white;" onclick="toggleFlagGroup(${groupId})">${group.flagged ? 'ðŸŸ£ Unflag Group' : 'ðŸŸ£ Flag Group'}</button>
      </div>
      <div style="text-align:right;"><button class="modal-btn cancel" onclick="document.getElementById('groupActionModal').remove()">Close</button></div>
    </div>
  `;
  document.body.appendChild(modal);
}

function deleteGroup(groupId) {
  if (!confirm('Delete this group? Members will become ungrouped.')) return;
  const idx = groups.findIndex(g => g.id === groupId);
  if (idx === -1) return;
  const removed = groups.splice(idx,1)[0];
  // Ungroup members
  removed.members.forEach(uid => {
    const u = userData.find(x => x.id === uid);
    if (u) u.group = '';
  });
  saveGroups();
  saveUserData();
  populateGroups();
  populateUserTable();
  const m = document.getElementById('groupActionModal'); if (m) m.remove();
  showTemporaryMessage(`Group ${removed.name} deleted. Members are now ungrouped.`, 'success');
}

function toggleFlagGroup(groupId) {
  const group = groups.find(g => g.id === groupId);
  if (!group) return;
  group.flagged = !group.flagged;
  // Update member flagged status
  group.members.forEach(uid => {
    const u = userData.find(x => x.id === uid);
    if (!u) return;
    if (group.flagged) {
      u.status = 'flagged';
    } else {
      u.status = 'active';
      u.caseInfo = '';
    }
  });
  saveGroups();
  saveUserData();
  populateGroups();
  populateUserTable();
  const m = document.getElementById('groupActionModal'); if (m) m.remove();
  showTemporaryMessage(`${group.flagged ? 'Group flagged.' : 'Group unflagged.'}`, group.flagged ? 'warning' : 'success');
}









function toggleGroupOrder(order) {
  groupOrderType = order;
  populateGroups();
}

// Enhanced move user function
function startMoveUser(userId, fromGroupId) {
  selectedUserForMove = userId;
  groupToMoveTo = null;

  const user = userData.find(u => u.id === userId);
  if (!user) return;

  // Highlight the selected user
  document.querySelectorAll('.group-member').forEach(member => {
    member.classList.remove('user-selected');
  });
  const selectedMember = document.getElementById(`member-${userId}`);
  if (selectedMember) {
    selectedMember.classList.add('user-selected');
  }

  // Show move modal
  showMoveUserModal(user.name, fromGroupId);
}

function showMoveUserModal(userName, fromGroupId) {
  const modal = document.createElement('div');
  modal.className = 'move-user-modal active';
  modal.id = 'moveUserModal';

  // Filter out the current group
  const availableGroups = groups.filter(g => g.id !== fromGroupId);

  modal.innerHTML = `
    <div class="move-user-content">
      <div class="modal-title" style="color: var(--accent); margin-bottom: 15px;">
        Move User: <span style="color: var(--text);">${userName}</span>
      </div>

      <div class="group-search">
        <input type="text" class="group-search-input" id="searchGroups" placeholder="Search for a group..." onkeyup="searchAvailableGroups()">
      </div>

      <div class="groups-list-move" id="groupsListMove">
        ${availableGroups.map(group => {
          const userCount = group.members.length;
          const isFull = userCount >= group.size;

          return `
            <div class="group-item-move ${isFull ? 'disabled' : ''}" onclick="${isFull ? '' : `selectGroupForMove(${group.id})`}">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>${group.name}</strong>
                  ${group.leader ? ' <span style="color: gold; font-size: 0.9rem;">â˜…</span>' : ''}
                </div>
                <div style="color: ${isFull ? 'var(--warning)' : 'var(--muted)'}; font-size: 0.9rem;">
                  ${userCount}/${group.size} members
                  ${isFull ? ' (Full)' : ''}
                </div>
              </div>
            </div>
          `;
        }).join('')}

        ${availableGroups.length === 0 ?
          '<p style="color: var(--muted); text-align: center; padding: 20px;">No other groups available</p>' :
          ''}
      </div>

      <div class="modal-buttons">
        <button class="modal-btn cancel" onclick="closeMoveModal()">Cancel</button>
        <button class="modal-btn yes" onclick="completeMoveUser()" id="confirmMoveBtn" disabled>
          Move User
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function searchAvailableGroups() {
  const searchTerm = document.getElementById('searchGroups').value.toLowerCase();
  const groupItems = document.querySelectorAll('.group-item-move');

  groupItems.forEach(item => {
    const groupName = item.querySelector('strong').textContent.toLowerCase();
    if (groupName.includes(searchTerm)) {
      item.style.display = 'block';
    } else {
      item.style.display = 'none';
    }
  });
}

function selectGroupForMove(groupId) {
  groupToMoveTo = groupId;

  // Update UI to show selection
  document.querySelectorAll('.group-item-move').forEach(item => {
    item.style.background = '';
    item.style.borderColor = '';
  });

  const selectedItem = document.querySelector(`.group-item-move[onclick*="${groupId}"]`);
  if (selectedItem) {
    selectedItem.style.background = 'rgba(91, 140, 255, 0.1)';
    selectedItem.style.borderColor = 'var(--accent)';
  }

  // Enable confirm button
  document.getElementById('confirmMoveBtn').disabled = false;
}

function completeMoveUser() {
  if (!selectedUserForMove || !groupToMoveTo) return;

  // Find current group (where user is currently)
  const currentGroup = groups.find(g => g.members.includes(selectedUserForMove));
  const targetGroup = groups.find(g => g.id === groupToMoveTo);

  if (!currentGroup || !targetGroup) return;

  // Check if target group has space
  if (targetGroup.members.length >= targetGroup.size) {
    showTemporaryMessage('Target group is full!', 'warning');
    return;
  }

  // Remove from current group
  currentGroup.members = currentGroup.members.filter(id => id !== selectedUserForMove);

  // Remove leader status if they were a leader
  if (currentGroup.leader === selectedUserForMove) {
    currentGroup.leader = null;
  }

  // Add to target group
  targetGroup.members.push(selectedUserForMove);

  // Update user record
  const userIndex = userData.findIndex(u => u.id === selectedUserForMove);
  if (userIndex !== -1) {
    userData[userIndex].group = targetGroup.name;
  }

  saveGroups();
  saveUserData();
  closeMoveModal();
  populateGroups();
  populateUserTable();

  showTemporaryMessage('User moved successfully!', 'success');
}

function closeMoveModal() {
  const modal = document.getElementById('moveUserModal');
  if (modal) {
    modal.remove();
  }

  // Remove selection highlighting
  document.querySelectorAll('.user-selected').forEach(el => {
    el.classList.remove('user-selected');
  });

  selectedUserForMove = null;
  groupToMoveTo = null;
}

function setUserAsLeader(userId, groupId) {
  const group = groups.find(g => g.id === groupId);
  if (!group) return;

  // Check if user is in the group
  if (!group.members.includes(userId)) {
    showTemporaryMessage('User is not in this group!', 'warning');
    return;
  }

  group.leader = userId;
  saveGroups();
  populateGroups();

  const user = userData.find(u => u.id === userId);
  showTemporaryMessage(`${user?.name || 'User'} set as group leader!', 'success`);
}

function addMemberToGroup(groupId) {
  // Find users not in any group
  const unassignedUsers = userData.filter(user => {
    const inAnyGroup = groups.some(g => g.members.includes(user.id));
    return !inAnyGroup;
  });

  if (unassignedUsers.length === 0) {
    showTemporaryMessage('No unassigned users available', 'warning');
    return;
  }

  const group = groups.find(g => g.id === groupId);
  if (!group) return;

  // Add the first unassigned user
  const userToAdd = unassignedUsers[0];
  group.members.push(userToAdd.id);

  // Update user record
  const userIndex = userData.findIndex(u => u.id === userToAdd.id);
  if (userIndex !== -1) {
    userData[userIndex].group = group.name;
  }

  saveGroups();
  saveUserData();
  populateGroups();
  populateUserTable();

  showTemporaryMessage(`${userToAdd.name} added to ${group.name}!`, 'success');
}

// ================= REGISTRATION SETTINGS =================
function updateRegistrationSwitch() {
  const isEnabled = localStorage.getItem('ring0_registration_enabled') !== 'false';
  const registrationSwitch = document.getElementById('registrationSwitch');
  if (registrationSwitch) {
    registrationSwitch.checked = isEnabled;
  }
}

function updateRegistrationVisibility() {
  const registrationSwitch = document.getElementById('registrationSwitch');
  if (!registrationSwitch) return;
  
  const isEnabled = registrationSwitch.checked;
  
  // Update main page visibility through localStorage
  localStorage.setItem('ring0_registration_enabled', isEnabled);
  
  // Update the member sign up button visibility
  const menuButtons = document.querySelectorAll('nav button');
  const memberSignUpBtn = menuButtons[menuButtons.length - 1]; // Last button is "member sign up"
  
  if (memberSignUpBtn && memberSignUpBtn.textContent.toLowerCase().includes('member')) {
    if (isEnabled) {
      memberSignUpBtn.style.display = 'block';
    } else {
      memberSignUpBtn.style.display = 'none';
    }
  }
  
  showTemporaryMessage(`Member sign up ${isEnabled ? 'enabled' : 'disabled'}!`, 'success');
}

function saveRegistrationSettings() {
  updateRegistrationVisibility();

  // Save registration mode
  const registrationModeSwitch = document.getElementById('registrationModeSwitch');
  if (registrationModeSwitch) {
    const useLink = registrationModeSwitch.checked;
    localStorage.setItem('ring0_registration_mode', useLink ? 'link' : 'default');

    if (useLink) {
      // Save the external link if in link mode
      const linkInput = document.getElementById('registrationLink');
      if (linkInput && linkInput.value.trim()) {
        localStorage.setItem('ring0_registration_link', linkInput.value.trim());
      }
    } else {
      // In default mode, we use groups.html
      localStorage.removeItem('ring0_registration_link'); // Clear any saved external link
    }
  }

  // Save to Supabase for real-time sync across devices
  const registrationSettings = {
    registration_enabled: localStorage.getItem('ring0_registration_enabled') !== 'false',
    registration_mode: localStorage.getItem('ring0_registration_mode') || 'default',
    registration_link: localStorage.getItem('ring0_registration_link') || 'groups.html',
    updated_at: new Date().toISOString()
  };
  
  updateRegistrationSettingsInSupabase(registrationSettings);

  showTemporaryMessage('Registration settings saved!', 'success');
}

function updateRegistrationSettingsUI() {
  const registrationTab = document.getElementById('settingsTab');
  if (!registrationTab) return;

  // FIRST, check if the registration-mode-container already exists
  // If it does, just update its state, don't create it again
  const existingModeContainer = registrationTab.querySelector('.registration-mode-container');
  const existingLinkSettings = registrationTab.querySelector('.link-settings');

  // If both containers already exist, just update their state and return
  if (existingModeContainer && existingLinkSettings) {
    // Load saved settings
    const savedMode = localStorage.getItem('ring0_registration_mode') || 'default';
    const savedLink = localStorage.getItem('ring0_registration_link') || 'groups.html';

    const modeSwitch = document.getElementById('registrationModeSwitch');
    if (modeSwitch) {
      modeSwitch.checked = savedMode === 'link';
    }

    const linkInput = document.getElementById('registrationLink');
    if (linkInput) {
      linkInput.value = savedLink;
    }

    // Toggle link settings visibility
    toggleLinkSettings(savedMode === 'link');
    return;
  }

  // If containers don't exist, create them (this should only happen once)

  // Remove any existing containers first (clean slate)
  if (existingModeContainer) existingModeContainer.remove();
  if (existingLinkSettings) existingLinkSettings.remove();

  // Add the new registration mode switch after the existing switch
  const existingSwitchContainer = registrationTab.querySelector('.registration-switch-container');

  const modeContainer = document.createElement('div');
  modeContainer.className = 'registration-mode-container';
  modeContainer.innerHTML = `
    <div class="registration-mode-label">Registration Method</div>
    <label class="registration-mode-switch">
      <input type="checkbox" id="registrationModeSwitch">
      <span class="registration-mode-slider"></span>
    </label>
  `;

  existingSwitchContainer.parentNode.insertBefore(modeContainer, existingSwitchContainer.nextSibling);

  // Add link settings section
  const linkSettings = document.createElement('div');
  linkSettings.className = 'link-settings';
  linkSettings.id = 'linkSettings';
  linkSettings.innerHTML = `
    <div style="margin-bottom: 15px;">
      <strong style="color: var(--accent);">External Link Registration</strong>
      <div class="mode-description">
        When users click "Member Sign Up", they will be redirected to this external URL.
        In "Default" mode, users will use the built-in groups.html file.
      </div>
    </div>

    <div class="link-input-group">
      <input type="text" id="registrationLink" value="http://yourdomain.com/register.html" class="form-input" placeholder="Enter external registration URL">
      <button class="test-link-btn" onclick="testRegistrationLink()">Test Link</button>
    </div>

    <div class="form-group">
      <label class="form-label">Link Behavior</label>
      <select class="form-select" id="linkBehavior">
        <option value="redirect">Redirect to link (default)</option>
        <option value="embed">Embed link in iframe</option>
        <option value="popup">Open in popup window</option>
      </select>
    </div>

    <div style="margin-top: 20px; padding: 15px; background: rgba(53, 208, 127, 0.1); border-radius: 8px; border: 1px solid rgba(53, 208, 127, 0.3);">
      <strong style="color: var(--success);">Mode Information:</strong>
      <p style="color: var(--muted); font-size: 0.85rem; margin-top: 5px;">
        â€¢ <strong>Default mode:</strong> Uses built-in groups.html file for registration<br>
        â€¢ <strong>Link mode:</strong> Redirects to external URL (enter above)
      </p>
    </div>
  `;

  modeContainer.parentNode.insertBefore(linkSettings, modeContainer.nextSibling.nextSibling);

  // Load saved settings
  const savedMode = localStorage.getItem('ring0_registration_mode') || 'default';
  const savedLink = localStorage.getItem('ring0_registration_link') || 'http://yourdomain.com/register.html';

  const modeSwitch = document.getElementById('registrationModeSwitch');
  if (modeSwitch) {
    modeSwitch.checked = savedMode === 'link';
  }

  const linkInput = document.getElementById('registrationLink');
  if (linkInput) {
    linkInput.value = savedLink;
  }

  // Toggle link settings visibility
  toggleLinkSettings(savedMode === 'link');

  // Add event listener for mode switch
  if (modeSwitch) {
    modeSwitch.addEventListener('change', function() {
      toggleLinkSettings(this.checked);
    });
  }
}

function toggleLinkSettings(show) {
  const linkSettings = document.getElementById('linkSettings');
  if (linkSettings) {
    if (show) {
      linkSettings.classList.add('active');
    } else {
      linkSettings.classList.remove('active');
    }
  }
}

function testRegistrationLink() {
  const linkInput = document.getElementById('registrationLink');
  if (!linkInput) return;
  
  const link = linkInput.value;
  if (!link) {
    showTemporaryMessage('Please enter a link', 'warning');
    return;
  }

  window.open(link, '_blank');
  showTemporaryMessage('Link opened in new tab for testing', 'info');
}

// Update the menu based on registration settings
function updateMainMenu() {
  const isEnabled = localStorage.getItem('ring0_registration_enabled') !== 'false';
  const mode = localStorage.getItem('ring0_registration_mode') || 'default';

  const nav = document.querySelector('nav');
  const existingGroupsBtn = Array.from(nav.children).find(btn =>
    btn.textContent.toLowerCase().includes('groups')
  );

  const existingMemberBtn = Array.from(nav.children).find(btn =>
    btn.textContent.toLowerCase().includes('member sign up')
  );

  // ===== FIXED: Always show Groups button =====
  if (!existingGroupsBtn) {
    const groupsBtn = document.createElement('button');
    groupsBtn.textContent = 'Groups';
    groupsBtn.onclick = function() {
      // Check if we're in link mode for registration
      if (mode === 'link') {
        const link = localStorage.getItem('ring0_registration_link') || 'groups.html';
        window.open(link, '_blank');
      } else {
        // Default behavior: just show a message or open default
        showTemporaryMessage('Groups functionality coming soon!', 'info');
      }
    };

    // Insert before the admin login button (or before member sign up if no admin login)
    const adminLoginBtn = nav.querySelector('button.admin-login');
    if (adminLoginBtn) {
      nav.insertBefore(groupsBtn, adminLoginBtn);
    } else {
      // Insert before the last button (member sign up)
      nav.insertBefore(groupsBtn, nav.lastElementChild);
    }
  }
  // ============================================

  // Update Member Sign Up button
  if (existingMemberBtn) {
    existingMemberBtn.style.display = isEnabled ? 'block' : 'none';

    if (isEnabled) {
      if (mode === 'link') {
        existingMemberBtn.textContent = 'Member Sign Up';
        existingMemberBtn.onclick = function() {
          const link = localStorage.getItem('ring0_registration_link') || 'groups.html';
          window.location.href = link;
        };
      } else {
        existingMemberBtn.textContent = 'Member Sign Up';
        existingMemberBtn.onclick = function() {
          openDefaultRegistrationForm();
        };
      }
    }
  }
}

function openDefaultRegistrationForm() {
  // Create a modal with the registration form
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-title">Member Registration</div>
      <div style="color: var(--muted); margin-bottom: 20px; text-align: center;">
        Fill out the form below to register as a member
      </div>

      <form id="memberRegistrationForm">
        <div id="registrationFormFields" style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
          <!-- Dynamic fields will be inserted here -->
        </div>

        <div class="modal-buttons" style="margin-top: 25px;">
          <button type="button" class="modal-btn cancel" onclick="closeRegistrationForm()">Cancel</button>
          <button type="submit" class="modal-btn yes">Submit Registration</button>
        </div>
      </form>
    </div>
  `;

  document.body.appendChild(modal);

  // Load the form fields from data framework
  const fieldsContainer = document.getElementById('registrationFormFields');
  fieldsContainer.innerHTML = '';

  dataFramework.forEach(field => {
    fieldsContainer.innerHTML += `
      <div class="form-group" style="margin-bottom: 15px;">
        <label class="form-label" style="display: block; margin-bottom: 5px; color: var(--text);">
          ${field.name} ${field.required === 'yes' ? '<span style="color: var(--warning);">*</span>' : ''}
        </label>
        ${getFieldInputHTML(field).replace('form-input', 'form-input registration-field').replace('placeholder', `placeholder="Enter your ${field.name.toLowerCase()}" data-field="${field.name.toLowerCase().replace(/\s+/g, '_')}"`)}
      </div>
    `;
  });

  // Handle form submission
  document.getElementById('memberRegistrationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    submitMemberRegistration();
  });
}

function closeRegistrationForm() {
  const modal = document.querySelector('.modal-overlay.active');
  if (modal) {
    modal.remove();
  }
}

function submitMemberRegistration() {
  const newMember = {
    id: Date.now(),
    status: 'active',
    group: '',
    registeredAt: new Date().toISOString()
  };

  // Collect data from form fields
  const inputs = document.querySelectorAll('.registration-field');
  let isValid = true;

  inputs.forEach(input => {
    const fieldName = input.getAttribute('data-field');
    const fieldValue = input.value.trim();
    const isRequired = input.hasAttribute('required');

    if (isRequired && !fieldValue) {
      input.style.borderColor = 'var(--warning)';
      isValid = false;
    } else {
      input.style.borderColor = '';

      // Map to member properties
      if (fieldName.includes('name')) newMember.name = fieldValue;
      else if (fieldName.includes('reg')) newMember.regNo = fieldValue;
      else if (fieldName.includes('phone')) newMember.phone = fieldValue;
      else if (fieldName.includes('email')) newMember.email = fieldValue;
      else newMember[fieldName] = fieldValue;
    }
  });

  if (!isValid) {
    showTemporaryMessage('Please fill in all required fields', 'warning');
    return;
  }

  // Check for duplicates
  const duplicate = userData.find(user =>
    (newMember.regNo && user.regNo === newMember.regNo) ||
    (newMember.email && user.email === newMember.email)
  );

  if (duplicate) {
    showTemporaryMessage('A user with this registration number or email already exists!', 'warning');
    return;
  }

  // Add to user data
  userData.push(newMember);
  saveUserData();

  // Close the form
  closeRegistrationForm();

  // Show success message
  alert('Thank you for registering! You have been successfully added as a member.');

  // If in admin mode, refresh the user table
  if (document.getElementById('adminDashboard').classList.contains('active')) {
    populateUserTable();
  }
}

function copyRegistrationLink() {
  const linkInput = document.getElementById('registrationLink');
  if (!linkInput) return;
  
  linkInput.select();
  linkInput.setSelectionRange(0, 99999); // For mobile devices

  navigator.clipboard.writeText(linkInput.value)
    .then(() => {
      showTemporaryMessage('Link copied to clipboard!', 'success');
    })
    .catch(err => {
      console.error('Failed to copy: ', err);
    });
}

// ================= IMAGE CONTENT MANAGEMENT SYSTEM =================
let allImages = [];
let imageToDelete = null;
let imageToEdit = null;
let sliderImages = [];
let currentFilter = 'all';
let autoAdvanceInterval = null;

const defaultImages = [
  {
    id: 1,
    title: "University Timetable",
    description: "Current semester schedule and class timings",
    category: "critical",
    imageUrl: "time_table.jpg",
    targetUrl: "#",
    createdAt: new Date().toISOString(),
    expiresAt: null,
    status: "active",
    order: 1
  },
  {
    id: 2,
    title: "Module Summary",
    description: "Important points and study materials",
    category: "important",
    imageUrl: "modure_summery.jpg",
    targetUrl: "#",
    createdAt: new Date().toISOString(),
    expiresAt: null,
    status: "active",
    order: 2
  }
];

function openImageContentManagement() {
  document.getElementById('dashboardMenu').style.display = 'none';
  document.getElementById('imageContentManagementSection').style.display = 'block';
  initializeImageManagement();
}

function switchImageTab(tabId) {
  document.querySelectorAll('#imageContentManagementSection .admin-tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  document.querySelectorAll('#imageContentManagementSection .admin-tab').forEach(button => {
    button.classList.remove('active');
  });
  
  document.getElementById(tabId).classList.add('active');
  
  document.querySelector(`#imageContentManagementSection .admin-tab[onclick="switchImageTab('${tabId}')"]`).classList.add('active');
}

function initializeImageManagement() {
  loadImagesFromStorage();
  renderActiveImages();
  loadSliderSettings();
  setupImageUploadPreview();
  
  const form = document.getElementById('createImageForm');
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const uploadInput = document.getElementById('imageUpload');
    
    // Validate file requirement: required for new images, optional for edits
    if (!imageToEdit && !uploadInput.files[0]) {
      showTemporaryMessage('Please select an image file to upload', 'warning');
      return;
    }
    
    if (imageToEdit) {
      updateImage();
    } else {
      createImage();
    }
  });
}

function setupImageUploadPreview() {
  const uploadInput = document.getElementById('imageUpload');
  const preview = document.getElementById('previewImage');
  const previewContainer = document.getElementById('imagePreview');
  
  uploadInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        previewContainer.style.display = 'block';
      }
      reader.readAsDataURL(this.files[0]);
    }
  });
}

function toggleVisibilityOptions() {
  const visibility = document.getElementById('imageVisibility').value;
  const daysGroup = document.getElementById('daysInputGroup');
  const dateGroup = document.getElementById('dateInputGroup');
  
  daysGroup.style.display = visibility === 'days' ? 'block' : 'none';
  dateGroup.style.display = visibility === 'date' ? 'block' : 'none';
}

function loadImagesFromStorage() {
  try {
    const savedImages = localStorage.getItem('ring0_slider_images');
    if (savedImages) {
      allImages = JSON.parse(savedImages);
    } else {
      allImages = [...defaultImages];
      saveImagesToStorage();
    }
  } catch (e) {
    console.warn('Could not load images from storage:', e);
    allImages = [...defaultImages];
  }
}

function saveImagesToStorage() {
  try {
    localStorage.setItem('ring0_slider_images', JSON.stringify(allImages));
    updateSliderImages();
  } catch (e) {
    console.warn('Could not save images to storage:', e);
    showTemporaryMessage('Error saving images. Please try again.', 'warning');
  }
}

function loadSliderSettings() {
  try {
    const settings = localStorage.getItem('ring0_slider_settings');
    if (settings) {
      const parsed = JSON.parse(settings);
      if (parsed.backgroundColor) {
        document.querySelector('.image-slider-container').style.background = parsed.backgroundColor;
        const colorOption = document.querySelector(`.color-option[data-color="${parsed.backgroundColor}"]`);
        if (colorOption) colorOption.style.borderColor = 'var(--accent)';
        document.getElementById('selectedColor').value = parsed.backgroundColor;
      }
      if (parsed.autoAdvance !== undefined) {
        document.getElementById('autoAdvance').value = parsed.autoAdvance;
        // Do not auto-start auto-advance on load. Only start when user saves settings.
      }
    }
  } catch (e) {
    console.warn('Could not load slider settings:', e);
  }
}

function saveSliderSettings() {
  const backgroundColor = document.getElementById('selectedColor').value;
  const autoAdvance = document.getElementById('autoAdvance').value;
  
  const settings = {
    backgroundColor: backgroundColor,
    autoAdvance: autoAdvance
  };
  
  try {
    localStorage.setItem('ring0_slider_settings', JSON.stringify(settings));
    
    document.querySelector('.image-slider-container').style.background = backgroundColor;
    setupAutoAdvance(autoAdvance);
    
    showTemporaryMessage('Slider settings saved successfully!', 'success');
  } catch (e) {
    console.warn('Could not save slider settings:', e);
    showTemporaryMessage('Error saving settings. Please try again.', 'warning');
  }
}

function selectColor(color) {
  document.querySelectorAll('.color-option').forEach(option => {
    option.style.borderColor = 'transparent';
  });
  
  const selectedOption = document.querySelector(`.color-option[data-color="${color}"]`);
  if (selectedOption) selectedOption.style.borderColor = 'var(--accent)';
  
  document.getElementById('selectedColor').value = color;
}

function setupAutoAdvance(interval) {
  if (autoAdvanceInterval) {
    clearInterval(autoAdvanceInterval);
    autoAdvanceInterval = null;
  }
  
  if (interval !== '0') {
    autoAdvanceInterval = setInterval(nextImage, parseInt(interval));
  }
}

async function createImage() {
  const title = document.getElementById('imageTitle').value.trim();
  const description = document.getElementById('imageDescription').value.trim();
  const category = document.getElementById('imageCategory').value;
  const targetUrl = document.getElementById('imageTargetUrl').value.trim() || '#';
  const visibility = document.getElementById('imageVisibility').value;
  const uploadInput = document.getElementById('imageUpload');

  if (!title || !description || !category || !uploadInput.files[0]) {
    showTemporaryMessage('Please fill in all required fields', 'warning');
    return;
  }

  // Calculate expiry
  let expiresAt = null;
  if (visibility === 'days') {
    const days = parseInt(document.getElementById('imageDays').value);
    if (days && days > 0) {
      const expiryDate = new Date();
      expiryDate.setDate(expiryDate.getDate() + days);
      expiresAt = expiryDate.toISOString();
    }
  } else if (visibility === 'date') {
    const dateStr = document.getElementById('imageEndDate').value;
    if (dateStr) {
      expiresAt = new Date(dateStr + 'T23:59:59').toISOString();
    }
  }

  // Show loading
  showTemporaryMessage('Creating image post...', 'info');
  
  const file = uploadInput.files[0];
  const reader = new FileReader();

  reader.onload = async function(e) {
    try {
      // ðŸ”¥ STEP 1: UPLOAD TO CLOUDINARY
      showTemporaryMessage('Uploading to Cloudinary...', 'info');
      const cloudinaryResult = await uploadToCloudinary(file);
      
      if (!cloudinaryResult.success) {
        throw new Error(cloudinaryResult.error || 'Cloudinary upload failed');
      }

      console.log('âœ… Cloudinary upload successful:', cloudinaryResult);

      // ðŸ”¥ STEP 2: PREPARE SUPABASE DATA
      const imageDataForSupabase = {
        title: title,
        description: description,
        category: category,
        target_url: targetUrl,
        cloudinary_url: cloudinaryResult.url,
        cloudinary_public_id: cloudinaryResult.public_id,
        cloudinary_format: cloudinaryResult.format,
        expires_at: expiresAt,
        display_order: allImages.length,
        status: 'active'
      };

      console.log('ðŸ“¤ Saving to Supabase:', imageDataForSupabase);

      // ðŸ”¥ STEP 3: SAVE TO SUPABASE
      const { data, error } = await supabaseClient
        .from('image_posts')
        .insert([imageDataForSupabase])
        .select();

      if (error) {
        console.error('âŒ Supabase error:', error);
        throw error;
      }

      const savedImage = data[0];
      console.log('âœ… Image saved to Supabase. ID:', savedImage.id);

      // ðŸ”¥ STEP 4: UPDATE LOCAL CACHE
      const localImageData = {
        id: savedImage.id,
        title: title,
        description: description,
        category: category,
        imageData: e.target.result, // Local preview
        cloudinaryUrl: cloudinaryResult.url, // Actual URL
        targetUrl: targetUrl,
        expiresAt: expiresAt,
        status: 'active',
        order: allImages.length
      };
      
      allImages.push(localImageData);
      saveImagesToStorage();

      // ðŸ”¥ STEP 5: UPDATE UI
      renderActiveImages();
      updateSliderImages();
      
      // Success!
      showTemporaryMessage(`"${title}" created and synced to all devices!`, 'success');
      resetImageForm();
      
      setTimeout(() => {
        switchImageTab('manage-images');
      }, 500);

    } catch (error) {
      console.error('âŒ Error creating image:', error);
      showTemporaryMessage(`Creation failed: ${error.message}`, 'warning');
    }
  };

  reader.readAsDataURL(file);
}

async function updateImage() {
  if (!imageToEdit) return;
  
  const title = document.getElementById('imageTitle').value.trim();
  const description = document.getElementById('imageDescription').value.trim();
  const category = document.getElementById('imageCategory').value;
  const targetUrl = document.getElementById('imageTargetUrl').value.trim() || '#';
  const visibility = document.getElementById('imageVisibility').value;
  
  if (!title || !description || !category) {
    showTemporaryMessage('Please fill in all required fields', 'warning');
    return;
  }
  
  // Calculate expiry date
  let expiresAt = null;
  if (visibility === 'days') {
    const days = parseInt(document.getElementById('imageDays').value);
    if (days && days > 0) {
      const expiryDate = new Date();
      expiryDate.setDate(expiryDate.getDate() + days);
      expiresAt = expiryDate.toISOString();
    }
  } else if (visibility === 'date') {
    const dateStr = document.getElementById('imageEndDate').value;
    if (dateStr) {
      expiresAt = new Date(dateStr + 'T23:59:59').toISOString();
    }
  }
  
  // Show loading
  showTemporaryMessage(`Updating "${title}"...`, 'info');
  
  try {
    // ðŸ”¥ STEP 1: PREPARE UPDATE DATA FOR SUPABASE
    const updateData = {
      title: title,
      description: description,
      category: category,
      target_url: targetUrl,
      expires_at: expiresAt,
      updated_at: new Date().toISOString()
    };
    
    // Handle image file upload if changed
    const uploadInput = document.getElementById('imageUpload');
    if (uploadInput.files[0]) {
      const file = uploadInput.files[0];
      
      // Upload to Cloudinary
      showTemporaryMessage('Uploading new image...', 'info');
      const cloudinaryResult = await uploadToCloudinary(file);
      
      if (!cloudinaryResult.success) {
        throw new Error('Cloudinary upload failed');
      }
      
      // Add Cloudinary data to update
      updateData.cloudinary_url = cloudinaryResult.url;
      updateData.cloudinary_public_id = cloudinaryResult.public_id;
      updateData.cloudinary_format = cloudinaryResult.format;
    }
    
    // ðŸ”¥ STEP 2: UPDATE SUPABASE
    const { data, error } = await supabaseClient
      .from('image_posts')
      .update(updateData)
      .eq('id', imageToEdit.id)
      .select();
    
    if (error) throw error;
    
    console.log('âœ… Image updated in Supabase:', data[0]);
    
    // ðŸ”¥ STEP 3: UPDATE LOCAL CACHE
    const imageIndex = allImages.findIndex(img => img.id === imageToEdit.id);
    if (imageIndex !== -1) {
      // Keep the updated data
      allImages[imageIndex] = {
        ...allImages[imageIndex],
        ...updateData,
        id: imageToEdit.id
      };
      
      // If we uploaded a new image, update imageData
      if (uploadInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          allImages[imageIndex].imageData = e.target.result;
          saveImagesToStorage();
          renderActiveImages();
          showTemporaryMessage('Image updated on all devices!', 'success');
          switchImageTab('manage-images');
        };
        reader.readAsDataURL(uploadInput.files[0]);
      } else {
        saveImagesToStorage();
        renderActiveImages();
        showTemporaryMessage('Image updated on all devices!', 'success');
        switchImageTab('manage-images');
      }
    }
    
  } catch (error) {
    console.error('âŒ Failed to update image:', error);
    showTemporaryMessage('Update failed. Please try again.', 'warning');
  }
}

function resetImageForm() {
  document.getElementById('imageTitle').value = '';
  document.getElementById('imageDescription').value = '';
  document.getElementById('imageCategory').value = '';
  document.getElementById('imageTargetUrl').value = '';
  document.getElementById('imageUpload').value = '';
  document.getElementById('imageVisibility').value = 'forever';
  document.getElementById('imageDays').value = '';
  document.getElementById('imageEndDate').value = '';
  document.getElementById('previewImage').src = '';
  document.getElementById('imagePreview').style.display = 'none';
  document.getElementById('daysInputGroup').style.display = 'none';
  document.getElementById('dateInputGroup').style.display = 'none';
  
  imageToEdit = null;
  document.getElementById('imageSubmitBtn').textContent = 'Upload Image';
}

function renderActiveImages() {
  const container = document.getElementById('activeImagesContainer');
  const activeImages = allImages.filter(img => img.status === 'active');
  
  container.innerHTML = '';
  
  if (activeImages.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
          <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;">ðŸ–¼ï¸</div>
          <h3 style="color: var(--accent); margin-bottom: 10px;">No Images Found</h3>
          <p>Upload your first image in the "Upload New Image" tab.</p>
          <button class="admin-modal-btn secondary" onclick="switchImageTab('create-image')" style="margin-top: 20px;">
            Upload New Image
          </button>
        </div>
      </div>
    `;
    return;
  }
  
  activeImages.forEach(image => {
    const imageElement = document.createElement('div');
    imageElement.className = 'image-card';
    
    const isExpired = image.expiresAt && new Date(image.expiresAt) < new Date();
    const categoryClass = `category-${image.category}`;
    
    imageElement.innerHTML = `
      <div class="image-card-category ${categoryClass}">
        ${image.category.charAt(0).toUpperCase() + image.category.slice(1)}
      </div>
      <img src="${image.imageData || image.imageUrl}" alt="${image.title}" onerror="this.src='placeholder.jpg'">
      <h4>${image.title}</h4>
      <p>${image.description}</p>
      <div style="font-size: 0.8rem; color: ${isExpired ? 'var(--warning)' : 'var(--muted)'}; margin-bottom: 10px;">
        ${isExpired ? 'âš ï¸ Expired' : (image.expiresAt ? `Expires: ${formatDate(image.expiresAt)}` : 'Never Expires')}
      </div>
      <div class="image-card-actions">
        <button class="image-card-btn edit" onclick="editImage('${image.id}')">
          Edit
        </button>
        <button class="image-card-btn ${isExpired ? 'delete' : 'cancel'}" onclick="${isExpired ? `openDeleteImageModal('${image.id}')` : `cancelImage('${image.id}')`}">
          ${isExpired ? 'Delete' : 'Cancel'}
        </button>
      </div>
    `;
    
    const img = imageElement.querySelector('img');
    if (image.targetUrl && image.targetUrl !== '#') {
      img.style.cursor = 'pointer';
      img.addEventListener('click', function() {
        window.open(image.targetUrl, '_blank');
      });
    }
    
    container.appendChild(imageElement);
  });
}

function filterImagesByCategory() {
  const filterValue = document.getElementById('imageCategoryFilter').value;
  const activeImages = allImages.filter(img => img.status === 'active');
  const container = document.getElementById('activeImagesContainer');
  
  if (filterValue === 'all') {
    renderActiveImages();
    return;
  }
  
  const filteredImages = activeImages.filter(img => img.category === filterValue);
  
  if (filteredImages.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
          <div style="font-size: 2.5rem; margin-bottom: 15px; opacity: 0.5;">ðŸ”</div>
          <h3 style="color: var(--accent); margin-bottom: 10px;">No ${filterValue} Images</h3>
          <p>No images found in the ${filterValue} category.</p>
        </div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = '';
  filteredImages.forEach(image => {
    const imageElement = document.createElement('div');
    imageElement.className = 'image-card';
    const categoryClass = `category-${image.category}`;
    
    imageElement.innerHTML = `
      <div class="image-card-category ${categoryClass}">
        ${image.category.charAt(0).toUpperCase() + image.category.slice(1)}
      </div>
      <img src="${image.imageData || image.imageUrl}" alt="${image.title}" onerror="this.src='placeholder.jpg'">
      <h4>${image.title}</h4>
      <p>${image.description}</p>
      <div style="font-size: 0.8rem; color: var(--muted); margin-bottom: 10px;">
        ${image.expiresAt ? `Expires: ${formatDate(image.expiresAt)}` : 'Never Expires'}
      </div>
      <div class="image-card-actions">
        <button class="image-card-btn edit" onclick="editImage('${image.id}')">
          Edit
        </button>
        <button class="image-card-btn cancel" onclick="cancelImage('${image.id}')">
          Cancel
        </button>
      </div>
    `;
    
    container.appendChild(imageElement);
  });
}

function editImage(imageId) {
  const image = allImages.find(img => img.id === imageId);
  if (!image) return;
  
  imageToEdit = image;
  
  document.getElementById('imageTitle').value = image.title;
  document.getElementById('imageDescription').value = image.description;
  document.getElementById('imageCategory').value = image.category;
  document.getElementById('imageTargetUrl').value = image.targetUrl || '';
  
  // Clear file input for edit mode (optional for updates)
  document.getElementById('imageUpload').value = '';
  
  if (image.expiresAt) {
    const expiryDate = new Date(image.expiresAt);
    const today = new Date();
    const diffTime = expiryDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays > 0 && diffDays < 365) {
      document.getElementById('imageVisibility').value = 'days';
      document.getElementById('imageDays').value = diffDays;
      document.getElementById('daysInputGroup').style.display = 'block';
      document.getElementById('dateInputGroup').style.display = 'none';
    } else {
      document.getElementById('imageVisibility').value = 'date';
      document.getElementById('imageEndDate').value = expiryDate.toISOString().split('T')[0];
      document.getElementById('dateInputGroup').style.display = 'block';
      document.getElementById('daysInputGroup').style.display = 'none';
    }
  } else {
    document.getElementById('imageVisibility').value = 'forever';
    document.getElementById('daysInputGroup').style.display = 'none';
    document.getElementById('dateInputGroup').style.display = 'none';
  }
  
  // Show preview of current image
  if (image.imageData) {
    document.getElementById('previewImage').src = image.imageData;
    document.getElementById('imagePreview').style.display = 'block';
  } else if (image.imageUrl) {
    document.getElementById('previewImage').src = image.imageUrl;
    document.getElementById('imagePreview').style.display = 'block';
  }
  
  document.getElementById('imageSubmitBtn').textContent = 'Update Image';
  console.log('ðŸ“ Editing image:', image.id, image.title);
  
  switchImageTab('create-image');
}

async function cancelImage(imageId) {
  const image = allImages.find(img => String(img.id) === String(imageId));
  if (!image) return;
  
  if (!confirm(`Are you sure you want to hide "${image.title}"? It will stop being displayed but can be restored.`)) {
    return;
  }
  
  // Show loading
  showTemporaryMessage(`Hiding "${image.title}"...`, 'info');
  
  try {
    // ðŸ”¥ STEP 1: UPDATE SUPABASE (Source of Truth)
    const { error } = await supabaseClient
      .from('image_posts')
      .update({ 
        status: 'cancelled',
        updated_at: new Date().toISOString()
      })
      .eq('id', image.id);
    
    if (error) throw error;
    
    console.log('âœ… Image cancelled in Supabase:', image.id);
    
    // ðŸ”¥ STEP 2: UPDATE LOCAL CACHE
    const imageIndex = allImages.findIndex(img => String(img.id) === String(imageId));
    if (imageIndex !== -1) {
      allImages[imageIndex].status = 'cancelled';
      allImages[imageIndex].cancelledAt = new Date().toISOString();
      saveImagesToStorage();
    }
    
    // ðŸ”¥ STEP 3: UPDATE UI
    renderActiveImages();
    updateSliderImages();
    
    showTemporaryMessage(`"${image.title}" hidden from all devices!`, 'success');
    
  } catch (error) {
    console.error('âŒ Failed to cancel image:', error);
    showTemporaryMessage('Cancel failed. Working offline?', 'warning');
  }
}

function openDeleteImageModal(imageId) {
  const image = allImages.find(img => String(img.id) === String(imageId));
  
  if (image) {
    if (confirm(`Are you sure you want to permanently delete "${image.title}"? This action cannot be undone.`)) {
      deleteImage(imageId);
    }
  }
}

async function deleteImage(imageId) {
  // Find the image first
  const image = allImages.find(img => String(img.id) === String(imageId));
  if (!image) {
    console.warn('Image not found for deletion:', imageId);
    return;
  }
  
  // Show loading message
  showTemporaryMessage(`Deleting "${image.title}"...`, 'info');
  
  try {
    // ðŸ”¥ STEP 1: DELETE FROM SUPABASE FIRST (Source of Truth)
    const { error } = await supabaseClient
      .from('image_posts')
      .delete()
      .eq('id', image.id);
    
    if (error) {
      console.error('Supabase delete error:', error);
      throw error;
    }
    
    console.log('âœ… Image deleted from Supabase:', image.id);
    
    // ðŸ”¥ STEP 2: UPDATE LOCAL STORAGE (Cache)
    const imageIndex = allImages.findIndex(img => String(img.id) === String(imageId));
    if (imageIndex !== -1) {
      allImages.splice(imageIndex, 1);
      saveImagesToStorage(); // Save to localStorage as backup
    }
    
    // ðŸ”¥ STEP 3: UPDATE UI
    renderActiveImages();
    updateSliderImages();
    
    // Success message
    showTemporaryMessage(`"${image.title}" deleted from all devices!`, 'success');
    
  } catch (error) {
    console.error('âŒ Failed to delete image:', error);
    showTemporaryMessage('Delete failed. Working offline?', 'warning');
    
    // Even if Supabase fails, update UI locally so admin sees change
    const imageIndex = allImages.findIndex(img => String(img.id) === String(imageId));
    if (imageIndex !== -1) {
      allImages.splice(imageIndex, 1);
      saveImagesToStorage();
      renderActiveImages();
      updateSliderImages();
    }
  }
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

// ================= SLIDER UPDATES =================
let currentImageIndex = 0;

function updateSliderImages() {
  const now = new Date();
  sliderImages = allImages.filter(img => 
    img.status === 'active' && 
    (!img.expiresAt || new Date(img.expiresAt) > now)
  );
  
  if (currentFilter !== 'all') {
    sliderImages = sliderImages.filter(img => img.category === currentFilter);
  }
  
  sliderImages.sort((a, b) => a.order - b.order);
  
  if (sliderImages.length > 0) {
    currentImageIndex = 0;
    updateImageSlider();
  } else {
    const img = document.getElementById('currentImage');
    img.src = 'placeholder.jpg';
    img.alt = 'No images available';
    img.style.cursor = 'default';
    img.onclick = null;
    document.getElementById('sliderCounter').textContent = '0/0';
    document.getElementById('sliderSubtitle').textContent = '';
    
    const dots = document.querySelectorAll('.indicator-dot');
    dots.forEach(dot => dot.remove());
  }
}

// ðŸ”„ UPDATE SLIDER INDICATORS HELPER
function updateSliderIndicators() {
  const indicatorContainer = document.querySelector('.slider-indicator');
  if (!indicatorContainer) return;
  
  indicatorContainer.innerHTML = '';
  
  for (let i = 0; i < sliderImages.length; i++) {
    const dot = document.createElement('span');
    dot.className = `indicator-dot ${i === currentImageIndex ? 'active' : ''}`;
    dot.onclick = () => goToImage(i);
    indicatorContainer.appendChild(dot);
  }
}

function updateImageSlider() {
  const img = document.getElementById('currentImage');
  const counter = document.getElementById('sliderCounter');
  
  if (sliderImages.length === 0) {
    img.src = 'placeholder.jpg';
    img.alt = 'No images available';
    counter.textContent = '0/0';
    document.getElementById('sliderSubtitle').textContent = '';
    document.querySelector('.slider-title').textContent = '-------';
    return;
  }
  
  const currentImage = sliderImages[currentImageIndex];
  
  img.src = currentImage.imageData || currentImage.imageUrl;
  img.alt = currentImage.title;
  
  counter.textContent = `${currentImageIndex + 1}/${sliderImages.length}`;
  
  document.querySelectorAll('.indicator-dot').forEach((dot, index) => {
    dot.classList.toggle('active', index === currentImageIndex);
  });
  
  if (currentImage.targetUrl && currentImage.targetUrl !== '#') {
    img.style.cursor = 'pointer';
    img.onclick = function() {
      window.open(currentImage.targetUrl, '_blank');
    };
  } else {
    img.style.cursor = 'default';
    img.onclick = null;
  }
  
  updateImageInfo(currentImage);
}

function updateImageInfo(image) {
  const titleElement = document.querySelector('.slider-title');
  const subtitleElement = document.getElementById('sliderSubtitle');
  
  if (titleElement) {
    titleElement.textContent = image.title;
  }
  
  if (subtitleElement) {
    subtitleElement.textContent = image.description;
  }
}

function nextImage() {
  if (sliderImages.length > 0) {
    currentImageIndex = (currentImageIndex + 1) % sliderImages.length;
    updateImageSlider();
  }
}

function prevImage() {
  if (sliderImages.length > 0) {
    currentImageIndex = (currentImageIndex - 1 + sliderImages.length) % sliderImages.length;
    updateImageSlider();
  }
}

function goToImage(index) {
  if (index >= 0 && index < sliderImages.length) {
    currentImageIndex = index;
    updateImageSlider();
  }
}

function toggleFilterPanel() {
  const panel = document.getElementById('sliderFilterPanel');
  panel.classList.toggle('show');
}

function applySliderFilter(category) {
  currentFilter = category;
  updateSliderImages();
  updateSliderIndicators();
  
  document.getElementById('sliderFilterPanel').classList.remove('show');
}

// ================= DASHBOARD NAVIGATION FUNCTIONS =================
function openCardManagement() {
  document.getElementById('dashboardMenu').style.display = 'none';
  document.getElementById('cardsManagementSection').style.display = 'block';
  initializeDashboard();
}

function openSystemSettings() {
  document.getElementById('dashboardMenu').style.display = 'none';
  document.getElementById('systemSettingsSection').style.display = 'block';
  showTemporaryMessage('System Settings - Coming Soon!', 'info');
}

function openAnalytics() {
  document.getElementById('dashboardMenu').style.display = 'none';
  document.getElementById('analyticsSection').style.display = 'block';
  showTemporaryMessage('Analytics - Coming Soon!', 'info');
}

function openFileManager() {
  document.getElementById('dashboardMenu').style.display = 'none';
  document.getElementById('fileManagerSection').style.display = 'block';
  showTemporaryMessage('File Manager - Coming Soon!', 'info');
}

function backToDashboard() {
  document.querySelectorAll('.admin-management-section').forEach(section => {
    section.style.display = 'none';
  });

  document.getElementById('dashboardMenu').style.display = 'block';

  resetCardForm();
  resetImageForm();
}

// ================= EXISTING FUNCTIONALITY =================
const images = [
  "time_table.jpg",
  "modure_summery.jpg"
];

const altTexts = [
  "University Timetable",
  "Module Summary Points"
];

const imageSlider = document.getElementById('imageSlider');
const toggleBtn = document.querySelector('.toggle-slider-btn');
const mainContent = document.querySelector('main');

function toggleImageSlider() {
  const isOpen = imageSlider.classList.contains('open');
  
  if (isOpen) {
    imageSlider.classList.remove('open');
    mainContent.classList.remove('slider-open');
    toggleBtn.classList.remove('up');
    toggleBtn.classList.add('down');
  } else {
    imageSlider.classList.add('open');
    mainContent.classList.add('slider-open');
    toggleBtn.classList.remove('down');
    toggleBtn.classList.add('up');
  }
}

// Menu functionality
function toggleMenu(){
  const m=document.getElementById('menu');
  m.style.display=m.style.display==='flex'?'none':'flex';
}

// Modal functionality
let currentFileName = '';

function showModal(fileName) {
  currentFileName = fileName;
  const modal = document.getElementById('fileModal');
  const modalMessage = document.getElementById('modalMessage');
  modalMessage.textContent = `Do you want to see the "${fileName}" content and download it?`;
  modal.classList.add('active');
}

function closeModal() {
  const modal = document.getElementById('fileModal');
  modal.classList.remove('active');
  currentFileName = '';
}

function downloadFile() {
  if (currentFileName) {
    alert(`Downloading "${currentFileName}"...`);
    
    const link = document.createElement('a');
    link.href = '#';
    link.download = currentFileName.toLowerCase().replace(/\s+/g, '_') + '.txt';
    link.click();
    
    closeModal();
  }
}

// Close modal when clicking outside
document.getElementById('fileModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeModal();
  }
});

document.getElementById('adminModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeAdminModal();
  }
});

document.getElementById('deleteModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeDeleteModal();
  }
});

document.getElementById('sliderFilterPanel').addEventListener('click', function(e) {
  e.stopPropagation();
});

// User Management Modals close handlers
document.getElementById('addUserModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeAddUserModal();
  }
});

document.getElementById('editUserModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeEditUserModal();
  }
});

document.getElementById('caseModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeCaseModal();
  }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeModal();
    closeAdminModal();
    closeDeleteModal();
    closeAddUserModal();
    closeEditUserModal();
    closeCaseModal();
    document.getElementById('sliderFilterPanel').classList.remove('show');
  }
});

const container=document.getElementById('cards');

function buildCardElement(p){
  const c = document.createElement('div');
  c.className = 'card';
  
  // Use Supabase field names OR fallback to old names
  const startDate = new Date(p.start_time || p.start);
  const endDate = new Date(p.end_time || p.end);
  const fileUrl = p.file_url || p.fileUrl;
  
  const formatTime24 = (date) => {
    if (!date || isNaN(date.getTime())) {
      return '00:00';
    }
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
  };
  
  const formatDate = (date) => {
    if (!date || isNaN(date.getTime())) {
      return '0000-00-00';
    }
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };
  
  c.innerHTML = `
    <div class="spinner">
      <div class="ring"></div>
      <div class="ring"></div>
      <div class="ring"></div>
    </div>
    <h3>${p.title}</h3>
    <div class="meta" data-filename="${p.description}" data-url="${fileUrl || '#'}">${p.description}</div>

    <div class="countdown-container">
      <div class="countdown">
        <div class="pill"><b class="d">0</b>Days</div>
        <div class="pill"><b class="h">0</b>Hrs</div>
        <div class="pill"><b class="m">0</b>Min</div>
        <span class="left-label">left</span>
      </div>
    </div>

    <div class="progress"><div class="bar"></div></div>

    <div class="card-footer">
      <div class="badge-container">
        <span class="badge started">Started: ${formatDate(startDate)} ${formatTime24(startDate)}</span>
        <span class="badge ends">Ends: ${formatDate(endDate)} ${formatTime24(endDate)}</span>
      </div>
      <span class="status">Active</span>
    </div>
  `;
  
  const meta = c.querySelector('.meta');
  meta.addEventListener('click', function() {
    const fileUrl = this.getAttribute('data-url');
    if (fileUrl && fileUrl !== '#') {
      window.open(fileUrl, '_blank');
    } else {
      showModal(this.textContent);
    }
  });
  
  container.appendChild(c);
  return c;
}

let cards = [];
let lastCardCount = 0;

function update(){
  let displayedCards;
  try {
    const savedCards = localStorage.getItem('ring0_admin_cards');
    displayedCards = savedCards ? JSON.parse(savedCards) : allPosts;
  } catch (e) {
    displayedCards = allPosts;
  }

  const activeCards = displayedCards.filter(card => card.status === 'active');

  const currentCardCount = activeCards.length;
  const cardsChanged = currentCardCount !== lastCardCount ||
    cards.length === 0 ||
    cards.some((card, index) => card.post.id !== activeCards[index]?.id);

  if (cardsChanged) {
    container.innerHTML = '';

    cards = activeCards.map(p => ({post:p, el:buildCardElement(p)}));
    lastCardCount = currentCardCount;
  }

  if (cards.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: var(--muted); font-size: 0.9rem;">
        No active countdown cards. Cards created in admin panel will appear here.
      </div>
    `;
    return;
  }

  const now = new Date();
  cards.forEach(({post, el}) => {
    // Use Supabase field names OR fallback to old names
    const start = new Date(post.start_time || post.start);
    const end = new Date(post.end_time || post.end);
    
    // Check if dates are valid
    if (isNaN(start.getTime()) || isNaN(end.getTime())) {
      console.warn('Invalid date for card:', post.id, post.title);
      return;
    }
    
    const maximumPeriodMs = end - start;
    const maximumPeriodSeconds = maximumPeriodMs / 1000;
    
    const remainingMs = end - now;
    const remainingSeconds = Math.max(0, remainingMs / 1000);
    
    let progressPercent;
    if (remainingMs <= 0) {
      progressPercent = 100;
    } else if (now < start) {
      progressPercent = 0;
    } else {
      progressPercent = (remainingSeconds / maximumPeriodSeconds) * 100;
    }
    
    progressPercent = Math.min(100, Math.max(0, progressPercent));
    
    const progressBarWidth = progressPercent;
    
    const bar = el.querySelector('.bar');
    const status = el.querySelector('.status');
    const spinner = el.querySelector('.spinner');
    const daysLeft = Math.floor(remainingMs / (1000 * 60 * 60 * 24));

    el.querySelector('.d').textContent = Math.max(0, daysLeft);
    el.querySelector('.h').textContent = Math.max(0, Math.floor((remainingMs / (1000 * 60 * 60)) % 24));
    el.querySelector('.m').textContent = Math.max(0, Math.floor((remainingMs / (1000 * 60)) % 60));

    bar.style.width = progressBarWidth + '%';

    bar.setAttribute('data-percent', Math.round(progressBarWidth) + '%');

    if (remainingMs <= 0) {
      status.textContent = 'Completed';
      bar.style.width = '0%';
      bar.setAttribute('data-percent', '0%');
      spinner.style.display = 'none';
      el.querySelectorAll('.pill b').forEach(b => b.textContent = 0);
      bar.classList.remove('active', 'critical');
      return;
    }

    if (now < start) {
      status.textContent = 'Not Started';
      bar.style.width = '100%';
      bar.setAttribute('data-percent', '100%');
      bar.classList.remove('active', 'critical');
      return;
    }

    bar.classList.add('active');

    if (daysLeft <= 2) {
      bar.classList.add('critical');
      status.textContent = 'Critical';
      status.style.color = '#ff6b6b';
    } else {
      bar.classList.remove('critical');
      status.textContent = 'Active';
      status.style.color = '';
    }
  });
}

function initializePage() {
  // Initialize Supabase system first
  initSupabaseSystem();

  loadCardsFromStorage();

  const activeCards = allPosts.filter(card => card.status === 'active');
  cards = activeCards.map(p => ({post:p, el:buildCardElement(p)}));

  loadImagesFromStorage();
  loadSliderSettings();
  updateSliderImages();
  updateSliderIndicators();

  // Load user management data
  loadDataFramework();
  loadUserData();
  loadGroups();
  updateRegistrationSwitch();

  // Initialize enhanced features
  updateRegistrationSettingsUI();
  updateMainMenu();
  
  // Initialize real-time user management sync system
  initUserManagementSystem();

  update();
  setInterval(update,1000);

  // Ensure no auto-advance runs automatically on page load; user must enable via settings.
  if (autoAdvanceInterval) {
    clearInterval(autoAdvanceInterval);
    autoAdvanceInterval = null;
  }

  // Check registration visibility on load
  const isRegistrationEnabled = localStorage.getItem('ring0_registration_enabled') !== 'false';
  const menuButtons = document.querySelectorAll('nav button');
  const memberSignUpBtn = menuButtons[menuButtons.length - 1]; // Last button is "member sign up"

  if (memberSignUpBtn && memberSignUpBtn.textContent.toLowerCase().includes('member')) {
    if (!isRegistrationEnabled) {
      memberSignUpBtn.style.display = 'none';
    }
  }
}

document.addEventListener('DOMContentLoaded', function() {
  initializePage();
  
  const existingImages = document.querySelectorAll('.indicator-dot');
  if (existingImages.length === 2) {
    updateImageSlider();
  }
});

window.addEventListener('storage', function(e) {
  if (e.key === 'ring0_admin_cards') {
    loadCardsFromStorage();
    update();
  }
  if (e.key === 'ring0_slider_images') {
    loadImagesFromStorage();
    updateSliderImages();
  }
  if (e.key === 'ring0_registration_enabled') {
    const isEnabled = localStorage.getItem('ring0_registration_enabled') !== 'false';
    const menuButtons = document.querySelectorAll('nav button');
    const memberSignUpBtn = menuButtons[menuButtons.length - 1];
    
    if (memberSignUpBtn && memberSignUpBtn.textContent.toLowerCase().includes('member')) {
      if (isEnabled) {
        memberSignUpBtn.style.display = 'block';
      } else {
        memberSignUpBtn.style.display = 'none';
      }
    }
  }
});

// Clean up expired images periodically
setInterval(function() {
  const now = new Date();
  const expiredImages = allImages.filter(img => 
    img.expiresAt && new Date(img.expiresAt) < now && img.status === 'active'
  );
  
  if (expiredImages.length > 0) {
    expiredImages.forEach(img => {
      img.status = 'expired';
    });
    saveImagesToStorage();
    updateSliderImages();
  }
}, 60000);

// Close menu when clicking outside
document.addEventListener('click', function(event) {
  const menu = document.getElementById('menu');
  const menuBtn = document.querySelector('.menu-btn');
  if (menu.style.display === 'flex' &&
      !menu.contains(event.target) &&
      !menuBtn.contains(event.target)) {
    menu.style.display = 'none';
  }
  
  const filterPanel = document.getElementById('sliderFilterPanel');
  const filterIcon = document.querySelector('.filter-icon');
  
  if (filterPanel.classList.contains('show') && 
      !filterPanel.contains(event.target) && 
      !filterIcon.contains(event.target)) {
    filterPanel.classList.remove('show');
  }
});
</script>

<!-- flatpickr init -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  if (typeof flatpickr === 'undefined') return;

  const makeISO = (d) => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    return `${y}-${m}-${day}T${hh}:${mm}`;
  };

  const optsDateTime = {
    enableTime: true,
    time_24hr: true,
    minuteIncrement: 1,
    dateFormat: "Y-m-d\\TH:i",
    allowInput: true,
    onClose(selectedDates, dateStr, instance) {
      if (selectedDates && selectedDates.length) {
        instance._input.value = makeISO(selectedDates[0]);
      }
    }
  };

  const optsTimeOnly = {
    noCalendar: true,
    enableTime: true,
    time_24hr: true,
    minuteIncrement: 1,
    dateFormat: "H:i",
    allowInput: true,
    onClose(selectedDates, dateStr, instance) {
      if (selectedDates && selectedDates.length) {
        const d = selectedDates[0];
        instance._input.value = String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
      }
    }
  };

  const startEl = document.getElementById('cardStartTime');
  if (startEl && startEl.tagName.toLowerCase() === 'input' && startEl.type === 'text') {
    flatpickr('#cardStartTime', optsDateTime);
  }
  const endEl = document.getElementById('cardEndTime');
  if (endEl && endEl.tagName.toLowerCase() === 'input' && endEl.type === 'text') {
    flatpickr('#cardEndTime', optsTimeOnly);
  }
  
  const imageEndDateEl = document.getElementById('imageEndDate');
  if (imageEndDateEl) {
    flatpickr('#imageEndDate', {
      dateFormat: "Y-m-d",
      allowInput: true
    });
  }
});

// ðŸ©º SIMPLE SYNC HEALTH CHECKER
// Runs every minute to prevent state drift
let lastSyncTime = Date.now();

function startSyncHealthCheck() {
  setInterval(async () => {
    try {
      // Quick check: Fetch just one card from Supabase
      const { data: freshCard, error } = await supabaseClient
        .from('countdown_cards')
        .select('id, updated_at')
        .order('updated_at', { ascending: false })
        .limit(1)
        .single();
      
      if (!error && freshCard) {
        // If our local data is older than 5 minutes, refresh
        const localCard = allPosts[0];
        if (localCard && localCard.updated_at) {
          const localTime = new Date(localCard.updated_at).getTime();
          const freshTime = new Date(freshCard.updated_at).getTime();
          
          if (freshTime > localTime + 300000) { // 5 minute drift
            console.log('ðŸ”„ Sync drift detected, refreshing...');
            await fetchInitialData();
            showTemporaryMessage('Data refreshed from server', 'info');
          }
        }
      }
    } catch (error) {
      // Silent fail - it's just a health check
    }
  }, 60000); // Check every minute
}

// Start the health checker when page loads
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(startSyncHealthCheck, 10000); // Start after 10 seconds
});
</script>

</body>
</html>
